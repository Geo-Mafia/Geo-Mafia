import { Inject, Injectable, Optional } from '@angular/core';
import { LocationStrategy } from '@angular/common';
import { DefaultUrlSerializer } from '@angular/router';
import { NativeScriptDebug } from '../../trace';
import { isPresent } from '../../utils/lang-facade';
import { FrameService } from '../frame.service';
import { Outlet, defaultNavOptions } from './ns-location-utils';
import { START_PATH } from '../../tokens';
import * as i0 from "@angular/core";
import * as i1 from "../frame.service";
export class NSLocationStrategy extends LocationStrategy {
    constructor(frameService, startPath) {
        super();
        this.frameService = frameService;
        this.startPath = startPath;
        this.outlets = [];
        this.popStateCallbacks = new Array();
        this._modalNavigationDepth = 0;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.constructor()');
        }
    }
    getState() {
        return this.currentOutlet && this.currentOutlet.peekState();
    }
    path() {
        if (!this.currentUrlTree) {
            return this.startPath || '/';
        }
        const state = this.currentOutlet && this.currentOutlet.peekState();
        if (!state) {
            return '/';
        }
        let tree = this.currentUrlTree;
        let changedOutlet = this.getSegmentGroupByOutlet(this.currentOutlet);
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (state.isRootSegmentGroup) {
            tree.root = state.segmentGroup;
        }
        else if (changedOutlet) {
            this.updateSegmentGroup(tree.root, changedOutlet, state.segmentGroup);
        }
        const urlSerializer = new DefaultUrlSerializer();
        tree.queryParams = state.queryParams;
        const url = urlSerializer.serialize(tree);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.path(): ' + url);
        }
        return url;
    }
    prepareExternalUrl(internal) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.prepareExternalUrl() internal: ' + internal);
        }
        return internal;
    }
    pushState(state, title, url, queryParams) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.pushState state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
        }
        this.pushStateInternal(state, title, url, queryParams);
    }
    pushStateInternal(state, title, url, queryParams, replace = false) {
        const urlSerializer = new DefaultUrlSerializer();
        this.currentUrlTree = urlSerializer.parse(url);
        const urlTreeRoot = this.currentUrlTree.root;
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (!Object.keys(urlTreeRoot.children).length) {
            const segmentGroup = this.currentUrlTree && this.currentUrlTree.root;
            const outletKey = this.getOutletKey(this.getSegmentGroupFullPath(segmentGroup), 'primary');
            const outlet = this.findOutlet(outletKey);
            if (outlet && this.updateStates(outlet, segmentGroup, this.currentUrlTree.queryParams, replace)) {
                this.currentOutlet = outlet; // If states updated
            }
            else if (!outlet) {
                // tslint:disable-next-line:max-line-length
                const rootOutlet = this.createOutlet('primary', null, segmentGroup, null, null, this.currentUrlTree.queryParams);
                this.currentOutlet = rootOutlet;
            }
            this.currentOutlet.peekState().isRootSegmentGroup = true;
            return;
        }
        const queue = [];
        let currentTree = urlTreeRoot;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                const currentSegmentGroup = currentTree.children[outletName];
                currentSegmentGroup.outlet = outletName;
                currentSegmentGroup.root = urlTreeRoot;
                const outletPath = this.getSegmentGroupFullPath(currentTree);
                let outletKey = this.getOutletKey(outletPath, outletName);
                let outlet = this.findOutlet(outletKey);
                const parentOutletName = currentTree.outlet || '';
                const parentOutletPath = this.getSegmentGroupFullPath(currentTree.parent);
                const parentOutletKey = this.getOutletKey(parentOutletPath, parentOutletName);
                const parentOutlet = this.findOutlet(parentOutletKey);
                const containsLastState = outlet && outlet.containsTopState(currentSegmentGroup.toString());
                if (!outlet) {
                    // tslint:disable-next-line:max-line-length
                    outlet = this.createOutlet(outletKey, outletPath, currentSegmentGroup, parentOutlet, this._modalNavigationDepth, this.currentUrlTree.queryParams);
                    this.currentOutlet = outlet;
                }
                else if (this._modalNavigationDepth > 0 && outlet.showingModal && !containsLastState) {
                    // Navigation inside modal view.
                    this.upsertModalOutlet(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace);
                }
                else {
                    outlet.parent = parentOutlet;
                    if (this.updateStates(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace)) {
                        this.currentOutlet = outlet; // If states updated
                    }
                }
                queue.push(currentSegmentGroup);
            });
            currentTree = queue.shift();
        }
    }
    replaceState(state, title, url, queryParams) {
        const states = this.currentOutlet && this.currentOutlet.states;
        if (states && states.length > 0) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState changing existing state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams, true);
        }
        else {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState pushing new state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams);
        }
    }
    forward() {
        throw new Error('NSLocationStrategy.forward() - not implemented');
    }
    back(outlet, frame) {
        this.currentOutlet = outlet || this.currentOutlet;
        if (this.currentOutlet.isPageNavigationBack) {
            const states = this.currentOutlet.states;
            // We are navigating to the previous page
            // clear the stack until we get to a page navigation state
            let state = states.pop();
            let count = 1;
            if (frame) {
                while (state.frame && state.frame !== frame) {
                    state = states.pop();
                    count++;
                }
            }
            while (!state.isPageNavigation) {
                state = states.pop();
                count++;
            }
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog(`NSLocationStrategy.back() while navigating back. States popped: ${count}`);
            }
            this.callPopState(state, true);
        }
        else {
            let state = this.currentOutlet.peekState();
            if (state && state.isPageNavigation) {
                // This was a page navigation - so navigate through frame.
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is page - will call frame.goBack()');
                }
                if (!outlet) {
                    const topmostFrame = this.frameService.getFrame();
                    this.currentOutlet = this.getOutletByFrame(topmostFrame) || this.currentOutlet;
                }
                const frameToBack = this.currentOutlet.getFrameToBack();
                if (frameToBack) {
                    frameToBack.goBack();
                }
            }
            else {
                // Nested navigation - just pop the state
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is not page - just pop');
                }
                this.callPopState(this.currentOutlet.states.pop(), true);
            }
        }
    }
    canGoBack(outlet) {
        outlet = outlet || this.currentOutlet;
        return outlet.states.length > 1;
    }
    onPopState(fn) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.onPopState');
        }
        this.popStateCallbacks.push(fn);
    }
    getBaseHref() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.getBaseHref()');
        }
        return '';
    }
    callPopState(state, pop = true, outlet) {
        outlet = outlet || this.currentOutlet;
        const urlSerializer = new DefaultUrlSerializer();
        let changedOutlet = this.getSegmentGroupByOutlet(outlet);
        if (state && changedOutlet) {
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, state.segmentGroup);
        }
        else if (changedOutlet) {
            // when closing modal view there are scenarios (e.g. root viewContainerRef) when we need
            // to clean up the named page router outlet to make sure we will open the modal properly again if needed.
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, null);
        }
        const url = urlSerializer.serialize(this.currentUrlTree);
        const change = { state, type: 'popstate' };
        for (let fn of this.popStateCallbacks) {
            fn(change);
        }
    }
    toString() {
        let result = [];
        this.outlets.forEach((outlet) => {
            const outletStates = outlet.states;
            const outletLog = outletStates
                // tslint:disable-next-line:max-line-length
                .map((v, i) => `${outlet.outletKeys}.${i}.[${v.isPageNavigation ? 'PAGE' : 'INTERNAL'}].[${outlet.modalNavigationDepth ? 'MODAL' : 'BASE'}] "${v.segmentGroup.toString()}"`)
                .reverse();
            result = result.concat(outletLog);
        });
        return result.join('\n');
    }
    // Methods for syncing with page navigation in PageRouterOutlet
    _beginBackPageNavigation(frame, outletKey) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call startGoBack while going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.startGoBack()');
        }
        outlet.setOutletKeyNavigatingBack(outletKey);
        // outlet.isPageNavigationBack = true;
        // we find all the children and also set their isPageNavigationBack
        this.outlets
            .filter((o) => {
            let parent = o.parent;
            while (parent) {
                if (parent === outlet) {
                    return true;
                }
                parent = parent.parent;
            }
            return false;
        })
            .forEach((o) => (o.isPageNavigationBack = true));
        this.currentOutlet = outlet;
    }
    _finishBackPageNavigation(frame) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || !outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call endGoBack while not going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.finishBackPageNavigation()');
        }
        outlet.isPageNavigationBack = false;
    }
    _beginModalNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginModalNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        // It is possible to have frame, but not corresponding Outlet, if
        // showing modal dialog on app.component.ts ngOnInit() e.g. In that case
        // the modal is treated as none modal navigation.
        if (this.currentOutlet) {
            this.currentOutlet.showingModal = true;
            this._modalNavigationDepth++;
        }
    }
    _closeModalNavigation() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.closeModalNavigation()');
        }
        const isShowingModal = this._modalNavigationDepth > 0;
        if (isShowingModal) {
            this._modalNavigationDepth--;
        }
        // currentOutlet should be the one that corresponds to the topmost frame
        const topmostOutlet = this.getOutletByFrame(this.frameService.getFrame());
        const outlet = this.findOutletByModal(this._modalNavigationDepth, isShowingModal) || topmostOutlet;
        if (outlet) {
            this.currentOutlet = outlet;
            this.currentOutlet.showingModal = false;
            this.callPopState(this.currentOutlet.peekState(), false);
            // this is needed because angular does a setTimeout on onPopState, so if we don't do this we might end up with inconsistent state
            return new Promise((resolve) => setTimeout(resolve, 0));
        }
    }
    _beginPageNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        const lastState = this.currentOutlet.peekState();
        if (lastState) {
            lastState.isPageNavigation = true;
        }
        const navOptions = this._currentNavigationOptions || defaultNavOptions;
        if (navOptions.clearHistory) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation clearing states history');
            }
            this.currentOutlet.states = [lastState];
        }
        this._currentNavigationOptions = undefined;
        return navOptions;
    }
    _setNavigationOptions(options) {
        this._currentNavigationOptions = {
            clearHistory: isPresent(options.clearHistory) ? options.clearHistory : false,
            animated: isPresent(options.animated) ? options.animated : true,
            transition: options.transition,
            replaceUrl: options.replaceUrl,
        };
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._setNavigationOptions(' + `${JSON.stringify(this._currentNavigationOptions)})`);
        }
    }
    _getOutlets() {
        return this.outlets;
    }
    updateOutletFrame(outlet, frame, isEmptyOutletFrame) {
        const lastState = outlet.peekState();
        if (lastState && !lastState.frame && !isEmptyOutletFrame) {
            lastState.frame = frame;
        }
        if (!outlet.containsFrame(frame)) {
            outlet.frames.push(frame);
        }
        this.currentOutlet = outlet;
    }
    clearOutlet(frame) {
        this.outlets = this.outlets.filter((currentOutlet) => {
            let isEqualToCurrent;
            if (this.currentOutlet) {
                isEqualToCurrent = currentOutlet.pathByOutlets === this.currentOutlet.pathByOutlets;
            }
            // Remove outlet from the url tree.
            if (currentOutlet.containsFrame(frame) && !isEqualToCurrent) {
                this.callPopState(null, true, currentOutlet);
            }
            // Skip frames filtering since currentOutlet is <router-outlet> when no frames available.
            if (currentOutlet.frames.length && !currentOutlet.isNSEmptyOutlet) {
                currentOutlet.frames = currentOutlet.frames.filter((currentFrame) => currentFrame !== frame);
                return currentOutlet.frames.length;
            }
            return !currentOutlet.containsFrame(frame);
        });
    }
    getSegmentGroupFullPath(segmentGroup) {
        let fullPath = '';
        while (segmentGroup) {
            const url = segmentGroup.toString();
            if (fullPath) {
                fullPath = (url ? url + '/' : '') + fullPath;
            }
            else {
                fullPath = url;
            }
            segmentGroup = segmentGroup.parent;
        }
        return fullPath;
    }
    getRouteFullPath(currentRoute) {
        const outletName = currentRoute.outlet;
        let fullPath;
        currentRoute = currentRoute.parent;
        while (currentRoute) {
            const urls = currentRoute.url.value || currentRoute.url;
            let url = urls;
            if (Array.isArray(urls)) {
                url = url.join('/');
            }
            fullPath = fullPath ? (url ? url + '/' : url) + fullPath : url;
            currentRoute = currentRoute.parent;
        }
        return fullPath ? fullPath + '-' + outletName : outletName;
    }
    getPathByOutlets(urlSegmentGroup) {
        if (!urlSegmentGroup) {
            return '';
        }
        let pathToOutlet;
        let lastPath = urlSegmentGroup.outlet || 'primary';
        let parent = urlSegmentGroup.parent;
        while (parent && urlSegmentGroup.root !== parent) {
            if (parent && parent.outlet !== lastPath) {
                if (lastPath === 'primary') {
                    lastPath = parent.outlet;
                }
                else {
                    lastPath = parent.outlet;
                    pathToOutlet = lastPath + '-' + (pathToOutlet || urlSegmentGroup.outlet);
                }
            }
            parent = parent.parent;
        }
        return pathToOutlet || lastPath;
    }
    findOutlet(outletKey, activatedRouteSnapshot) {
        let outlet = this.outlets.find((currentOutlet) => {
            let equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
            return equalModalDepth && currentOutlet.outletKeys.indexOf(outletKey) > -1;
        });
        // No Outlet with the given outletKey could happen when using nested unnamed p-r-o
        // primary -> primary -> prymary
        if (!outlet && activatedRouteSnapshot) {
            const pathByOutlets = this.getPathByOutlets(activatedRouteSnapshot);
            outlet = this.outlets.find((currentOutlet) => {
                let equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
                return equalModalDepth && currentOutlet.pathByOutlets === pathByOutlets;
            });
        }
        return outlet;
    }
    findOutletByModal(modalNavigation, isShowingModal) {
        return this.outlets.find((outlet) => {
            let equalModalDepth = outlet.modalNavigationDepth === modalNavigation;
            return isShowingModal ? equalModalDepth && outlet.showingModal : equalModalDepth;
        });
    }
    getOutletByFrame(frame) {
        let outlet;
        for (let index = 0; index < this.outlets.length; index++) {
            const currentOutlet = this.outlets[index];
            if (currentOutlet.containsFrame(frame)) {
                outlet = currentOutlet;
                break;
            }
        }
        return outlet;
    }
    updateStates(outlet, currentSegmentGroup, queryParams, replace = false) {
        const isNewPage = outlet.states.length === 0;
        const lastState = outlet.states[outlet.states.length - 1];
        const equalStateUrls = outlet.containsTopState(currentSegmentGroup.toString());
        const locationState = {
            segmentGroup: currentSegmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: isNewPage,
            queryParams: { ...queryParams },
        };
        if (!lastState || !equalStateUrls) {
            if (replace) {
                outlet.states.pop();
            }
            outlet.states.push(locationState);
            // Update last state segmentGroup of parent Outlet.
            if (this._modalNavigationDepth === 0 && !outlet.showingModal) {
                this.updateParentsStates(outlet, currentSegmentGroup.parent);
            }
            return true;
        }
        else {
            if (lastState && equalStateUrls) {
                // update query params for last state
                lastState.queryParams = { ...queryParams };
            }
        }
        return false;
    }
    updateParentsStates(outlet, newSegmentGroup) {
        let parentOutlet = outlet.parent;
        // Update parents lastState segmentGroups
        while (parentOutlet && newSegmentGroup) {
            const state = parentOutlet.peekState();
            if (state) {
                state.segmentGroup = newSegmentGroup;
                newSegmentGroup = newSegmentGroup.parent;
                parentOutlet = parentOutlet.parent;
            }
        }
    }
    // tslint:disable-next-line:max-line-length
    createOutlet(outletKey, path, segmentGroup, parent, modalNavigation, queryParams = {}) {
        const pathByOutlets = this.getPathByOutlets(segmentGroup);
        const newOutlet = new Outlet(outletKey, path, pathByOutlets, modalNavigation);
        const locationState = {
            segmentGroup: segmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: true,
            queryParams: { ...queryParams },
        };
        newOutlet.states = [locationState];
        newOutlet.parent = parent;
        this.outlets.push(newOutlet);
        // Update last state segmentGroup of parent Outlet.
        if (this._modalNavigationDepth === 0 && !newOutlet.showingModal) {
            this.updateParentsStates(newOutlet, segmentGroup.parent);
        }
        return newOutlet;
    }
    getSegmentGroupByOutlet(outlet) {
        const pathList = outlet.pathByOutlets.split('-');
        let segmentGroup = this.currentUrlTree.root;
        let pathToOutlet;
        for (let index = 0; index < pathList.length; index++) {
            const currentPath = pathList[index];
            const childrenCount = Object.keys(segmentGroup.children).length;
            if (childrenCount && segmentGroup.children[currentPath]) {
                const url = segmentGroup.toString();
                pathToOutlet = pathToOutlet ? pathToOutlet + '/' + url : url;
                segmentGroup = segmentGroup.children[currentPath];
            }
            else {
                // If no child outlet found with the given name - forget about all previously found outlets.
                // example: seaching for 'primary-second-primary' shouldn't return 'primary-second'
                // if no 'primary' child available on 'second'.
                segmentGroup = null;
                break;
            }
        }
        // Paths should also match since there could be another Outlet
        // with the same pathByOutlets but different url path.
        if (segmentGroup && outlet.path && pathToOutlet && outlet.path !== pathToOutlet) {
            segmentGroup = null;
        }
        return segmentGroup;
    }
    // Traversal and replacement of segmentGroup.
    updateSegmentGroup(rootNode, oldSegmentGroup, newSegmentGroup) {
        const queue = [];
        let currentTree = rootNode;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                if (currentTree.children[outletName] === oldSegmentGroup) {
                    if (newSegmentGroup) {
                        currentTree.children[outletName] = newSegmentGroup;
                    }
                    else {
                        delete currentTree.children[outletName];
                    }
                }
                queue.push(currentTree.children[outletName]);
            });
            currentTree = queue.shift();
        }
    }
    upsertModalOutlet(parentOutlet, segmentedGroup, queryParams, replace = false) {
        let currentModalOutlet = this.findOutletByModal(this._modalNavigationDepth);
        // We want to treat every p-r-o as a standalone Outlet.
        if (!currentModalOutlet) {
            if (this._modalNavigationDepth > 1) {
                // The parent of the current Outlet should be the previous opened modal (if any).
                parentOutlet = this.findOutletByModal(this._modalNavigationDepth - 1);
            }
            // No currentModalOutlet available when opening 'primary' p-r-o.
            const outletName = 'primary';
            const outletPath = parentOutlet.peekState().segmentGroup.toString();
            const outletKey = this.getOutletKey(outletPath, outletName);
            // tslint:disable-next-line:max-line-length
            currentModalOutlet = this.createOutlet(outletKey, outletPath, segmentedGroup, parentOutlet, this._modalNavigationDepth, queryParams);
            this.currentOutlet = currentModalOutlet;
        }
        else if (this.updateStates(currentModalOutlet, segmentedGroup, queryParams, replace)) {
            this.currentOutlet = currentModalOutlet; // If states updated
        }
    }
    getOutletKey(path, outletName) {
        return path ? path + '-' + outletName : outletName;
    }
    ngOnDestroy() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.ngOnDestroy()');
        }
        this.outlets = [];
        this.currentOutlet = null;
    }
}
NSLocationStrategy.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: NSLocationStrategy, deps: [{ token: i1.FrameService }, { token: START_PATH, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
NSLocationStrategy.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: NSLocationStrategy, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: NSLocationStrategy, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.FrameService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [START_PATH]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtbG9jYXRpb24tc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUF1QixnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxvQkFBb0IsRUFBNEQsTUFBTSxpQkFBaUIsQ0FBQztBQUVqSCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsTUFBTSxFQUFvQyxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7OztBQUsxQyxNQUFNLE9BQU8sa0JBQW1CLFNBQVEsZ0JBQWdCO0lBVXRELFlBQW9CLFlBQTBCLEVBQTBDLFNBQWtCO1FBQ3hHLEtBQUssRUFBRSxDQUFDO1FBRFUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBMEMsY0FBUyxHQUFULFNBQVMsQ0FBUztRQVRsRyxZQUFPLEdBQWtCLEVBQUUsQ0FBQztRQUc1QixzQkFBaUIsR0FBRyxJQUFJLEtBQUssRUFBbUIsQ0FBQztRQUlsRCwwQkFBcUIsR0FBRyxDQUFDLENBQUM7UUFJL0IsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsa0NBQWtDLENBQUMsQ0FBQztTQUNqRTtJQUNILENBQUM7SUFFRCxR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QUFZLENBQUMsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsRUFBRTtZQUN0RixJQUFJLENBQUMsYUFBYSxHQUFHLGtCQUFrQixDQUFDLENBQUMsb0JBQW9CO1NBQzlEO0lBQ0gsQ0FBQztJQUVPLFlBQVksQ0FBQyxJQUFZLEVBQUUsVUFBa0I7UUFDbkQsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7SUFDckQsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQzs7K0dBL3FCVSxrQkFBa0IsOENBVTJCLFVBQVU7bUhBVnZELGtCQUFrQixjQUZqQixNQUFNOzJGQUVQLGtCQUFrQjtrQkFIOUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQVdrRCxNQUFNOzJCQUFDLFVBQVU7OzBCQUFHLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2NhdGlvbkNoYW5nZUV2ZW50LCBMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IERlZmF1bHRVcmxTZXJpYWxpemVyLCBVcmxTZWdtZW50R3JvdXAsIFVybFRyZWUsIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBGcmFtZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IGlzUHJlc2VudCB9IGZyb20gJy4uLy4uL3V0aWxzL2xhbmctZmFjYWRlJztcbmltcG9ydCB7IEZyYW1lU2VydmljZSB9IGZyb20gJy4uL2ZyYW1lLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3V0bGV0LCBOYXZpZ2F0aW9uT3B0aW9ucywgTG9jYXRpb25TdGF0ZSwgZGVmYXVsdE5hdk9wdGlvbnMgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IFNUQVJUX1BBVEggfSBmcm9tICcuLi8uLi90b2tlbnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgTlNMb2NhdGlvblN0cmF0ZWd5IGV4dGVuZHMgTG9jYXRpb25TdHJhdGVneSB7XG4gIHByaXZhdGUgb3V0bGV0czogQXJyYXk8T3V0bGV0PiA9IFtdO1xuICBwcml2YXRlIGN1cnJlbnRPdXRsZXQ6IE91dGxldDtcblxuICBwcml2YXRlIHBvcFN0YXRlQ2FsbGJhY2tzID0gbmV3IEFycmF5PChfOiBhbnkpID0+IGFueT4oKTtcbiAgcHJpdmF0ZSBfY3VycmVudE5hdmlnYXRpb25PcHRpb25zOiBOYXZpZ2F0aW9uT3B0aW9ucztcbiAgcHJpdmF0ZSBjdXJyZW50VXJsVHJlZTogVXJsVHJlZTtcblxuICBwdWJsaWMgX21vZGFsTmF2aWdhdGlvbkRlcHRoID0gMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1lU2VydmljZTogRnJhbWVTZXJ2aWNlLCBASW5qZWN0KFNUQVJUX1BBVEgpIEBPcHRpb25hbCgpIHByaXZhdGUgc3RhcnRQYXRoPzogc3RyaW5nKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmNvbnN0cnVjdG9yKCknKTtcbiAgICB9XG4gIH1cblxuICBnZXRTdGF0ZSgpOiB1bmtub3duIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50T3V0bGV0ICYmIHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKTtcbiAgfVxuXG4gIHBhdGgoKTogc3RyaW5nIHtcbiAgICBpZiAoIXRoaXMuY3VycmVudFVybFRyZWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0YXJ0UGF0aCB8fCAnLyc7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLmN1cnJlbnRPdXRsZXQgJiYgdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuICAgIGlmICghc3RhdGUpIHtcbiAgICAgIHJldHVybiAnLyc7XG4gICAgfVxuXG4gICAgbGV0IHRyZWUgPSB0aGlzLmN1cnJlbnRVcmxUcmVlO1xuICAgIGxldCBjaGFuZ2VkT3V0bGV0ID0gdGhpcy5nZXRTZWdtZW50R3JvdXBCeU91dGxldCh0aGlzLmN1cnJlbnRPdXRsZXQpO1xuXG4gICAgLy8gSGFuZGxlIGNhc2Ugd2hlcmUgdGhlIHVzZXIgZGVjbGFyZXMgYSBjb21wb25lbnQgYXQgcGF0aCBcIi9cIi5cbiAgICAvLyBUaGUgdXJsIHNlcmlhbGl6ZXIgZG9lc24ndCBwYXJzZSB0aGlzIHVybCBhcyBoYXZpbmcgYSBwcmltYXJ5IG91dGxldC5cbiAgICBpZiAoc3RhdGUuaXNSb290U2VnbWVudEdyb3VwKSB7XG4gICAgICB0cmVlLnJvb3QgPSBzdGF0ZS5zZWdtZW50R3JvdXA7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0cmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIHN0YXRlLnNlZ21lbnRHcm91cCk7XG4gICAgfVxuXG4gICAgY29uc3QgdXJsU2VyaWFsaXplciA9IG5ldyBEZWZhdWx0VXJsU2VyaWFsaXplcigpO1xuICAgIHRyZWUucXVlcnlQYXJhbXMgPSBzdGF0ZS5xdWVyeVBhcmFtcztcbiAgICBjb25zdCB1cmwgPSB1cmxTZXJpYWxpemVyLnNlcmlhbGl6ZSh0cmVlKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnBhdGgoKTogJyArIHVybCk7XG4gICAgfVxuICAgIHJldHVybiB1cmw7XG4gIH1cblxuICBwcmVwYXJlRXh0ZXJuYWxVcmwoaW50ZXJuYWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5wcmVwYXJlRXh0ZXJuYWxVcmwoKSBpbnRlcm5hbDogJyArIGludGVybmFsKTtcbiAgICB9XG4gICAgcmV0dXJuIGludGVybmFsO1xuICB9XG5cbiAgcHVzaFN0YXRlKHN0YXRlOiBhbnksIHRpdGxlOiBzdHJpbmcsIHVybDogc3RyaW5nLCBxdWVyeVBhcmFtczogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5wdXNoU3RhdGUgc3RhdGU6ICcgKyBgJHtzdGF0ZX0sIHRpdGxlOiAke3RpdGxlfSwgdXJsOiAke3VybH0sIHF1ZXJ5UGFyYW1zOiAke3F1ZXJ5UGFyYW1zfWApO1xuICAgIH1cbiAgICB0aGlzLnB1c2hTdGF0ZUludGVybmFsKHN0YXRlLCB0aXRsZSwgdXJsLCBxdWVyeVBhcmFtcyk7XG4gIH1cblxuICBwdXNoU3RhdGVJbnRlcm5hbChzdGF0ZTogYW55LCB0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgcXVlcnlQYXJhbXM6IHN0cmluZywgcmVwbGFjZSA9IGZhbHNlKTogdm9pZCB7XG4gICAgY29uc3QgdXJsU2VyaWFsaXplciA9IG5ldyBEZWZhdWx0VXJsU2VyaWFsaXplcigpO1xuICAgIHRoaXMuY3VycmVudFVybFRyZWUgPSB1cmxTZXJpYWxpemVyLnBhcnNlKHVybCk7XG4gICAgY29uc3QgdXJsVHJlZVJvb3QgPSB0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3Q7XG5cbiAgICAvLyBIYW5kbGUgY2FzZSB3aGVyZSB0aGUgdXNlciBkZWNsYXJlcyBhIGNvbXBvbmVudCBhdCBwYXRoIFwiL1wiLlxuICAgIC8vIFRoZSB1cmwgc2VyaWFsaXplciBkb2Vzbid0IHBhcnNlIHRoaXMgdXJsIGFzIGhhdmluZyBhIHByaW1hcnkgb3V0bGV0LlxuICAgIGlmICghT2JqZWN0LmtleXModXJsVHJlZVJvb3QuY2hpbGRyZW4pLmxlbmd0aCkge1xuICAgICAgY29uc3Qgc2VnbWVudEdyb3VwID0gdGhpcy5jdXJyZW50VXJsVHJlZSAmJiB0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3Q7XG4gICAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleSh0aGlzLmdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKHNlZ21lbnRHcm91cCksICdwcmltYXJ5Jyk7XG4gICAgICBjb25zdCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXQob3V0bGV0S2V5KTtcblxuICAgICAgaWYgKG91dGxldCAmJiB0aGlzLnVwZGF0ZVN0YXRlcyhvdXRsZXQsIHNlZ21lbnRHcm91cCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcywgcmVwbGFjZSkpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0OyAvLyBJZiBzdGF0ZXMgdXBkYXRlZFxuICAgICAgfSBlbHNlIGlmICghb3V0bGV0KSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgY29uc3Qgcm9vdE91dGxldCA9IHRoaXMuY3JlYXRlT3V0bGV0KCdwcmltYXJ5JywgbnVsbCwgc2VnbWVudEdyb3VwLCBudWxsLCBudWxsLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gcm9vdE91dGxldDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpLmlzUm9vdFNlZ21lbnRHcm91cCA9IHRydWU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcXVldWUgPSBbXTtcbiAgICBsZXQgY3VycmVudFRyZWUgPSA8YW55PnVybFRyZWVSb290O1xuXG4gICAgd2hpbGUgKGN1cnJlbnRUcmVlKSB7XG4gICAgICBPYmplY3Qua2V5cyhjdXJyZW50VHJlZS5jaGlsZHJlbikuZm9yRWFjaCgob3V0bGV0TmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBjdXJyZW50U2VnbWVudEdyb3VwID0gY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV07XG4gICAgICAgIGN1cnJlbnRTZWdtZW50R3JvdXAub3V0bGV0ID0gb3V0bGV0TmFtZTtcbiAgICAgICAgY3VycmVudFNlZ21lbnRHcm91cC5yb290ID0gdXJsVHJlZVJvb3Q7XG5cbiAgICAgICAgY29uc3Qgb3V0bGV0UGF0aCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoY3VycmVudFRyZWUpO1xuICAgICAgICBsZXQgb3V0bGV0S2V5ID0gdGhpcy5nZXRPdXRsZXRLZXkob3V0bGV0UGF0aCwgb3V0bGV0TmFtZSk7XG4gICAgICAgIGxldCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXQob3V0bGV0S2V5KTtcblxuICAgICAgICBjb25zdCBwYXJlbnRPdXRsZXROYW1lID0gY3VycmVudFRyZWUub3V0bGV0IHx8ICcnO1xuICAgICAgICBjb25zdCBwYXJlbnRPdXRsZXRQYXRoID0gdGhpcy5nZXRTZWdtZW50R3JvdXBGdWxsUGF0aChjdXJyZW50VHJlZS5wYXJlbnQpO1xuICAgICAgICBjb25zdCBwYXJlbnRPdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleShwYXJlbnRPdXRsZXRQYXRoLCBwYXJlbnRPdXRsZXROYW1lKTtcbiAgICAgICAgY29uc3QgcGFyZW50T3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0KHBhcmVudE91dGxldEtleSk7XG5cbiAgICAgICAgY29uc3QgY29udGFpbnNMYXN0U3RhdGUgPSBvdXRsZXQgJiYgb3V0bGV0LmNvbnRhaW5zVG9wU3RhdGUoY3VycmVudFNlZ21lbnRHcm91cC50b1N0cmluZygpKTtcbiAgICAgICAgaWYgKCFvdXRsZXQpIHtcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgb3V0bGV0ID0gdGhpcy5jcmVhdGVPdXRsZXQob3V0bGV0S2V5LCBvdXRsZXRQYXRoLCBjdXJyZW50U2VnbWVudEdyb3VwLCBwYXJlbnRPdXRsZXQsIHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPiAwICYmIG91dGxldC5zaG93aW5nTW9kYWwgJiYgIWNvbnRhaW5zTGFzdFN0YXRlKSB7XG4gICAgICAgICAgLy8gTmF2aWdhdGlvbiBpbnNpZGUgbW9kYWwgdmlldy5cbiAgICAgICAgICB0aGlzLnVwc2VydE1vZGFsT3V0bGV0KG91dGxldCwgY3VycmVudFNlZ21lbnRHcm91cCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcywgcmVwbGFjZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0bGV0LnBhcmVudCA9IHBhcmVudE91dGxldDtcblxuICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZVN0YXRlcyhvdXRsZXQsIGN1cnJlbnRTZWdtZW50R3JvdXAsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMsIHJlcGxhY2UpKSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7IC8vIElmIHN0YXRlcyB1cGRhdGVkXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcXVldWUucHVzaChjdXJyZW50U2VnbWVudEdyb3VwKTtcbiAgICAgIH0pO1xuXG4gICAgICBjdXJyZW50VHJlZSA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgfVxuICB9XG5cbiAgcmVwbGFjZVN0YXRlKHN0YXRlOiBhbnksIHRpdGxlOiBzdHJpbmcsIHVybDogc3RyaW5nLCBxdWVyeVBhcmFtczogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdGVzID0gdGhpcy5jdXJyZW50T3V0bGV0ICYmIHRoaXMuY3VycmVudE91dGxldC5zdGF0ZXM7XG5cbiAgICBpZiAoc3RhdGVzICYmIHN0YXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucmVwbGFjZVN0YXRlIGNoYW5naW5nIGV4aXN0aW5nIHN0YXRlOiAnICsgYCR7c3RhdGV9LCB0aXRsZTogJHt0aXRsZX0sIHVybDogJHt1cmx9LCBxdWVyeVBhcmFtczogJHtxdWVyeVBhcmFtc31gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucHVzaFN0YXRlSW50ZXJuYWwoc3RhdGUsIHRpdGxlLCB1cmwsIHF1ZXJ5UGFyYW1zLCB0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnJlcGxhY2VTdGF0ZSBwdXNoaW5nIG5ldyBzdGF0ZTogJyArIGAke3N0YXRlfSwgdGl0bGU6ICR7dGl0bGV9LCB1cmw6ICR7dXJsfSwgcXVlcnlQYXJhbXM6ICR7cXVlcnlQYXJhbXN9YCk7XG4gICAgICB9XG4gICAgICB0aGlzLnB1c2hTdGF0ZUludGVybmFsKHN0YXRlLCB0aXRsZSwgdXJsLCBxdWVyeVBhcmFtcyk7XG4gICAgfVxuICB9XG5cbiAgZm9yd2FyZCgpOiB2b2lkIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05TTG9jYXRpb25TdHJhdGVneS5mb3J3YXJkKCkgLSBub3QgaW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIGJhY2sob3V0bGV0PzogT3V0bGV0LCBmcmFtZT86IEZyYW1lKTogdm9pZCB7XG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0IHx8IHRoaXMuY3VycmVudE91dGxldDtcblxuICAgIGlmICh0aGlzLmN1cnJlbnRPdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuY3VycmVudE91dGxldC5zdGF0ZXM7XG4gICAgICAvLyBXZSBhcmUgbmF2aWdhdGluZyB0byB0aGUgcHJldmlvdXMgcGFnZVxuICAgICAgLy8gY2xlYXIgdGhlIHN0YWNrIHVudGlsIHdlIGdldCB0byBhIHBhZ2UgbmF2aWdhdGlvbiBzdGF0ZVxuICAgICAgbGV0IHN0YXRlID0gc3RhdGVzLnBvcCgpO1xuICAgICAgbGV0IGNvdW50ID0gMTtcblxuICAgICAgaWYgKGZyYW1lKSB7XG4gICAgICAgIHdoaWxlIChzdGF0ZS5mcmFtZSAmJiBzdGF0ZS5mcmFtZSAhPT0gZnJhbWUpIHtcbiAgICAgICAgICBzdGF0ZSA9IHN0YXRlcy5wb3AoKTtcbiAgICAgICAgICBjb3VudCsrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHdoaWxlICghc3RhdGUuaXNQYWdlTmF2aWdhdGlvbikge1xuICAgICAgICBzdGF0ZSA9IHN0YXRlcy5wb3AoKTtcbiAgICAgICAgY291bnQrKztcbiAgICAgIH1cblxuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZyhgTlNMb2NhdGlvblN0cmF0ZWd5LmJhY2soKSB3aGlsZSBuYXZpZ2F0aW5nIGJhY2suIFN0YXRlcyBwb3BwZWQ6ICR7Y291bnR9YCk7XG4gICAgICB9XG4gICAgICB0aGlzLmNhbGxQb3BTdGF0ZShzdGF0ZSwgdHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBzdGF0ZSA9IHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKTtcbiAgICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5pc1BhZ2VOYXZpZ2F0aW9uKSB7XG4gICAgICAgIC8vIFRoaXMgd2FzIGEgcGFnZSBuYXZpZ2F0aW9uIC0gc28gbmF2aWdhdGUgdGhyb3VnaCBmcmFtZS5cbiAgICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuYmFjaygpIHdoaWxlIG5vdCBuYXZpZ2F0aW5nIGJhY2sgYnV0IHRvcCcgKyAnIHN0YXRlIGlzIHBhZ2UgLSB3aWxsIGNhbGwgZnJhbWUuZ29CYWNrKCknKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghb3V0bGV0KSB7XG4gICAgICAgICAgY29uc3QgdG9wbW9zdEZyYW1lID0gdGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUodG9wbW9zdEZyYW1lKSB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmcmFtZVRvQmFjazogRnJhbWUgPSB0aGlzLmN1cnJlbnRPdXRsZXQuZ2V0RnJhbWVUb0JhY2soKTtcbiAgICAgICAgaWYgKGZyYW1lVG9CYWNrKSB7XG4gICAgICAgICAgZnJhbWVUb0JhY2suZ29CYWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5lc3RlZCBuYXZpZ2F0aW9uIC0ganVzdCBwb3AgdGhlIHN0YXRlXG4gICAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmJhY2soKSB3aGlsZSBub3QgbmF2aWdhdGluZyBiYWNrIGJ1dCB0b3AnICsgJyBzdGF0ZSBpcyBub3QgcGFnZSAtIGp1c3QgcG9wJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNhbGxQb3BTdGF0ZSh0aGlzLmN1cnJlbnRPdXRsZXQuc3RhdGVzLnBvcCgpLCB0cnVlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjYW5Hb0JhY2sob3V0bGV0PzogT3V0bGV0KSB7XG4gICAgb3V0bGV0ID0gb3V0bGV0IHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICByZXR1cm4gb3V0bGV0LnN0YXRlcy5sZW5ndGggPiAxO1xuICB9XG5cbiAgb25Qb3BTdGF0ZShmbjogKF86IGFueSkgPT4gYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5vblBvcFN0YXRlJyk7XG4gICAgfVxuICAgIHRoaXMucG9wU3RhdGVDYWxsYmFja3MucHVzaChmbik7XG4gIH1cblxuICBnZXRCYXNlSHJlZigpOiBzdHJpbmcge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuZ2V0QmFzZUhyZWYoKScpO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBwcml2YXRlIGNhbGxQb3BTdGF0ZShzdGF0ZTogTG9jYXRpb25TdGF0ZSwgcG9wOiBib29sZWFuID0gdHJ1ZSwgb3V0bGV0PzogT3V0bGV0KSB7XG4gICAgb3V0bGV0ID0gb3V0bGV0IHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICBjb25zdCB1cmxTZXJpYWxpemVyID0gbmV3IERlZmF1bHRVcmxTZXJpYWxpemVyKCk7XG4gICAgbGV0IGNoYW5nZWRPdXRsZXQgPSB0aGlzLmdldFNlZ21lbnRHcm91cEJ5T3V0bGV0KG91dGxldCk7XG5cbiAgICBpZiAoc3RhdGUgJiYgY2hhbmdlZE91dGxldCkge1xuICAgICAgdGhpcy51cGRhdGVTZWdtZW50R3JvdXAodGhpcy5jdXJyZW50VXJsVHJlZS5yb290LCBjaGFuZ2VkT3V0bGV0LCBzdGF0ZS5zZWdtZW50R3JvdXApO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlZE91dGxldCkge1xuICAgICAgLy8gd2hlbiBjbG9zaW5nIG1vZGFsIHZpZXcgdGhlcmUgYXJlIHNjZW5hcmlvcyAoZS5nLiByb290IHZpZXdDb250YWluZXJSZWYpIHdoZW4gd2UgbmVlZFxuICAgICAgLy8gdG8gY2xlYW4gdXAgdGhlIG5hbWVkIHBhZ2Ugcm91dGVyIG91dGxldCB0byBtYWtlIHN1cmUgd2Ugd2lsbCBvcGVuIHRoZSBtb2RhbCBwcm9wZXJseSBhZ2FpbiBpZiBuZWVkZWQuXG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIG51bGwpO1xuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IHVybFNlcmlhbGl6ZXIuc2VyaWFsaXplKHRoaXMuY3VycmVudFVybFRyZWUpO1xuICAgIGNvbnN0IGNoYW5nZTogTG9jYXRpb25DaGFuZ2VFdmVudCA9IHsgc3RhdGUsIHR5cGU6ICdwb3BzdGF0ZScgfTtcbiAgICBmb3IgKGxldCBmbiBvZiB0aGlzLnBvcFN0YXRlQ2FsbGJhY2tzKSB7XG4gICAgICBmbihjaGFuZ2UpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICBsZXQgcmVzdWx0ID0gW107XG5cbiAgICB0aGlzLm91dGxldHMuZm9yRWFjaCgob3V0bGV0KSA9PiB7XG4gICAgICBjb25zdCBvdXRsZXRTdGF0ZXMgPSBvdXRsZXQuc3RhdGVzO1xuICAgICAgY29uc3Qgb3V0bGV0TG9nID0gb3V0bGV0U3RhdGVzXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgLm1hcCgodiwgaSkgPT4gYCR7b3V0bGV0Lm91dGxldEtleXN9LiR7aX0uWyR7di5pc1BhZ2VOYXZpZ2F0aW9uID8gJ1BBR0UnIDogJ0lOVEVSTkFMJ31dLlske291dGxldC5tb2RhbE5hdmlnYXRpb25EZXB0aCA/ICdNT0RBTCcgOiAnQkFTRSd9XSBcIiR7di5zZWdtZW50R3JvdXAudG9TdHJpbmcoKX1cImApXG4gICAgICAgIC5yZXZlcnNlKCk7XG5cbiAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQob3V0bGV0TG9nKTtcbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHQuam9pbignXFxuJyk7XG4gIH1cblxuICAvLyBNZXRob2RzIGZvciBzeW5jaW5nIHdpdGggcGFnZSBuYXZpZ2F0aW9uIGluIFBhZ2VSb3V0ZXJPdXRsZXRcbiAgcHVibGljIF9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbihmcmFtZTogRnJhbWUsIG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3V0bGV0OiBPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpO1xuXG4gICAgaWYgKCFvdXRsZXQgfHwgb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIHN0YXJ0R29CYWNrIHdoaWxlIGdvaW5nIGJhY2suJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5zdGFydEdvQmFjaygpJyk7XG4gICAgfVxuICAgIG91dGxldC5zZXRPdXRsZXRLZXlOYXZpZ2F0aW5nQmFjayhvdXRsZXRLZXkpO1xuICAgIC8vIG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA9IHRydWU7XG4gICAgLy8gd2UgZmluZCBhbGwgdGhlIGNoaWxkcmVuIGFuZCBhbHNvIHNldCB0aGVpciBpc1BhZ2VOYXZpZ2F0aW9uQmFja1xuICAgIHRoaXMub3V0bGV0c1xuICAgICAgLmZpbHRlcigobykgPT4ge1xuICAgICAgICBsZXQgcGFyZW50ID0gby5wYXJlbnQ7XG4gICAgICAgIHdoaWxlIChwYXJlbnQpIHtcbiAgICAgICAgICBpZiAocGFyZW50ID09PSBvdXRsZXQpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pXG4gICAgICAuZm9yRWFjaCgobykgPT4gKG8uaXNQYWdlTmF2aWdhdGlvbkJhY2sgPSB0cnVlKSk7XG5cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7XG4gIH1cblxuICBwdWJsaWMgX2ZpbmlzaEJhY2tQYWdlTmF2aWdhdGlvbihmcmFtZTogRnJhbWUpIHtcbiAgICBjb25zdCBvdXRsZXQ6IE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZShmcmFtZSk7XG5cbiAgICBpZiAoIW91dGxldCB8fCAhb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIGVuZEdvQmFjayB3aGlsZSBub3QgZ29pbmcgYmFjay4nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmZpbmlzaEJhY2tQYWdlTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuICAgIG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIF9iZWdpbk1vZGFsTmF2aWdhdGlvbihmcmFtZTogRnJhbWUpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbk1vZGFsTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKSB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG5cbiAgICAvLyBJdCBpcyBwb3NzaWJsZSB0byBoYXZlIGZyYW1lLCBidXQgbm90IGNvcnJlc3BvbmRpbmcgT3V0bGV0LCBpZlxuICAgIC8vIHNob3dpbmcgbW9kYWwgZGlhbG9nIG9uIGFwcC5jb21wb25lbnQudHMgbmdPbkluaXQoKSBlLmcuIEluIHRoYXQgY2FzZVxuICAgIC8vIHRoZSBtb2RhbCBpcyB0cmVhdGVkIGFzIG5vbmUgbW9kYWwgbmF2aWdhdGlvbi5cbiAgICBpZiAodGhpcy5jdXJyZW50T3V0bGV0KSB7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQuc2hvd2luZ01vZGFsID0gdHJ1ZTtcbiAgICAgIHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoKys7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIF9jbG9zZU1vZGFsTmF2aWdhdGlvbigpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmNsb3NlTW9kYWxOYXZpZ2F0aW9uKCknKTtcbiAgICB9XG5cbiAgICBjb25zdCBpc1Nob3dpbmdNb2RhbCA9IHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMDtcblxuICAgIGlmIChpc1Nob3dpbmdNb2RhbCkge1xuICAgICAgdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgtLTtcbiAgICB9XG5cbiAgICAvLyBjdXJyZW50T3V0bGV0IHNob3VsZCBiZSB0aGUgb25lIHRoYXQgY29ycmVzcG9uZHMgdG8gdGhlIHRvcG1vc3QgZnJhbWVcbiAgICBjb25zdCB0b3Btb3N0T3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKHRoaXMuZnJhbWVTZXJ2aWNlLmdldEZyYW1lKCkpO1xuICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5TW9kYWwodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgsIGlzU2hvd2luZ01vZGFsKSB8fCB0b3Btb3N0T3V0bGV0O1xuXG4gICAgaWYgKG91dGxldCkge1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0O1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnNob3dpbmdNb2RhbCA9IGZhbHNlO1xuICAgICAgdGhpcy5jYWxsUG9wU3RhdGUodGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpLCBmYWxzZSk7XG4gICAgICAvLyB0aGlzIGlzIG5lZWRlZCBiZWNhdXNlIGFuZ3VsYXIgZG9lcyBhIHNldFRpbWVvdXQgb24gb25Qb3BTdGF0ZSwgc28gaWYgd2UgZG9uJ3QgZG8gdGhpcyB3ZSBtaWdodCBlbmQgdXAgd2l0aCBpbmNvbnNpc3RlbnQgc3RhdGVcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAwKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIF9iZWdpblBhZ2VOYXZpZ2F0aW9uKGZyYW1lOiBGcmFtZSk6IE5hdmlnYXRpb25PcHRpb25zIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Ll9iZWdpblBhZ2VOYXZpZ2F0aW9uKCknKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpIHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICBjb25zdCBsYXN0U3RhdGUgPSB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG5cbiAgICBpZiAobGFzdFN0YXRlKSB7XG4gICAgICBsYXN0U3RhdGUuaXNQYWdlTmF2aWdhdGlvbiA9IHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgbmF2T3B0aW9ucyA9IHRoaXMuX2N1cnJlbnROYXZpZ2F0aW9uT3B0aW9ucyB8fCBkZWZhdWx0TmF2T3B0aW9ucztcbiAgICBpZiAobmF2T3B0aW9ucy5jbGVhckhpc3RvcnkpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5QYWdlTmF2aWdhdGlvbiBjbGVhcmluZyBzdGF0ZXMgaGlzdG9yeScpO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcyA9IFtsYXN0U3RhdGVdO1xuICAgIH1cblxuICAgIHRoaXMuX2N1cnJlbnROYXZpZ2F0aW9uT3B0aW9ucyA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gbmF2T3B0aW9ucztcbiAgfVxuXG4gIHB1YmxpYyBfc2V0TmF2aWdhdGlvbk9wdGlvbnMob3B0aW9uczogTmF2aWdhdGlvbk9wdGlvbnMpIHtcbiAgICB0aGlzLl9jdXJyZW50TmF2aWdhdGlvbk9wdGlvbnMgPSB7XG4gICAgICBjbGVhckhpc3Rvcnk6IGlzUHJlc2VudChvcHRpb25zLmNsZWFySGlzdG9yeSkgPyBvcHRpb25zLmNsZWFySGlzdG9yeSA6IGZhbHNlLFxuICAgICAgYW5pbWF0ZWQ6IGlzUHJlc2VudChvcHRpb25zLmFuaW1hdGVkKSA/IG9wdGlvbnMuYW5pbWF0ZWQgOiB0cnVlLFxuICAgICAgdHJhbnNpdGlvbjogb3B0aW9ucy50cmFuc2l0aW9uLFxuICAgICAgcmVwbGFjZVVybDogb3B0aW9ucy5yZXBsYWNlVXJsLFxuICAgIH07XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Ll9zZXROYXZpZ2F0aW9uT3B0aW9ucygnICsgYCR7SlNPTi5zdHJpbmdpZnkodGhpcy5fY3VycmVudE5hdmlnYXRpb25PcHRpb25zKX0pYCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIF9nZXRPdXRsZXRzKCk6IEFycmF5PE91dGxldD4ge1xuICAgIHJldHVybiB0aGlzLm91dGxldHM7XG4gIH1cblxuICB1cGRhdGVPdXRsZXRGcmFtZShvdXRsZXQ6IE91dGxldCwgZnJhbWU6IEZyYW1lLCBpc0VtcHR5T3V0bGV0RnJhbWU6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsYXN0U3RhdGUgPSBvdXRsZXQucGVla1N0YXRlKCk7XG5cbiAgICBpZiAobGFzdFN0YXRlICYmICFsYXN0U3RhdGUuZnJhbWUgJiYgIWlzRW1wdHlPdXRsZXRGcmFtZSkge1xuICAgICAgbGFzdFN0YXRlLmZyYW1lID0gZnJhbWU7XG4gICAgfVxuXG4gICAgaWYgKCFvdXRsZXQuY29udGFpbnNGcmFtZShmcmFtZSkpIHtcbiAgICAgIG91dGxldC5mcmFtZXMucHVzaChmcmFtZSk7XG4gICAgfVxuICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgfVxuXG4gIGNsZWFyT3V0bGV0KGZyYW1lOiBGcmFtZSkge1xuICAgIHRoaXMub3V0bGV0cyA9IHRoaXMub3V0bGV0cy5maWx0ZXIoKGN1cnJlbnRPdXRsZXQpID0+IHtcbiAgICAgIGxldCBpc0VxdWFsVG9DdXJyZW50O1xuXG4gICAgICBpZiAodGhpcy5jdXJyZW50T3V0bGV0KSB7XG4gICAgICAgIGlzRXF1YWxUb0N1cnJlbnQgPSBjdXJyZW50T3V0bGV0LnBhdGhCeU91dGxldHMgPT09IHRoaXMuY3VycmVudE91dGxldC5wYXRoQnlPdXRsZXRzO1xuICAgICAgfVxuXG4gICAgICAvLyBSZW1vdmUgb3V0bGV0IGZyb20gdGhlIHVybCB0cmVlLlxuICAgICAgaWYgKGN1cnJlbnRPdXRsZXQuY29udGFpbnNGcmFtZShmcmFtZSkgJiYgIWlzRXF1YWxUb0N1cnJlbnQpIHtcbiAgICAgICAgdGhpcy5jYWxsUG9wU3RhdGUobnVsbCwgdHJ1ZSwgY3VycmVudE91dGxldCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNraXAgZnJhbWVzIGZpbHRlcmluZyBzaW5jZSBjdXJyZW50T3V0bGV0IGlzIDxyb3V0ZXItb3V0bGV0PiB3aGVuIG5vIGZyYW1lcyBhdmFpbGFibGUuXG4gICAgICBpZiAoY3VycmVudE91dGxldC5mcmFtZXMubGVuZ3RoICYmICFjdXJyZW50T3V0bGV0LmlzTlNFbXB0eU91dGxldCkge1xuICAgICAgICBjdXJyZW50T3V0bGV0LmZyYW1lcyA9IGN1cnJlbnRPdXRsZXQuZnJhbWVzLmZpbHRlcigoY3VycmVudEZyYW1lKSA9PiBjdXJyZW50RnJhbWUgIT09IGZyYW1lKTtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRPdXRsZXQuZnJhbWVzLmxlbmd0aDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuICFjdXJyZW50T3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoc2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXApOiBzdHJpbmcge1xuICAgIGxldCBmdWxsUGF0aCA9ICcnO1xuXG4gICAgd2hpbGUgKHNlZ21lbnRHcm91cCkge1xuICAgICAgY29uc3QgdXJsID0gc2VnbWVudEdyb3VwLnRvU3RyaW5nKCk7XG5cbiAgICAgIGlmIChmdWxsUGF0aCkge1xuICAgICAgICBmdWxsUGF0aCA9ICh1cmwgPyB1cmwgKyAnLycgOiAnJykgKyBmdWxsUGF0aDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZ1bGxQYXRoID0gdXJsO1xuICAgICAgfVxuXG4gICAgICBzZWdtZW50R3JvdXAgPSBzZWdtZW50R3JvdXAucGFyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBmdWxsUGF0aDtcbiAgfVxuXG4gIGdldFJvdXRlRnVsbFBhdGgoY3VycmVudFJvdXRlOiBhbnkpOiBzdHJpbmcge1xuICAgIGNvbnN0IG91dGxldE5hbWUgPSBjdXJyZW50Um91dGUub3V0bGV0O1xuICAgIGxldCBmdWxsUGF0aDtcblxuICAgIGN1cnJlbnRSb3V0ZSA9IGN1cnJlbnRSb3V0ZS5wYXJlbnQ7XG4gICAgd2hpbGUgKGN1cnJlbnRSb3V0ZSkge1xuICAgICAgY29uc3QgdXJscyA9IGN1cnJlbnRSb3V0ZS51cmwudmFsdWUgfHwgY3VycmVudFJvdXRlLnVybDtcbiAgICAgIGxldCB1cmwgPSB1cmxzO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh1cmxzKSkge1xuICAgICAgICB1cmwgPSB1cmwuam9pbignLycpO1xuICAgICAgfVxuXG4gICAgICBmdWxsUGF0aCA9IGZ1bGxQYXRoID8gKHVybCA/IHVybCArICcvJyA6IHVybCkgKyBmdWxsUGF0aCA6IHVybDtcbiAgICAgIGN1cnJlbnRSb3V0ZSA9IGN1cnJlbnRSb3V0ZS5wYXJlbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bGxQYXRoID8gZnVsbFBhdGggKyAnLScgKyBvdXRsZXROYW1lIDogb3V0bGV0TmFtZTtcbiAgfVxuXG4gIGdldFBhdGhCeU91dGxldHModXJsU2VnbWVudEdyb3VwOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghdXJsU2VnbWVudEdyb3VwKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgbGV0IHBhdGhUb091dGxldDtcbiAgICBsZXQgbGFzdFBhdGggPSB1cmxTZWdtZW50R3JvdXAub3V0bGV0IHx8ICdwcmltYXJ5JztcbiAgICBsZXQgcGFyZW50ID0gdXJsU2VnbWVudEdyb3VwLnBhcmVudDtcblxuICAgIHdoaWxlIChwYXJlbnQgJiYgdXJsU2VnbWVudEdyb3VwLnJvb3QgIT09IHBhcmVudCkge1xuICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQub3V0bGV0ICE9PSBsYXN0UGF0aCkge1xuICAgICAgICBpZiAobGFzdFBhdGggPT09ICdwcmltYXJ5Jykge1xuICAgICAgICAgIGxhc3RQYXRoID0gcGFyZW50Lm91dGxldDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsYXN0UGF0aCA9IHBhcmVudC5vdXRsZXQ7XG4gICAgICAgICAgcGF0aFRvT3V0bGV0ID0gbGFzdFBhdGggKyAnLScgKyAocGF0aFRvT3V0bGV0IHx8IHVybFNlZ21lbnRHcm91cC5vdXRsZXQpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhdGhUb091dGxldCB8fCBsYXN0UGF0aDtcbiAgfVxuXG4gIGZpbmRPdXRsZXQob3V0bGV0S2V5OiBzdHJpbmcsIGFjdGl2YXRlZFJvdXRlU25hcHNob3Q/OiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogT3V0bGV0IHtcbiAgICBsZXQgb3V0bGV0OiBPdXRsZXQgPSB0aGlzLm91dGxldHMuZmluZCgoY3VycmVudE91dGxldCkgPT4ge1xuICAgICAgbGV0IGVxdWFsTW9kYWxEZXB0aCA9IGN1cnJlbnRPdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoO1xuICAgICAgcmV0dXJuIGVxdWFsTW9kYWxEZXB0aCAmJiBjdXJyZW50T3V0bGV0Lm91dGxldEtleXMuaW5kZXhPZihvdXRsZXRLZXkpID4gLTE7XG4gICAgfSk7XG5cbiAgICAvLyBObyBPdXRsZXQgd2l0aCB0aGUgZ2l2ZW4gb3V0bGV0S2V5IGNvdWxkIGhhcHBlbiB3aGVuIHVzaW5nIG5lc3RlZCB1bm5hbWVkIHAtci1vXG4gICAgLy8gcHJpbWFyeSAtPiBwcmltYXJ5IC0+IHByeW1hcnlcbiAgICBpZiAoIW91dGxldCAmJiBhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KSB7XG4gICAgICBjb25zdCBwYXRoQnlPdXRsZXRzID0gdGhpcy5nZXRQYXRoQnlPdXRsZXRzKGFjdGl2YXRlZFJvdXRlU25hcHNob3QpO1xuICAgICAgb3V0bGV0ID0gdGhpcy5vdXRsZXRzLmZpbmQoKGN1cnJlbnRPdXRsZXQpID0+IHtcbiAgICAgICAgbGV0IGVxdWFsTW9kYWxEZXB0aCA9IGN1cnJlbnRPdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoO1xuICAgICAgICByZXR1cm4gZXF1YWxNb2RhbERlcHRoICYmIGN1cnJlbnRPdXRsZXQucGF0aEJ5T3V0bGV0cyA9PT0gcGF0aEJ5T3V0bGV0cztcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBvdXRsZXQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRPdXRsZXRCeU1vZGFsKG1vZGFsTmF2aWdhdGlvbjogbnVtYmVyLCBpc1Nob3dpbmdNb2RhbD86IGJvb2xlYW4pOiBPdXRsZXQge1xuICAgIHJldHVybiB0aGlzLm91dGxldHMuZmluZCgob3V0bGV0KSA9PiB7XG4gICAgICBsZXQgZXF1YWxNb2RhbERlcHRoID0gb3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID09PSBtb2RhbE5hdmlnYXRpb247XG4gICAgICByZXR1cm4gaXNTaG93aW5nTW9kYWwgPyBlcXVhbE1vZGFsRGVwdGggJiYgb3V0bGV0LnNob3dpbmdNb2RhbCA6IGVxdWFsTW9kYWxEZXB0aDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3V0bGV0QnlGcmFtZShmcmFtZTogRnJhbWUpOiBPdXRsZXQge1xuICAgIGxldCBvdXRsZXQ7XG5cbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5vdXRsZXRzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgY3VycmVudE91dGxldCA9IHRoaXMub3V0bGV0c1tpbmRleF07XG5cbiAgICAgIGlmIChjdXJyZW50T3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpKSB7XG4gICAgICAgIG91dGxldCA9IGN1cnJlbnRPdXRsZXQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvdXRsZXQ7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0YXRlcyhvdXRsZXQ6IE91dGxldCwgY3VycmVudFNlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwLCBxdWVyeVBhcmFtczogUGFyYW1zLCByZXBsYWNlID0gZmFsc2UpOiBib29sZWFuIHtcbiAgICBjb25zdCBpc05ld1BhZ2UgPSBvdXRsZXQuc3RhdGVzLmxlbmd0aCA9PT0gMDtcbiAgICBjb25zdCBsYXN0U3RhdGUgPSBvdXRsZXQuc3RhdGVzW291dGxldC5zdGF0ZXMubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgZXF1YWxTdGF0ZVVybHMgPSBvdXRsZXQuY29udGFpbnNUb3BTdGF0ZShjdXJyZW50U2VnbWVudEdyb3VwLnRvU3RyaW5nKCkpO1xuXG4gICAgY29uc3QgbG9jYXRpb25TdGF0ZTogTG9jYXRpb25TdGF0ZSA9IHtcbiAgICAgIHNlZ21lbnRHcm91cDogY3VycmVudFNlZ21lbnRHcm91cCxcbiAgICAgIGlzUm9vdFNlZ21lbnRHcm91cDogZmFsc2UsXG4gICAgICBpc1BhZ2VOYXZpZ2F0aW9uOiBpc05ld1BhZ2UsXG4gICAgICBxdWVyeVBhcmFtczogeyAuLi5xdWVyeVBhcmFtcyB9LFxuICAgIH07XG5cbiAgICBpZiAoIWxhc3RTdGF0ZSB8fCAhZXF1YWxTdGF0ZVVybHMpIHtcbiAgICAgIGlmIChyZXBsYWNlKSB7XG4gICAgICAgIG91dGxldC5zdGF0ZXMucG9wKCk7XG4gICAgICB9XG4gICAgICBvdXRsZXQuc3RhdGVzLnB1c2gobG9jYXRpb25TdGF0ZSk7XG5cbiAgICAgIC8vIFVwZGF0ZSBsYXN0IHN0YXRlIHNlZ21lbnRHcm91cCBvZiBwYXJlbnQgT3V0bGV0LlxuICAgICAgaWYgKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID09PSAwICYmICFvdXRsZXQuc2hvd2luZ01vZGFsKSB7XG4gICAgICAgIHRoaXMudXBkYXRlUGFyZW50c1N0YXRlcyhvdXRsZXQsIGN1cnJlbnRTZWdtZW50R3JvdXAucGFyZW50KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChsYXN0U3RhdGUgJiYgZXF1YWxTdGF0ZVVybHMpIHtcbiAgICAgICAgLy8gdXBkYXRlIHF1ZXJ5IHBhcmFtcyBmb3IgbGFzdCBzdGF0ZVxuICAgICAgICBsYXN0U3RhdGUucXVlcnlQYXJhbXMgPSB7IC4uLnF1ZXJ5UGFyYW1zIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVQYXJlbnRzU3RhdGVzKG91dGxldDogT3V0bGV0LCBuZXdTZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCkge1xuICAgIGxldCBwYXJlbnRPdXRsZXQgPSBvdXRsZXQucGFyZW50O1xuXG4gICAgLy8gVXBkYXRlIHBhcmVudHMgbGFzdFN0YXRlIHNlZ21lbnRHcm91cHNcbiAgICB3aGlsZSAocGFyZW50T3V0bGV0ICYmIG5ld1NlZ21lbnRHcm91cCkge1xuICAgICAgY29uc3Qgc3RhdGUgPSBwYXJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG5cbiAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICBzdGF0ZS5zZWdtZW50R3JvdXAgPSBuZXdTZWdtZW50R3JvdXA7XG4gICAgICAgIG5ld1NlZ21lbnRHcm91cCA9IG5ld1NlZ21lbnRHcm91cC5wYXJlbnQ7XG4gICAgICAgIHBhcmVudE91dGxldCA9IHBhcmVudE91dGxldC5wYXJlbnQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICBwcml2YXRlIGNyZWF0ZU91dGxldChvdXRsZXRLZXk6IHN0cmluZywgcGF0aDogc3RyaW5nLCBzZWdtZW50R3JvdXA6IGFueSwgcGFyZW50OiBPdXRsZXQsIG1vZGFsTmF2aWdhdGlvbj86IG51bWJlciwgcXVlcnlQYXJhbXM6IFBhcmFtcyA9IHt9KTogT3V0bGV0IHtcbiAgICBjb25zdCBwYXRoQnlPdXRsZXRzID0gdGhpcy5nZXRQYXRoQnlPdXRsZXRzKHNlZ21lbnRHcm91cCk7XG4gICAgY29uc3QgbmV3T3V0bGV0ID0gbmV3IE91dGxldChvdXRsZXRLZXksIHBhdGgsIHBhdGhCeU91dGxldHMsIG1vZGFsTmF2aWdhdGlvbik7XG5cbiAgICBjb25zdCBsb2NhdGlvblN0YXRlOiBMb2NhdGlvblN0YXRlID0ge1xuICAgICAgc2VnbWVudEdyb3VwOiBzZWdtZW50R3JvdXAsXG4gICAgICBpc1Jvb3RTZWdtZW50R3JvdXA6IGZhbHNlLFxuICAgICAgaXNQYWdlTmF2aWdhdGlvbjogdHJ1ZSwgLy8gSXQgaXMgYSBuZXcgT3V0bGV0Tm9kZS5cbiAgICAgIHF1ZXJ5UGFyYW1zOiB7IC4uLnF1ZXJ5UGFyYW1zIH0sXG4gICAgfTtcblxuICAgIG5ld091dGxldC5zdGF0ZXMgPSBbbG9jYXRpb25TdGF0ZV07XG4gICAgbmV3T3V0bGV0LnBhcmVudCA9IHBhcmVudDtcbiAgICB0aGlzLm91dGxldHMucHVzaChuZXdPdXRsZXQpO1xuXG4gICAgLy8gVXBkYXRlIGxhc3Qgc3RhdGUgc2VnbWVudEdyb3VwIG9mIHBhcmVudCBPdXRsZXQuXG4gICAgaWYgKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID09PSAwICYmICFuZXdPdXRsZXQuc2hvd2luZ01vZGFsKSB7XG4gICAgICB0aGlzLnVwZGF0ZVBhcmVudHNTdGF0ZXMobmV3T3V0bGV0LCBzZWdtZW50R3JvdXAucGFyZW50KTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3T3V0bGV0O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTZWdtZW50R3JvdXBCeU91dGxldChvdXRsZXQ6IE91dGxldCk6IFVybFNlZ21lbnRHcm91cCB7XG4gICAgY29uc3QgcGF0aExpc3QgPSBvdXRsZXQucGF0aEJ5T3V0bGV0cy5zcGxpdCgnLScpO1xuICAgIGxldCBzZWdtZW50R3JvdXAgPSB0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3Q7XG4gICAgbGV0IHBhdGhUb091dGxldDtcblxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBwYXRoTGlzdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gcGF0aExpc3RbaW5kZXhdO1xuICAgICAgY29uc3QgY2hpbGRyZW5Db3VudCA9IE9iamVjdC5rZXlzKHNlZ21lbnRHcm91cC5jaGlsZHJlbikubGVuZ3RoO1xuXG4gICAgICBpZiAoY2hpbGRyZW5Db3VudCAmJiBzZWdtZW50R3JvdXAuY2hpbGRyZW5bY3VycmVudFBhdGhdKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IHNlZ21lbnRHcm91cC50b1N0cmluZygpO1xuICAgICAgICBwYXRoVG9PdXRsZXQgPSBwYXRoVG9PdXRsZXQgPyBwYXRoVG9PdXRsZXQgKyAnLycgKyB1cmwgOiB1cmw7XG4gICAgICAgIHNlZ21lbnRHcm91cCA9IHNlZ21lbnRHcm91cC5jaGlsZHJlbltjdXJyZW50UGF0aF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBJZiBubyBjaGlsZCBvdXRsZXQgZm91bmQgd2l0aCB0aGUgZ2l2ZW4gbmFtZSAtIGZvcmdldCBhYm91dCBhbGwgcHJldmlvdXNseSBmb3VuZCBvdXRsZXRzLlxuICAgICAgICAvLyBleGFtcGxlOiBzZWFjaGluZyBmb3IgJ3ByaW1hcnktc2Vjb25kLXByaW1hcnknIHNob3VsZG4ndCByZXR1cm4gJ3ByaW1hcnktc2Vjb25kJ1xuICAgICAgICAvLyBpZiBubyAncHJpbWFyeScgY2hpbGQgYXZhaWxhYmxlIG9uICdzZWNvbmQnLlxuICAgICAgICBzZWdtZW50R3JvdXAgPSBudWxsO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQYXRocyBzaG91bGQgYWxzbyBtYXRjaCBzaW5jZSB0aGVyZSBjb3VsZCBiZSBhbm90aGVyIE91dGxldFxuICAgIC8vIHdpdGggdGhlIHNhbWUgcGF0aEJ5T3V0bGV0cyBidXQgZGlmZmVyZW50IHVybCBwYXRoLlxuICAgIGlmIChzZWdtZW50R3JvdXAgJiYgb3V0bGV0LnBhdGggJiYgcGF0aFRvT3V0bGV0ICYmIG91dGxldC5wYXRoICE9PSBwYXRoVG9PdXRsZXQpIHtcbiAgICAgIHNlZ21lbnRHcm91cCA9IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlZ21lbnRHcm91cDtcbiAgfVxuXG4gIC8vIFRyYXZlcnNhbCBhbmQgcmVwbGFjZW1lbnQgb2Ygc2VnbWVudEdyb3VwLlxuICBwcml2YXRlIHVwZGF0ZVNlZ21lbnRHcm91cChyb290Tm9kZTogYW55LCBvbGRTZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCwgbmV3U2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXApIHtcbiAgICBjb25zdCBxdWV1ZSA9IFtdO1xuICAgIGxldCBjdXJyZW50VHJlZSA9IHJvb3ROb2RlO1xuXG4gICAgd2hpbGUgKGN1cnJlbnRUcmVlKSB7XG4gICAgICBPYmplY3Qua2V5cyhjdXJyZW50VHJlZS5jaGlsZHJlbikuZm9yRWFjaCgob3V0bGV0TmFtZSkgPT4ge1xuICAgICAgICBpZiAoY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV0gPT09IG9sZFNlZ21lbnRHcm91cCkge1xuICAgICAgICAgIGlmIChuZXdTZWdtZW50R3JvdXApIHtcbiAgICAgICAgICAgIGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdID0gbmV3U2VnbWVudEdyb3VwO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWxldGUgY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHF1ZXVlLnB1c2goY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV0pO1xuICAgICAgfSk7XG5cbiAgICAgIGN1cnJlbnRUcmVlID0gcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwc2VydE1vZGFsT3V0bGV0KHBhcmVudE91dGxldDogT3V0bGV0LCBzZWdtZW50ZWRHcm91cDogVXJsU2VnbWVudEdyb3VwLCBxdWVyeVBhcmFtczogUGFyYW1zLCByZXBsYWNlID0gZmFsc2UpIHtcbiAgICBsZXQgY3VycmVudE1vZGFsT3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0QnlNb2RhbCh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCk7XG5cbiAgICAvLyBXZSB3YW50IHRvIHRyZWF0IGV2ZXJ5IHAtci1vIGFzIGEgc3RhbmRhbG9uZSBPdXRsZXQuXG4gICAgaWYgKCFjdXJyZW50TW9kYWxPdXRsZXQpIHtcbiAgICAgIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDEpIHtcbiAgICAgICAgLy8gVGhlIHBhcmVudCBvZiB0aGUgY3VycmVudCBPdXRsZXQgc2hvdWxkIGJlIHRoZSBwcmV2aW91cyBvcGVuZWQgbW9kYWwgKGlmIGFueSkuXG4gICAgICAgIHBhcmVudE91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5TW9kYWwodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggLSAxKTtcbiAgICAgIH1cblxuICAgICAgLy8gTm8gY3VycmVudE1vZGFsT3V0bGV0IGF2YWlsYWJsZSB3aGVuIG9wZW5pbmcgJ3ByaW1hcnknIHAtci1vLlxuICAgICAgY29uc3Qgb3V0bGV0TmFtZSA9ICdwcmltYXJ5JztcbiAgICAgIGNvbnN0IG91dGxldFBhdGggPSBwYXJlbnRPdXRsZXQucGVla1N0YXRlKCkuc2VnbWVudEdyb3VwLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleShvdXRsZXRQYXRoLCBvdXRsZXROYW1lKTtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgIGN1cnJlbnRNb2RhbE91dGxldCA9IHRoaXMuY3JlYXRlT3V0bGV0KG91dGxldEtleSwgb3V0bGV0UGF0aCwgc2VnbWVudGVkR3JvdXAsIHBhcmVudE91dGxldCwgdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgsIHF1ZXJ5UGFyYW1zKTtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IGN1cnJlbnRNb2RhbE91dGxldDtcbiAgICB9IGVsc2UgaWYgKHRoaXMudXBkYXRlU3RhdGVzKGN1cnJlbnRNb2RhbE91dGxldCwgc2VnbWVudGVkR3JvdXAsIHF1ZXJ5UGFyYW1zLCByZXBsYWNlKSkge1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gY3VycmVudE1vZGFsT3V0bGV0OyAvLyBJZiBzdGF0ZXMgdXBkYXRlZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3V0bGV0S2V5KHBhdGg6IHN0cmluZywgb3V0bGV0TmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcGF0aCA/IHBhdGggKyAnLScgKyBvdXRsZXROYW1lIDogb3V0bGV0TmFtZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kubmdPbkRlc3Ryb3koKScpO1xuICAgIH1cblxuICAgIHRoaXMub3V0bGV0cyA9IFtdO1xuICAgIHRoaXMuY3VycmVudE91dGxldCA9IG51bGw7XG4gIH1cbn1cbiJdfQ==