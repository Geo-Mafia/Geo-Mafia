import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { NSLocationStrategy } from './ns-location-strategy';
import { FrameService } from '../frame.service';
import { NativeScriptDebug } from '../../trace';
import { findTopActivatedRouteNodeForOutlet } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "../frame.service";
export class RouterExtensions {
    constructor(router, locationStrategy, frameService) {
        this.router = router;
        this.locationStrategy = locationStrategy;
        this.frameService = frameService;
    }
    navigate(commands, extras) {
        if (extras) {
            this.locationStrategy._setNavigationOptions(extras);
        }
        return this.router.navigate(commands, extras);
    }
    navigateByUrl(url, options) {
        if (options) {
            this.locationStrategy._setNavigationOptions(options);
        }
        return this.router.navigateByUrl(url);
    }
    back(backNavigationOptions) {
        if (backNavigationOptions) {
            this.backOutlets(backNavigationOptions);
        }
        else {
            this.locationStrategy.back();
        }
    }
    canGoBack(backNavigationOptions) {
        let canGoBack = true;
        if (backNavigationOptions) {
            const { outletsToBack, outlets } = this.findOutletsToBack(backNavigationOptions);
            if (outletsToBack.length !== outlets.length) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            else {
                outletsToBack.forEach((outletToBack) => {
                    if (!this.locationStrategy.canGoBack(outletToBack)) {
                        canGoBack = false;
                    }
                });
            }
        }
        else {
            canGoBack = this.locationStrategy.canGoBack();
        }
        return canGoBack;
    }
    backToPreviousPage() {
        this.frameService.getFrame().goBack();
    }
    canGoBackToPreviousPage() {
        return this.frameService.getFrame().canGoBack();
    }
    backOutlets(options) {
        const { outletsToBack, outlets } = this.findOutletsToBack(options);
        if (outletsToBack.length !== outlets.length) {
            NativeScriptDebug.routerError('No outlet found relative to activated route');
        }
        else {
            outletsToBack.forEach((outletToBack) => {
                if (outletToBack.isPageNavigationBack) {
                    NativeScriptDebug.routerError('Attempted to call startGoBack while going back:');
                }
                else {
                    this.locationStrategy.back(outletToBack);
                }
            });
        }
    }
    // tslint:disable-next-line:max-line-length
    findOutletsToBack(options) {
        const rootRoute = this.router.routerState.root;
        let outlets = options.outlets;
        let relativeRoute = options.relativeTo || rootRoute;
        const relativeRouteOutlet = this.findOutletByRoute(relativeRoute);
        const isNSEmptyOutlet = relativeRouteOutlet && relativeRouteOutlet.isNSEmptyOutlet;
        // Lazy named outlet has added 'primary' inner NSEmptyOutlet child.
        // Take parent route when `relativeTo` option points to the outer named outlet.
        if (isNSEmptyOutlet && relativeRoute.outlet !== 'primary') {
            relativeRoute = relativeRoute.parent || relativeRoute;
        }
        outlets = outlets || [relativeRoute.outlet];
        const outletsToBack = this.findOutletsRecursive([...outlets], relativeRoute);
        return { outletsToBack: outletsToBack, outlets: outlets };
    }
    // warning, outlets is mutable!
    findOutletsRecursive(outlets, route) {
        if (!route || outlets.length === 0) {
            return [];
        }
        const outletsToBack = [];
        if (outlets.some((currentOutlet) => currentOutlet === route.outlet)) {
            const outlet = this.findOutletByRoute(route);
            if (outlet) {
                outlets.splice(outlets.indexOf(route.outlet), 1);
                outletsToBack.push(outlet);
            }
        }
        if (!route.children) {
            return outletsToBack;
        }
        for (let index = 0; index < route.children.length; index++) {
            if (outlets.length === 0) {
                break;
            }
            const currentRoute = route.children[index];
            outletsToBack.push(...this.findOutletsRecursive(outlets, currentRoute));
        }
        return outletsToBack;
    }
    findOutletByRoute(currentRoute) {
        let outlet;
        const currentRouteSnapshop = findTopActivatedRouteNodeForOutlet(currentRoute.snapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(currentRouteSnapshop);
        outlet = this.locationStrategy.findOutlet(outletKey, currentRouteSnapshop);
        return outlet;
    }
}
RouterExtensions.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: RouterExtensions, deps: [{ token: i1.Router }, { token: i2.NSLocationStrategy }, { token: i3.FrameService }], target: i0.ɵɵFactoryTarget.Injectable });
RouterExtensions.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: RouterExtensions, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: RouterExtensions, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.Router }, { type: i2.NSLocationStrategy }, { type: i3.FrameService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLWV4dGVuc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9yb3V0ZXItZXh0ZW5zaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQTZDLE1BQU0saUJBQWlCLENBQUM7QUFDcEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFNUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7Ozs7QUFZaEYsTUFBTSxPQUFPLGdCQUFnQjtJQUMzQixZQUFtQixNQUFjLEVBQVMsZ0JBQW9DLEVBQVMsWUFBMEI7UUFBOUYsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUFBUyxpQkFBWSxHQUFaLFlBQVksQ0FBYztJQUFHLENBQUM7SUFFOUcsUUFBUSxDQUFDLFFBQWUsRUFBRSxNQUFpQztRQUNoRSxJQUFJLE1BQU0sRUFBRTtZQUNWLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNyRDtRQUNELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTSxhQUFhLENBQUMsR0FBcUIsRUFBRSxPQUEyQjtRQUNyRSxJQUFJLE9BQU8sRUFBRTtZQUNYLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN0RDtR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S0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQ3pFO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFlBQTRCO1FBQ3BELElBQUksTUFBTSxDQUFDO1FBRVgsTUFBTSxvQkFBb0IsR0FBRyxrQ0FBa0MsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkYsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDL0UsTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFFM0UsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7NkdBOUhVLGdCQUFnQjtpSEFBaEIsZ0JBQWdCLGNBRmYsTUFBTTsyRkFFUCxnQkFBZ0I7a0JBSDVCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyLCBVcmxUcmVlLCBOYXZpZ2F0aW9uRXh0cmFzLCBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IE5hdmlnYXRpb25PcHRpb25zLCBPdXRsZXQgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IEZyYW1lU2VydmljZSB9IGZyb20gJy4uL2ZyYW1lLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi8uLi90cmFjZSc7XG5pbXBvcnQgeyBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0IH0gZnJvbSAnLi9wYWdlLXJvdXRlci1vdXRsZXQtdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBFeHRlbmRlZE5hdmlnYXRpb25FeHRyYXMgPSBOYXZpZ2F0aW9uRXh0cmFzICYgTmF2aWdhdGlvbk9wdGlvbnM7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFja05hdmlnYXRpb25PcHRpb25zIHtcbiAgb3V0bGV0cz86IEFycmF5PHN0cmluZz47XG4gIHJlbGF0aXZlVG8/OiBBY3RpdmF0ZWRSb3V0ZSB8IG51bGw7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBSb3V0ZXJFeHRlbnNpb25zIHtcbiAgY29uc3RydWN0b3IocHVibGljIHJvdXRlcjogUm91dGVyLCBwdWJsaWMgbG9jYXRpb25TdHJhdGVneTogTlNMb2NhdGlvblN0cmF0ZWd5LCBwdWJsaWMgZnJhbWVTZXJ2aWNlOiBGcmFtZVNlcnZpY2UpIHt9XG5cbiAgcHVibGljIG5hdmlnYXRlKGNvbW1hbmRzOiBhbnlbXSwgZXh0cmFzPzogRXh0ZW5kZWROYXZpZ2F0aW9uRXh0cmFzKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKGV4dHJhcykge1xuICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9zZXROYXZpZ2F0aW9uT3B0aW9ucyhleHRyYXMpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoY29tbWFuZHMsIGV4dHJhcyk7XG4gIH1cblxuICBwdWJsaWMgbmF2aWdhdGVCeVVybCh1cmw6IHN0cmluZyB8IFVybFRyZWUsIG9wdGlvbnM/OiBOYXZpZ2F0aW9uT3B0aW9ucyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuX3NldE5hdmlnYXRpb25PcHRpb25zKG9wdGlvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybCh1cmwpO1xuICB9XG5cbiAgcHVibGljIGJhY2soYmFja05hdmlnYXRpb25PcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgaWYgKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgICAgdGhpcy5iYWNrT3V0bGV0cyhiYWNrTmF2aWdhdGlvbk9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuYmFjaygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjYW5Hb0JhY2soYmFja05hdmlnYXRpb25PcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgbGV0IGNhbkdvQmFjayA9IHRydWU7XG4gICAgaWYgKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgICAgY29uc3QgeyBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzIH0gPSB0aGlzLmZpbmRPdXRsZXRzVG9CYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucyk7XG5cbiAgICAgIGlmIChvdXRsZXRzVG9CYWNrLmxlbmd0aCAhPT0gb3V0bGV0cy5sZW5ndGgpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ05vIG91dGxldCBmb3VuZCByZWxhdGl2ZSB0byBhY3RpdmF0ZWQgcm91dGUnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dGxldHNUb0JhY2suZm9yRWFjaCgob3V0bGV0VG9CYWNrKSA9PiB7XG4gICAgICAgICAgaWYgKCF0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuY2FuR29CYWNrKG91dGxldFRvQmFjaykpIHtcbiAgICAgICAgICAgIGNhbkdvQmFjayA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbkdvQmFjayA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5jYW5Hb0JhY2soKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FuR29CYWNrO1xuICB9XG5cbiAgcHVibGljIGJhY2tUb1ByZXZpb3VzUGFnZSgpIHtcbiAgICB0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpLmdvQmFjaygpO1xuICB9XG5cbiAgcHVibGljIGNhbkdvQmFja1RvUHJldmlvdXNQYWdlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpLmNhbkdvQmFjaygpO1xuICB9XG5cbiAgcHJpdmF0ZSBiYWNrT3V0bGV0cyhvcHRpb25zOiBCYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcbiAgICBjb25zdCB7IG91dGxldHNUb0JhY2ssIG91dGxldHMgfSA9IHRoaXMuZmluZE91dGxldHNUb0JhY2sob3B0aW9ucyk7XG5cbiAgICBpZiAob3V0bGV0c1RvQmFjay5sZW5ndGggIT09IG91dGxldHMubGVuZ3RoKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRsZXRzVG9CYWNrLmZvckVhY2goKG91dGxldFRvQmFjaykgPT4ge1xuICAgICAgICBpZiAob3V0bGV0VG9CYWNrLmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIHN0YXJ0R29CYWNrIHdoaWxlIGdvaW5nIGJhY2s6Jyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sob3V0bGV0VG9CYWNrKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICBwcml2YXRlIGZpbmRPdXRsZXRzVG9CYWNrKG9wdGlvbnM/OiBCYWNrTmF2aWdhdGlvbk9wdGlvbnMpOiB7IG91dGxldHNUb0JhY2s6IEFycmF5PE91dGxldD47IG91dGxldHM6IEFycmF5PHN0cmluZz4gfSB7XG4gICAgY29uc3Qgcm9vdFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnJvb3Q7XG4gICAgbGV0IG91dGxldHMgPSBvcHRpb25zLm91dGxldHM7XG4gICAgbGV0IHJlbGF0aXZlUm91dGUgPSBvcHRpb25zLnJlbGF0aXZlVG8gfHwgcm9vdFJvdXRlO1xuXG4gICAgY29uc3QgcmVsYXRpdmVSb3V0ZU91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5Um91dGUocmVsYXRpdmVSb3V0ZSk7XG4gICAgY29uc3QgaXNOU0VtcHR5T3V0bGV0ID0gcmVsYXRpdmVSb3V0ZU91dGxldCAmJiByZWxhdGl2ZVJvdXRlT3V0bGV0LmlzTlNFbXB0eU91dGxldDtcblxuICAgIC8vIExhenkgbmFtZWQgb3V0bGV0IGhhcyBhZGRlZCAncHJpbWFyeScgaW5uZXIgTlNFbXB0eU91dGxldCBjaGlsZC5cbiAgICAvLyBUYWtlIHBhcmVudCByb3V0ZSB3aGVuIGByZWxhdGl2ZVRvYCBvcHRpb24gcG9pbnRzIHRvIHRoZSBvdXRlciBuYW1lZCBvdXRsZXQuXG4gICAgaWYgKGlzTlNFbXB0eU91dGxldCAmJiByZWxhdGl2ZVJvdXRlLm91dGxldCAhPT0gJ3ByaW1hcnknKSB7XG4gICAgICByZWxhdGl2ZVJvdXRlID0gcmVsYXRpdmVSb3V0ZS5wYXJlbnQgfHwgcmVsYXRpdmVSb3V0ZTtcbiAgICB9XG5cbiAgICBvdXRsZXRzID0gb3V0bGV0cyB8fCBbcmVsYXRpdmVSb3V0ZS5vdXRsZXRdO1xuXG4gICAgY29uc3Qgb3V0bGV0c1RvQmFjayA9IHRoaXMuZmluZE91dGxldHNSZWN1cnNpdmUoWy4uLm91dGxldHNdLCByZWxhdGl2ZVJvdXRlKTtcblxuICAgIHJldHVybiB7IG91dGxldHNUb0JhY2s6IG91dGxldHNUb0JhY2ssIG91dGxldHM6IG91dGxldHMgfTtcbiAgfVxuXG4gIC8vIHdhcm5pbmcsIG91dGxldHMgaXMgbXV0YWJsZSFcbiAgcHJpdmF0ZSBmaW5kT3V0bGV0c1JlY3Vyc2l2ZShvdXRsZXRzOiBzdHJpbmdbXSwgcm91dGU/OiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGlmICghcm91dGUgfHwgb3V0bGV0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3Qgb3V0bGV0c1RvQmFjayA9IFtdO1xuICAgIGlmIChvdXRsZXRzLnNvbWUoKGN1cnJlbnRPdXRsZXQpID0+IGN1cnJlbnRPdXRsZXQgPT09IHJvdXRlLm91dGxldCkpIHtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5Um91dGUocm91dGUpO1xuICAgICAgaWYgKG91dGxldCkge1xuICAgICAgICBvdXRsZXRzLnNwbGljZShvdXRsZXRzLmluZGV4T2Yocm91dGUub3V0bGV0KSwgMSk7XG4gICAgICAgIG91dGxldHNUb0JhY2sucHVzaChvdXRsZXQpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXJvdXRlLmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gb3V0bGV0c1RvQmFjaztcbiAgICB9XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJvdXRlLmNoaWxkcmVuLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgaWYgKG91dGxldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY29uc3QgY3VycmVudFJvdXRlID0gcm91dGUuY2hpbGRyZW5baW5kZXhdO1xuICAgICAgb3V0bGV0c1RvQmFjay5wdXNoKC4uLnRoaXMuZmluZE91dGxldHNSZWN1cnNpdmUob3V0bGV0cywgY3VycmVudFJvdXRlKSk7XG4gICAgfVxuICAgIHJldHVybiBvdXRsZXRzVG9CYWNrO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kT3V0bGV0QnlSb3V0ZShjdXJyZW50Um91dGU6IEFjdGl2YXRlZFJvdXRlKTogT3V0bGV0IHtcbiAgICBsZXQgb3V0bGV0O1xuXG4gICAgY29uc3QgY3VycmVudFJvdXRlU25hcHNob3AgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KGN1cnJlbnRSb3V0ZS5zbmFwc2hvdCk7XG4gICAgY29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmdldFJvdXRlRnVsbFBhdGgoY3VycmVudFJvdXRlU25hcHNob3ApO1xuICAgIG91dGxldCA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5maW5kT3V0bGV0KG91dGxldEtleSwgY3VycmVudFJvdXRlU25hcHNob3ApO1xuXG4gICAgcmV0dXJuIG91dGxldDtcbiAgfVxufVxuIl19