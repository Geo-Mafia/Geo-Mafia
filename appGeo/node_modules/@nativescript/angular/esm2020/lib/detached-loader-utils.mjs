import { ApplicationRef, ComponentFactoryResolver, TemplateRef } from '@angular/core';
import { ContentView } from '@nativescript/core';
import { DetachedLoader } from './cdk/detached-loader';
import { ComponentPortal, NativeScriptDomPortalOutlet, TemplatePortal } from './cdk/portal';
import { NgViewRef } from './view-refs';
/**
 * creates a DetachedLoader either linked to the ViewContainerRef or the ApplicationRef if ViewContainerRef is not defined
 * @param resolver component factory resolver
 * @param injector default injector, unused if viewContainerRef is set
 * @param viewContainerRef where the view should live in the angular tree
 * @returns reference to the DetachedLoader
 */
export function generateDetachedLoader(resolver, injector, viewContainerRef) {
    injector = viewContainerRef?.injector || injector;
    const detachedFactory = resolver.resolveComponentFactory(DetachedLoader);
    const detachedLoaderRef = viewContainerRef?.createComponent(detachedFactory) || detachedFactory.create(injector);
    if (!viewContainerRef) {
        injector.get(ApplicationRef).attachView(detachedLoaderRef.hostView);
    }
    detachedLoaderRef.changeDetectorRef.detectChanges();
    return detachedLoaderRef;
}
/**
 * Generates a NgViewRef from a component or template. @see NgViewRef
 * Pass keepNativeViewAttached as `true` if you don't want the first native view to be detached from its parent.
 * For opening modals and others, the firstNativeLikeView should be detached.
 * @param typeOrTemplate ComponentType or TemplateRef that should be instanced
 * @param options options for creating the view
 * @returns NgViewRef
 */
export function generateNativeScriptView(typeOrTemplate, options) {
    let detachedLoaderRef = options.detachedLoaderRef;
    const reusingDetachedLoader = !!detachedLoaderRef;
    if (reusingDetachedLoader) {
        options.viewContainerRef = detachedLoaderRef.instance.vc;
    }
    const injector = options.viewContainerRef?.injector || options.injector;
    const resolver = options.resolver || injector.get(ComponentFactoryResolver);
    if (!detachedLoaderRef && (options.viewContainerRef || typeOrTemplate instanceof TemplateRef)) {
        detachedLoaderRef = generateDetachedLoader(resolver, injector, options.viewContainerRef);
    }
    let portal;
    if (typeOrTemplate instanceof TemplateRef) {
        portal = new TemplatePortal(typeOrTemplate, detachedLoaderRef.instance.vc);
    }
    else {
        portal = new ComponentPortal(typeOrTemplate, detachedLoaderRef?.instance.vc);
    }
    const parentView = new ContentView();
    const portalOutlet = new NativeScriptDomPortalOutlet(parentView, resolver, injector.get(ApplicationRef), injector);
    const componentOrTemplateRef = portalOutlet.attach(portal);
    componentOrTemplateRef.onDestroy(() => {
        portalOutlet.dispose();
    });
    if (detachedLoaderRef && !reusingDetachedLoader) {
        componentOrTemplateRef.onDestroy(() => {
            detachedLoaderRef.destroy();
        });
    }
    const viewRef = new NgViewRef(componentOrTemplateRef);
    viewRef.detachedLoaderRef = detachedLoaderRef;
    if (!options.keepNativeViewAttached) {
        viewRef.detachNativeLikeView();
    }
    return viewRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWNoZWQtbG9hZGVyLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL2RldGFjaGVkLWxvYWRlci11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUEyQyxXQUFXLEVBQTBCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZKLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSwyQkFBMkIsRUFBRSxjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV4Qzs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsc0JBQXNCLENBQUMsUUFBa0MsRUFBRSxRQUFrQixFQUFFLGdCQUFtQztJQUNoSSxRQUFRLEdBQUcsZ0JBQWdCLEVBQUUsUUFBUSxJQUFJLFFBQVEsQ0FBQztJQUNsRCxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekUsTUFBTSxpQkFBaUIsR0FBRyxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqSCxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7UUFDckIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDckU7SUFDRCxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNwRCxPQUFPLGlCQUFpQixDQUFDO0FBQzNCLENBQUM7QUFFRDs7Ozs7OztHQU9HO0FBQ0gsTUFBTSxVQUFVLHdCQUF3QixDQUN0QyxjQUF3QyxFQUN4QyxPQVNDO0lBRUQsSUFBSSxpQkFBaUIsR0FBaUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0lBQ2hGLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO0lBQ2xELElBQUkscUJBQXFCLEVBQUU7UUFDekIsT0FBTyxDQUFDLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7S0FDMUQ7SUFDRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsUUFBUSxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUM7SUFDeEUsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDNUUsSUFBSSxDQUFDLGlCQUFpQixJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixJQUFJLGNBQWMsWUFBWSxXQUFXLENBQUMsRUFBRTtRQUM3RixpQkFBaUIsR0FBRyxzQkFBc0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQzFGO0lBQ0QsSUFBSSxNQUE4QyxDQUFDO0lBQ25ELElBQUksY0FBYyxZQUFZLFdBQVcsRUFBRTtRQUN6QyxNQUFNLEdBQUcsSUFBSSxjQUFjLENBQUMsY0FBYyxFQUFFLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM1RTtTQUFNO1FBQ0wsTUFBTSxHQUFHLElBQUksZUFBZSxDQUFDLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDOUU7SUFDRCxNQUFNLFVBQVUsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3JDLE1BQU0sWUFBWSxHQUFHLElBQUksMkJBQTJCLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ25ILE1BQU0sc0JBQXNCLEdBQXlDLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakcsc0JBQXNCLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNwQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDSCxJQUFJLGlCQUFpQixJQUFJLENBQUMscUJBQXFCLEVBQUU7UUFDL0Msc0JBQXNCLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztLQUNKO0lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNyRCxPQUFlLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7SUFDdkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRTtRQUNuQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztLQUNoQztJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIEVtYmVkZGVkVmlld1JlZiwgSW5qZWN0b3IsIFRlbXBsYXRlUmVmLCBUeXBlLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb250ZW50VmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBEZXRhY2hlZExvYWRlciB9IGZyb20gJy4vY2RrL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICcuL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHsgTmdWaWV3UmVmIH0gZnJvbSAnLi92aWV3LXJlZnMnO1xuXG4vKipcbiAqIGNyZWF0ZXMgYSBEZXRhY2hlZExvYWRlciBlaXRoZXIgbGlua2VkIHRvIHRoZSBWaWV3Q29udGFpbmVyUmVmIG9yIHRoZSBBcHBsaWNhdGlvblJlZiBpZiBWaWV3Q29udGFpbmVyUmVmIGlzIG5vdCBkZWZpbmVkXG4gKiBAcGFyYW0gcmVzb2x2ZXIgY29tcG9uZW50IGZhY3RvcnkgcmVzb2x2ZXJcbiAqIEBwYXJhbSBpbmplY3RvciBkZWZhdWx0IGluamVjdG9yLCB1bnVzZWQgaWYgdmlld0NvbnRhaW5lclJlZiBpcyBzZXRcbiAqIEBwYXJhbSB2aWV3Q29udGFpbmVyUmVmIHdoZXJlIHRoZSB2aWV3IHNob3VsZCBsaXZlIGluIHRoZSBhbmd1bGFyIHRyZWVcbiAqIEByZXR1cm5zIHJlZmVyZW5jZSB0byB0aGUgRGV0YWNoZWRMb2FkZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlRGV0YWNoZWRMb2FkZXIocmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgaW5qZWN0b3I6IEluamVjdG9yLCB2aWV3Q29udGFpbmVyUmVmPzogVmlld0NvbnRhaW5lclJlZikge1xuICBpbmplY3RvciA9IHZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IGluamVjdG9yO1xuICBjb25zdCBkZXRhY2hlZEZhY3RvcnkgPSByZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG4gIGNvbnN0IGRldGFjaGVkTG9hZGVyUmVmID0gdmlld0NvbnRhaW5lclJlZj8uY3JlYXRlQ29tcG9uZW50KGRldGFjaGVkRmFjdG9yeSkgfHwgZGV0YWNoZWRGYWN0b3J5LmNyZWF0ZShpbmplY3Rvcik7XG4gIGlmICghdmlld0NvbnRhaW5lclJlZikge1xuICAgIGluamVjdG9yLmdldChBcHBsaWNhdGlvblJlZikuYXR0YWNoVmlldyhkZXRhY2hlZExvYWRlclJlZi5ob3N0Vmlldyk7XG4gIH1cbiAgZGV0YWNoZWRMb2FkZXJSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICByZXR1cm4gZGV0YWNoZWRMb2FkZXJSZWY7XG59XG5cbi8qKlxuICogR2VuZXJhdGVzIGEgTmdWaWV3UmVmIGZyb20gYSBjb21wb25lbnQgb3IgdGVtcGxhdGUuIEBzZWUgTmdWaWV3UmVmXG4gKiBQYXNzIGtlZXBOYXRpdmVWaWV3QXR0YWNoZWQgYXMgYHRydWVgIGlmIHlvdSBkb24ndCB3YW50IHRoZSBmaXJzdCBuYXRpdmUgdmlldyB0byBiZSBkZXRhY2hlZCBmcm9tIGl0cyBwYXJlbnQuXG4gKiBGb3Igb3BlbmluZyBtb2RhbHMgYW5kIG90aGVycywgdGhlIGZpcnN0TmF0aXZlTGlrZVZpZXcgc2hvdWxkIGJlIGRldGFjaGVkLlxuICogQHBhcmFtIHR5cGVPclRlbXBsYXRlIENvbXBvbmVudFR5cGUgb3IgVGVtcGxhdGVSZWYgdGhhdCBzaG91bGQgYmUgaW5zdGFuY2VkXG4gKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zIGZvciBjcmVhdGluZyB0aGUgdmlld1xuICogQHJldHVybnMgTmdWaWV3UmVmXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZU5hdGl2ZVNjcmlwdFZpZXc8VD4oXG4gIHR5cGVPclRlbXBsYXRlOiBUeXBlPFQ+IHwgVGVtcGxhdGVSZWY8VD4sXG4gIG9wdGlvbnM6IHtcbiAgICByZXNvbHZlcj86IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjtcbiAgICB2aWV3Q29udGFpbmVyUmVmPzogVmlld0NvbnRhaW5lclJlZjtcbiAgICBpbmplY3RvcjogSW5qZWN0b3I7XG4gICAga2VlcE5hdGl2ZVZpZXdBdHRhY2hlZD86IGJvb2xlYW47XG4gICAgLyoqXG4gICAgICogcmV1c2UgYSBkZXRhY2hlZExvYWRlclJlZi4gVGhpcyB3aWxsIG92ZXJyaWRlIHZpZXdDb250YWluZXJSZWZcbiAgICAgKi9cbiAgICBkZXRhY2hlZExvYWRlclJlZj86IENvbXBvbmVudFJlZjxEZXRhY2hlZExvYWRlcj47XG4gIH1cbikge1xuICBsZXQgZGV0YWNoZWRMb2FkZXJSZWY6IENvbXBvbmVudFJlZjxEZXRhY2hlZExvYWRlcj4gPSBvcHRpb25zLmRldGFjaGVkTG9hZGVyUmVmO1xuICBjb25zdCByZXVzaW5nRGV0YWNoZWRMb2FkZXIgPSAhIWRldGFjaGVkTG9hZGVyUmVmO1xuICBpZiAocmV1c2luZ0RldGFjaGVkTG9hZGVyKSB7XG4gICAgb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmID0gZGV0YWNoZWRMb2FkZXJSZWYuaW5zdGFuY2UudmM7XG4gIH1cbiAgY29uc3QgaW5qZWN0b3IgPSBvcHRpb25zLnZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IG9wdGlvbnMuaW5qZWN0b3I7XG4gIGNvbnN0IHJlc29sdmVyID0gb3B0aW9ucy5yZXNvbHZlciB8fCBpbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKTtcbiAgaWYgKCFkZXRhY2hlZExvYWRlclJlZiAmJiAob3B0aW9ucy52aWV3Q29udGFpbmVyUmVmIHx8IHR5cGVPclRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpKSB7XG4gICAgZGV0YWNoZWRMb2FkZXJSZWYgPSBnZW5lcmF0ZURldGFjaGVkTG9hZGVyKHJlc29sdmVyLCBpbmplY3Rvciwgb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmKTtcbiAgfVxuICBsZXQgcG9ydGFsOiBDb21wb25lbnRQb3J0YWw8VD4gfCBUZW1wbGF0ZVBvcnRhbDxUPjtcbiAgaWYgKHR5cGVPclRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpIHtcbiAgICBwb3J0YWwgPSBuZXcgVGVtcGxhdGVQb3J0YWwodHlwZU9yVGVtcGxhdGUsIGRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLnZjKTtcbiAgfSBlbHNlIHtcbiAgICBwb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKHR5cGVPclRlbXBsYXRlLCBkZXRhY2hlZExvYWRlclJlZj8uaW5zdGFuY2UudmMpO1xuICB9XG4gIGNvbnN0IHBhcmVudFZpZXcgPSBuZXcgQ29udGVudFZpZXcoKTtcbiAgY29uc3QgcG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldChwYXJlbnRWaWV3LCByZXNvbHZlciwgaW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKSwgaW5qZWN0b3IpO1xuICBjb25zdCBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb21wb25lbnRSZWY8VD4gfCBFbWJlZGRlZFZpZXdSZWY8VD4gPSBwb3J0YWxPdXRsZXQuYXR0YWNoKHBvcnRhbCk7XG4gIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYub25EZXN0cm95KCgpID0+IHtcbiAgICBwb3J0YWxPdXRsZXQuZGlzcG9zZSgpO1xuICB9KTtcbiAgaWYgKGRldGFjaGVkTG9hZGVyUmVmICYmICFyZXVzaW5nRGV0YWNoZWRMb2FkZXIpIHtcbiAgICBjb21wb25lbnRPclRlbXBsYXRlUmVmLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgICBkZXRhY2hlZExvYWRlclJlZi5kZXN0cm95KCk7XG4gICAgfSk7XG4gIH1cbiAgY29uc3Qgdmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYoY29tcG9uZW50T3JUZW1wbGF0ZVJlZik7XG4gICh2aWV3UmVmIGFzIGFueSkuZGV0YWNoZWRMb2FkZXJSZWYgPSBkZXRhY2hlZExvYWRlclJlZjtcbiAgaWYgKCFvcHRpb25zLmtlZXBOYXRpdmVWaWV3QXR0YWNoZWQpIHtcbiAgICB2aWV3UmVmLmRldGFjaE5hdGl2ZUxpa2VWaWV3KCk7XG4gIH1cbiAgcmV0dXJuIHZpZXdSZWY7XG59XG4iXX0=