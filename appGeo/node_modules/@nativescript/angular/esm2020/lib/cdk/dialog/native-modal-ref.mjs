import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Injector, Optional, ÉµdetectChanges as detectChanges } from '@angular/core';
import { ContentView, Application, Frame } from '@nativescript/core';
import { fromEvent, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { NSLocationStrategy } from '../../legacy/router/ns-location-strategy';
import { once } from '../../utils/general';
import { DetachedLoader } from '../detached-loader';
import { NativeScriptDomPortalOutlet } from '../portal/nsdom-portal-outlet';
import { NativeDialogConfig } from './dialog-config';
import { NgViewRef } from '../../view-refs';
let NativeModalRef = class NativeModalRef {
    constructor(_config, _injector, location) {
        this._config = _config;
        this._injector = _injector;
        this.location = location;
        this.stateChanged = new Subject();
        this.onDismiss = new Subject();
        this._isDismissed = false;
        let parentView = this._config.viewContainerRef?.element.nativeElement || Application.getRootView();
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        while (parentView._modal || parentView._ngDialogRoot) {
            parentView = parentView._modal || parentView._ngDialogRoot;
        }
        this.parentView = parentView;
        this._closeCallback = once(async () => {
            this.stateChanged.next({ state: 'closing' });
            if (!this._isDismissed) {
                this.modalViewRef.firstNativeLikeView?.closeModal();
            }
            await this.location?._closeModalNavigation();
            // this.detachedLoaderRef?.destroy();
            if (this.modalViewRef?.firstNativeLikeView.isLoaded) {
                fromEvent(this.modalViewRef.firstNativeLikeView, 'unloaded')
                    .pipe(take(1))
                    .subscribe(() => this.stateChanged.next({ state: 'closed' }));
            }
            else {
                this.stateChanged.next({ state: 'closed' });
            }
        });
    }
    _generateDetachedContainer(vcRef) {
        const detachedFactory = (this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver)).resolveComponentFactory(DetachedLoader);
        if (vcRef) {
            this.detachedLoaderRef = vcRef.createComponent(detachedFactory);
        }
        else {
            this.detachedLoaderRef = detachedFactory.create(this._config.viewContainerRef?.injector || this._injector);
            this._injector.get(ApplicationRef).attachView(this.detachedLoaderRef.hostView);
        }
        this.detachedLoaderRef.changeDetectorRef.detectChanges();
    }
    attachTemplatePortal(portal) {
        this.startModalNavigation();
        const vcRef = portal.viewContainerRef || this._config.viewContainerRef;
        this._generateDetachedContainer(vcRef);
        portal.viewContainerRef = this.detachedLoaderRef.instance.vc;
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const templateRef = this.portalOutlet.attach(portal);
        this.modalViewRef = new NgViewRef(templateRef);
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                await this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        //   if (this.modalView !== templateRef.rootNodes[0]) {
        //     componentRef.location.nativeElement._ngDialogRoot = this.modalView;
        //   }
        return templateRef;
    }
    attachComponentPortal(portal) {
        this.startModalNavigation();
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const componentRef = this.portalOutlet.attach(portal);
        detectChanges(componentRef.instance);
        this.modalViewRef = new NgViewRef(componentRef);
        if (this.modalViewRef.firstNativeLikeView !== this.modalViewRef.view) {
            this.modalViewRef.view._ngDialogRoot = this.modalViewRef.firstNativeLikeView;
        }
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                this._isDismissed = true;
                this._closeCallback(); // close callback can only be called once, so we call it here to setup the exit events
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        return componentRef;
    }
    _startExitAnimation() {
        this._closeCallback();
    }
    dispose() {
        this.portalOutlet.dispose();
    }
    startModalNavigation() {
        const frame = this.parentView instanceof Frame ? this.parentView : this.parentView?.page?.frame || Frame.topmost();
        this.location?._beginModalNavigation(frame);
    }
};
NativeModalRef = __decorate([
    __param(2, Optional()),
    __metadata("design:paramtypes", [NativeDialogConfig, Injector, NSLocationStrategy])
], NativeModalRef);
export { NativeModalRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLW1vZGFsLXJlZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9jZGsvZGlhbG9nL25hdGl2ZS1tb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWlDLFFBQVEsRUFBRSxRQUFRLEVBQW9CLGNBQWMsSUFBSSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0ssT0FBTyxFQUFFLFdBQVcsRUFBUSxXQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0UsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUM5RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXBELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUU1QyxJQUFhLGNBQWMsR0FBM0IsTUFBYSxjQUFjO0lBYXpCLFlBQW9CLE9BQTJCLEVBQVUsU0FBbUIsRUFBc0IsUUFBNkI7UUFBM0csWUFBTyxHQUFQLE9BQU8sQ0FBb0I7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQXNCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBWC9I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RSxDQUFBO3FDQUE1RCxrQkFBa0IsRUFBcUIsUUFBUSxFQUFpQyxrQkFBa0I7R0FicEgsY0FBYyxDQWdJMUI7U0FoSVksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRW1iZWRkZWRWaWV3UmVmLCBJbmplY3RvciwgT3B0aW9uYWwsIFZpZXdDb250YWluZXJSZWYsIMm1ZGV0ZWN0Q2hhbmdlcyBhcyBkZXRlY3RDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb250ZW50VmlldywgVmlldywgQXBwbGljYXRpb24sIEZyYW1lIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcEhvc3RBc3luY1ZpZXcsIEFwcEhvc3RWaWV3IH0gZnJvbSAnLi4vLi4vYXBwLWhvc3Qtdmlldyc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi8uLi9sZWdhY3kvcm91dGVyL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IG9uY2UgfSBmcm9tICcuLi8uLi91dGlscy9nZW5lcmFsJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vZGV0YWNoZWQtbG9hZGVyJztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICcuLi9wb3J0YWwvY29tbW9uJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCB9IGZyb20gJy4uL3BvcnRhbC9uc2RvbS1wb3J0YWwtb3V0bGV0JztcbmltcG9ydCB7IE5hdGl2ZURpYWxvZ0NvbmZpZyB9IGZyb20gJy4vZGlhbG9nLWNvbmZpZyc7XG5pbXBvcnQgeyBOZ1ZpZXdSZWYgfSBmcm9tICcuLi8uLi92aWV3LXJlZnMnO1xuXG5leHBvcnQgY2xhc3MgTmF0aXZlTW9kYWxSZWYge1xuICBfaWQ6IHN0cmluZztcbiAgc3RhdGVDaGFuZ2VkID0gbmV3IFN1YmplY3Q8eyBzdGF0ZTogJ29wZW5lZCcgfCAnY2xvc2VkJyB8ICdjbG9zaW5nJyB9PigpO1xuICBvbkRpc21pc3MgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIHBhcmVudFZpZXc6IFZpZXc7XG4gIHBvcnRhbE91dGxldDogTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0O1xuICBkZXRhY2hlZExvYWRlclJlZjogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPjtcbiAgbW9kYWxWaWV3UmVmOiBOZ1ZpZXdSZWY8YW55PjtcblxuICBwcml2YXRlIF9jbG9zZUNhbGxiYWNrOiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIF9pc0Rpc21pc3NlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NvbmZpZzogTmF0aXZlRGlhbG9nQ29uZmlnLCBwcml2YXRlIF9pbmplY3RvcjogSW5qZWN0b3IsIEBPcHRpb25hbCgpIHByaXZhdGUgbG9jYXRpb24/OiBOU0xvY2F0aW9uU3RyYXRlZ3kpIHtcbiAgICBsZXQgcGFyZW50VmlldyA9IHRoaXMuX2NvbmZpZy52aWV3Q29udGFpbmVyUmVmPy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQgfHwgQXBwbGljYXRpb24uZ2V0Um9vdFZpZXcoKTtcblxuICAgIGlmICgocGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RWaWV3IHx8IHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0QXN5bmNWaWV3KSAmJiBwYXJlbnRWaWV3Lm5nQXBwUm9vdCkge1xuICAgICAgcGFyZW50VmlldyA9IHBhcmVudFZpZXcubmdBcHBSb290O1xuICAgIH1cblxuICAgIC8vIF9uZ0RpYWxvZ1Jvb3QgaXMgdGhlIGZpcnN0IGNoaWxkIG9mIHRoZSBwcmV2aW91c2x5IGRldGFjaGVkIHByb3h5LlxuICAgIC8vIEl0IHNob3VsZCBoYXZlICd2aWV3Q29udHJvbGxlcicgKGlPUykgb3IgJ19kaWFsb2dGcmFnbWVudCcgKEFuZHJvaWQpIGF2YWlsYWJsZSBmb3JcbiAgICAvLyBwcmVzZW50aW5nIGZ1dHVyZSBtb2RhbCB2aWV3cy5cbiAgICB3aGlsZSAocGFyZW50Vmlldy5fbW9kYWwgfHwgcGFyZW50Vmlldy5fbmdEaWFsb2dSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5fbW9kYWwgfHwgcGFyZW50Vmlldy5fbmdEaWFsb2dSb290O1xuICAgIH1cbiAgICB0aGlzLnBhcmVudFZpZXcgPSBwYXJlbnRWaWV3O1xuXG4gICAgdGhpcy5fY2xvc2VDYWxsYmFjayA9IG9uY2UoYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy5zdGF0ZUNoYW5nZWQubmV4dCh7IHN0YXRlOiAnY2xvc2luZycgfSk7XG4gICAgICBpZiAoIXRoaXMuX2lzRGlzbWlzc2VkKSB7XG4gICAgICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXc/LmNsb3NlTW9kYWwoKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMubG9jYXRpb24/Ll9jbG9zZU1vZGFsTmF2aWdhdGlvbigpO1xuICAgICAgLy8gdGhpcy5kZXRhY2hlZExvYWRlclJlZj8uZGVzdHJveSgpO1xuICAgICAgaWYgKHRoaXMubW9kYWxWaWV3UmVmPy5maXJzdE5hdGl2ZUxpa2VWaWV3LmlzTG9hZGVkKSB7XG4gICAgICAgIGZyb21FdmVudCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCAndW5sb2FkZWQnKVxuICAgICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zZWQnIH0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkLm5leHQoeyBzdGF0ZTogJ2Nsb3NlZCcgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBfZ2VuZXJhdGVEZXRhY2hlZENvbnRhaW5lcih2Y1JlZj86IFZpZXdDb250YWluZXJSZWYpIHtcbiAgICBjb25zdCBkZXRhY2hlZEZhY3RvcnkgPSAodGhpcy5fY29uZmlnLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8fCB0aGlzLl9pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSkucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICAgIGlmICh2Y1JlZikge1xuICAgICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZiA9IHZjUmVmLmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRldGFjaGVkTG9hZGVyUmVmID0gZGV0YWNoZWRGYWN0b3J5LmNyZWF0ZSh0aGlzLl9jb25maWcudmlld0NvbnRhaW5lclJlZj8uaW5qZWN0b3IgfHwgdGhpcy5faW5qZWN0b3IpO1xuICAgICAgdGhpcy5faW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKS5hdHRhY2hWaWV3KHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYuaG9zdFZpZXcpO1xuICAgIH1cbiAgICB0aGlzLmRldGFjaGVkTG9hZGVyUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIGF0dGFjaFRlbXBsYXRlUG9ydGFsPFQ+KHBvcnRhbDogVGVtcGxhdGVQb3J0YWw8VD4pOiBFbWJlZGRlZFZpZXdSZWY8VD4ge1xuICAgIHRoaXMuc3RhcnRNb2RhbE5hdmlnYXRpb24oKTtcbiAgICBjb25zdCB2Y1JlZiA9IHBvcnRhbC52aWV3Q29udGFpbmVyUmVmIHx8IHRoaXMuX2NvbmZpZy52aWV3Q29udGFpbmVyUmVmO1xuICAgIHRoaXMuX2dlbmVyYXRlRGV0YWNoZWRDb250YWluZXIodmNSZWYpO1xuICAgIHBvcnRhbC52aWV3Q29udGFpbmVyUmVmID0gdGhpcy5kZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS52YztcbiAgICBjb25zdCB0YXJnZXRWaWV3ID0gbmV3IENvbnRlbnRWaWV3KCk7XG4gICAgdGhpcy5wb3J0YWxPdXRsZXQgPSBuZXcgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0KHRhcmdldFZpZXcsIHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciksIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZiksIHRoaXMuX2luamVjdG9yKTtcbiAgICBjb25zdCB0ZW1wbGF0ZVJlZiA9IHRoaXMucG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmID0gbmV3IE5nVmlld1JlZih0ZW1wbGF0ZVJlZik7XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlld1snX19uZ19tb2RhbF9pZF9fJ10gPSB0aGlzLl9pZDtcbiAgICAvLyBpZiB3ZSBkb24ndCBkZXRhY2ggdGhlIHZpZXcgZnJvbSBpdHMgcGFyZW50LCBpb3MgZ2V0cyBtYWRcbiAgICB0aGlzLm1vZGFsVmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuXG4gICAgY29uc3QgdXNlck9wdGlvbnMgPSB0aGlzLl9jb25maWcubmF0aXZlT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnBhcmVudFZpZXcuc2hvd01vZGFsKHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsIHtcbiAgICAgIGNvbnRleHQ6IG51bGwsXG4gICAgICAuLi51c2VyT3B0aW9ucyxcbiAgICAgIGNsb3NlQ2FsbGJhY2s6IGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5sb2NhdGlvbj8uX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLm5leHQoKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MuY29tcGxldGUoKTtcbiAgICAgIH0sXG4gICAgICBjYW5jZWxhYmxlOiAhdGhpcy5fY29uZmlnLmRpc2FibGVDbG9zZSxcbiAgICB9KTtcbiAgICAvLyAgIGlmICh0aGlzLm1vZGFsVmlldyAhPT0gdGVtcGxhdGVSZWYucm9vdE5vZGVzWzBdKSB7XG4gICAgLy8gICAgIGNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50Ll9uZ0RpYWxvZ1Jvb3QgPSB0aGlzLm1vZGFsVmlldztcbiAgICAvLyAgIH1cbiAgICByZXR1cm4gdGVtcGxhdGVSZWY7XG4gIH1cblxuICBhdHRhY2hDb21wb25lbnRQb3J0YWw8VD4ocG9ydGFsOiBDb21wb25lbnRQb3J0YWw8VD4pOiBDb21wb25lbnRSZWY8VD4ge1xuICAgIHRoaXMuc3RhcnRNb2RhbE5hdmlnYXRpb24oKTtcblxuICAgIGNvbnN0IHRhcmdldFZpZXcgPSBuZXcgQ29udGVudFZpZXcoKTtcbiAgICB0aGlzLnBvcnRhbE91dGxldCA9IG5ldyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQodGFyZ2V0VmlldywgdGhpcy5fY29uZmlnLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8fCB0aGlzLl9pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSwgdGhpcy5faW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKSwgdGhpcy5faW5qZWN0b3IpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHRoaXMucG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICAgIGRldGVjdENoYW5nZXMoY29tcG9uZW50UmVmLmluc3RhbmNlKTtcbiAgICB0aGlzLm1vZGFsVmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYoY29tcG9uZW50UmVmKTtcbiAgICBpZiAodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldyAhPT0gdGhpcy5tb2RhbFZpZXdSZWYudmlldykge1xuICAgICAgKDxhbnk+dGhpcy5tb2RhbFZpZXdSZWYudmlldykuX25nRGlhbG9nUm9vdCA9IHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXc7XG4gICAgfVxuICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXdbJ19fbmdfbW9kYWxfaWRfXyddID0gdGhpcy5faWQ7XG4gICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZGV0YWNoTmF0aXZlTGlrZVZpZXcoKTtcblxuICAgIGNvbnN0IHVzZXJPcHRpb25zID0gdGhpcy5fY29uZmlnLm5hdGl2ZU9wdGlvbnMgfHwge307XG4gICAgdGhpcy5wYXJlbnRWaWV3LnNob3dNb2RhbCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCB7XG4gICAgICBjb250ZXh0OiBudWxsLFxuICAgICAgLi4udXNlck9wdGlvbnMsXG4gICAgICBjbG9zZUNhbGxiYWNrOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRoaXMuX2lzRGlzbWlzc2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5fY2xvc2VDYWxsYmFjaygpOyAvLyBjbG9zZSBjYWxsYmFjayBjYW4gb25seSBiZSBjYWxsZWQgb25jZSwgc28gd2UgY2FsbCBpdCBoZXJlIHRvIHNldHVwIHRoZSBleGl0IGV2ZW50c1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5uZXh0KCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLmNvbXBsZXRlKCk7XG4gICAgICB9LFxuICAgICAgY2FuY2VsYWJsZTogIXRoaXMuX2NvbmZpZy5kaXNhYmxlQ2xvc2UsXG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbXBvbmVudFJlZjtcbiAgfVxuXG4gIF9zdGFydEV4aXRBbmltYXRpb24oKSB7XG4gICAgdGhpcy5fY2xvc2VDYWxsYmFjaygpO1xuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLnBvcnRhbE91dGxldC5kaXNwb3NlKCk7XG4gIH1cbiAgcHJpdmF0ZSBzdGFydE1vZGFsTmF2aWdhdGlvbigpIHtcbiAgICBjb25zdCBmcmFtZSA9IHRoaXMucGFyZW50VmlldyBpbnN0YW5jZW9mIEZyYW1lID8gdGhpcy5wYXJlbnRWaWV3IDogdGhpcy5wYXJlbnRWaWV3Py5wYWdlPy5mcmFtZSB8fCBGcmFtZS50b3Btb3N0KCk7XG5cbiAgICB0aGlzLmxvY2F0aW9uPy5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWUpO1xuICB9XG59XG4iXX0=