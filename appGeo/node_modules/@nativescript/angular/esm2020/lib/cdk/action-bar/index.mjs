import { Directive, Component, ElementRef, Optional } from '@angular/core';
import { ActionBar, ActionItem, NavigationButton, Page } from '@nativescript/core';
import { isBlank } from '../../utils/lang-facade';
import { isInvisibleNode, isView } from '../../views/utils';
import { registerElement } from '../../element-registry';
import * as i0 from "@angular/core";
import * as i1 from "@nativescript/core";
export function isActionItem(view) {
    return view instanceof ActionItem;
}
export function isNavigationButton(view) {
    return view instanceof NavigationButton;
}
export const actionBarMeta = {
    skipAddToDom: true,
    insertChild: (parent, child, next) => {
        if (isInvisibleNode(child)) {
            return;
        }
        else if (isNavigationButton(child)) {
            parent.navigationButton = child;
            child.parentNode = parent;
        }
        else if (isActionItem(child)) {
            addActionItem(parent, child, next);
            child.parentNode = parent;
        }
        else if (isView(child)) {
            parent.titleView = child;
        }
    },
    removeChild: (parent, child) => {
        if (isInvisibleNode(child)) {
            return;
        }
        else if (isNavigationButton(child)) {
            if (parent.navigationButton === child) {
                parent.navigationButton = null;
            }
            child.parentNode = null;
        }
        else if (isActionItem(child)) {
            parent.actionItems.removeItem(child);
            child.parentNode = null;
        }
        else if (isView(child) && parent.titleView && parent.titleView === child) {
            parent.titleView = null;
        }
    },
};
registerElement('ActionBar', () => ActionBar, actionBarMeta);
registerElement('ActionItem', () => ActionItem);
registerElement('NavigationButton', () => NavigationButton);
const addActionItem = (bar, item, next) => {
    if (next) {
        insertActionItemBefore(bar, item, next);
    }
    else {
        appendActionItem(bar, item);
    }
};
const insertActionItemBefore = (bar, item, next) => {
    const actionItems = bar.actionItems;
    const actionItemsCollection = actionItems.getItems();
    const indexToInsert = actionItemsCollection.indexOf(next);
    actionItemsCollection.splice(indexToInsert, 0, item);
    actionItems.setItems(actionItemsCollection);
};
const appendActionItem = (bar, item) => {
    bar.actionItems.addItem(item);
};
export class ActionBarComponent {
    constructor(element, page) {
        this.element = element;
        this.page = page;
        if (!this.page) {
            throw new Error('No Page found in ActionBarComponent.\n' + 'Only a Page can contain an ActionBar, so please ensure ActionBar is only used inside a Component that is routed via page-router-outlet or is contained in a Page.\n' + 'Example for root action bars in AppComponent: <Frame><Page><ActionBar>....</ActionBar></Page></Frame>');
        }
        if (isBlank(this.page.actionBarHidden)) {
            this.page.actionBarHidden = false;
        }
        this.page.actionBar = this.element.nativeElement;
        this.page.actionBar.update();
    }
}
ActionBarComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionBarComponent, deps: [{ token: i0.ElementRef }, { token: i1.Page, optional: true }], target: i0.ɵɵFactoryTarget.Component });
ActionBarComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.3", type: ActionBarComponent, selector: "ActionBar", ngImport: i0, template: '<ng-content></ng-content>', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionBarComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ActionBar',
                    template: '<ng-content></ng-content>',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.Page, decorators: [{
                    type: Optional
                }] }]; } });
export class ActionBarScope {
    // tslint:disable-line:component-class-suffix
    constructor(page) {
        this.page = page;
        if (!this.page) {
            throw new Error('Inside ActionBarExtension but no ActionBar found to extend.');
        }
    }
    onNavButtonInit(navBtn) {
        this.page.actionBar.navigationButton = navBtn.element.nativeElement;
    }
    onNavButtonDestroy(navBtn) {
        const nav = navBtn.element.nativeElement;
        if (nav && this.page.actionBar.navigationButton === nav) {
            this.page.actionBar.navigationButton = null;
        }
    }
    onActionInit(item) {
        this.page.actionBar.actionItems.addItem(item.element.nativeElement);
    }
    onActionDestroy(item) {
        if (item.element.nativeElement.actionBar) {
            this.page.actionBar.actionItems.removeItem(item.element.nativeElement);
        }
    }
}
ActionBarScope.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionBarScope, deps: [{ token: i1.Page, optional: true }], target: i0.ɵɵFactoryTarget.Component });
ActionBarScope.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.3", type: ActionBarScope, selector: "ActionBarExtension", ngImport: i0, template: '', isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionBarScope, decorators: [{
            type: Component,
            args: [{
                    selector: 'ActionBarExtension',
                    template: '',
                }]
        }], ctorParameters: function () { return [{ type: i1.Page, decorators: [{
                    type: Optional
                }] }]; } });
export class ActionItemDirective {
    constructor(element, ownerScope) {
        this.element = element;
        this.ownerScope = ownerScope;
        if (this.ownerScope) {
            this.ownerScope.onActionInit(this);
        }
    }
    ngOnDestroy() {
        if (this.ownerScope) {
            this.ownerScope.onActionDestroy(this);
        }
    }
}
ActionItemDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionItemDirective, deps: [{ token: i0.ElementRef }, { token: ActionBarScope, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
ActionItemDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.2.3", type: ActionItemDirective, selector: "ActionItem", ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ActionItemDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ActionItem', // tslint:disable-line:directive-selector
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: ActionBarScope, decorators: [{
                    type: Optional
                }] }]; } });
export class NavigationButtonDirective {
    constructor(element, ownerScope) {
        this.element = element;
        this.ownerScope = ownerScope;
        if (this.ownerScope) {
            this.ownerScope.onNavButtonInit(this);
        }
    }
    ngOnDestroy() {
        if (this.ownerScope) {
            this.ownerScope.onNavButtonDestroy(this);
        }
    }
}
NavigationButtonDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: NavigationButtonDirective, deps: [{ token: i0.ElementRef }, { token: ActionBarScope, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
NavigationButtonDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.2.3", type: NavigationButtonDirective, selector: "NavigationButton", ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: NavigationButtonDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'NavigationButton', // tslint:disable-line:directive-selector
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: ActionBarScope, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvY2RrL2FjdGlvbi1iYXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RixPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBZSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVoRyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFbEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7OztBQUV6RCxNQUFNLFVBQVUsWUFBWSxDQUFDLElBQVM7SUFDcEMsT0FBTyxJQUFJLFlBQVksVUFBVSxDQUFDO0FBQ3BDLENBQUM7QUFFRCxNQUFNLFVBQVUsa0JBQWtCLENBQUMsSUFBUztJQUMxQyxPQUFPLElBQUksWUFBWSxnQkFBZ0IsQ0FBQztBQUMxQyxDQUFDO0FBSUQsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFrQjtJQUMxQyxZQUFZLEVBQUUsSUFBSTtJQUNsQixXQUFXLEVBQUUsQ0FBQyxNQUFtQixFQUFFLEtBQWEsRUFBRSxJQUFTLEVBQUUsRUFBRTtRQUM3RCxJQUFJLGVBQWUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixPQUFPO1NBQ1I7YUFBTSxJQUFJLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3BDLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7WUFDaEMsS0FBSyxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUM7U0FDM0I7YUFBTSxJQUFJLFlBQVksQ0FBQyxLQUFLLENBQUMsRUFB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ZUFBVSxHQUFWLFVBQVUsQ0FBZ0I7UUFDcEYsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQztJQUNILENBQUM7O3NIQVhVLHlCQUF5QjswR0FBekIseUJBQXlCOzJGQUF6Qix5QkFBeUI7a0JBSHJDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGtCQUFrQixFQUFFLHlDQUF5QztpQkFDeEU7OzBCQUUwQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIE9wdGlvbmFsLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGlvbkJhciwgQWN0aW9uSXRlbSwgQWN0aW9uSXRlbXMsIE5hdmlnYXRpb25CdXR0b24sIFBhZ2UgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuXG5pbXBvcnQgeyBpc0JsYW5rIH0gZnJvbSAnLi4vLi4vdXRpbHMvbGFuZy1mYWNhZGUnO1xuaW1wb3J0IHsgTmdWaWV3LCBWaWV3Q2xhc3NNZXRhLCBWaWV3RXh0ZW5zaW9ucyB9IGZyb20gJy4uLy4uL3ZpZXdzL3ZpZXctdHlwZXMnO1xuaW1wb3J0IHsgaXNJbnZpc2libGVOb2RlLCBpc1ZpZXcgfSBmcm9tICcuLi8uLi92aWV3cy91dGlscyc7XG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tICcuLi8uLi9lbGVtZW50LXJlZ2lzdHJ5JztcblxuZXhwb3J0IGZ1bmN0aW9uIGlzQWN0aW9uSXRlbSh2aWV3OiBhbnkpOiB2aWV3IGlzIEFjdGlvbkl0ZW0ge1xuICByZXR1cm4gdmlldyBpbnN0YW5jZW9mIEFjdGlvbkl0ZW07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc05hdmlnYXRpb25CdXR0b24odmlldzogYW55KTogdmlldyBpcyBOYXZpZ2F0aW9uQnV0dG9uIHtcbiAgcmV0dXJuIHZpZXcgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uQnV0dG9uO1xufVxuXG50eXBlIE5nQWN0aW9uQmFyID0gQWN0aW9uQmFyICYgVmlld0V4dGVuc2lvbnM7XG5cbmV4cG9ydCBjb25zdCBhY3Rpb25CYXJNZXRhOiBWaWV3Q2xhc3NNZXRhID0ge1xuICBza2lwQWRkVG9Eb206IHRydWUsXG4gIGluc2VydENoaWxkOiAocGFyZW50OiBOZ0FjdGlvbkJhciwgY2hpbGQ6IE5nVmlldywgbmV4dDogYW55KSA9PiB7XG4gICAgaWYgKGlzSW52aXNpYmxlTm9kZShjaGlsZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGlzTmF2aWdhdGlvbkJ1dHRvbihjaGlsZCkpIHtcbiAgICAgIHBhcmVudC5uYXZpZ2F0aW9uQnV0dG9uID0gY2hpbGQ7XG4gICAgICBjaGlsZC5wYXJlbnROb2RlID0gcGFyZW50O1xuICAgIH0gZWxzZSBpZiAoaXNBY3Rpb25JdGVtKGNoaWxkKSkge1xuICAgICAgYWRkQWN0aW9uSXRlbShwYXJlbnQsIGNoaWxkLCBuZXh0KTtcbiAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBwYXJlbnQ7XG4gICAgfSBlbHNlIGlmIChpc1ZpZXcoY2hpbGQpKSB7XG4gICAgICBwYXJlbnQudGl0bGVWaWV3ID0gY2hpbGQ7XG4gICAgfVxuICB9LFxuICByZW1vdmVDaGlsZDogKHBhcmVudDogTmdBY3Rpb25CYXIsIGNoaWxkOiBOZ1ZpZXcpID0+IHtcbiAgICBpZiAoaXNJbnZpc2libGVOb2RlKGNoaWxkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoaXNOYXZpZ2F0aW9uQnV0dG9uKGNoaWxkKSkge1xuICAgICAgaWYgKHBhcmVudC5uYXZpZ2F0aW9uQnV0dG9uID09PSBjaGlsZCkge1xuICAgICAgICBwYXJlbnQubmF2aWdhdGlvbkJ1dHRvbiA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAoaXNBY3Rpb25JdGVtKGNoaWxkKSkge1xuICAgICAgcGFyZW50LmFjdGlvbkl0ZW1zLnJlbW92ZUl0ZW0oY2hpbGQpO1xuICAgICAgY2hpbGQucGFyZW50Tm9kZSA9IG51bGw7XG4gICAgfSBlbHNlIGlmIChpc1ZpZXcoY2hpbGQpICYmIHBhcmVudC50aXRsZVZpZXcgJiYgcGFyZW50LnRpdGxlVmlldyA9PT0gY2hpbGQpIHtcbiAgICAgIHBhcmVudC50aXRsZVZpZXcgPSBudWxsO1xuICAgIH1cbiAgfSxcbn07XG5cbnJlZ2lzdGVyRWxlbWVudCgnQWN0aW9uQmFyJywgKCkgPT4gQWN0aW9uQmFyLCBhY3Rpb25CYXJNZXRhKTtcbnJlZ2lzdGVyRWxlbWVudCgnQWN0aW9uSXRlbScsICgpID0+IDxhbnk+QWN0aW9uSXRlbSk7XG5yZWdpc3RlckVsZW1lbnQoJ05hdmlnYXRpb25CdXR0b24nLCAoKSA9PiA8YW55Pk5hdmlnYXRpb25CdXR0b24pO1xuXG5jb25zdCBhZGRBY3Rpb25JdGVtID0gKGJhcjogTmdBY3Rpb25CYXIsIGl0ZW06IEFjdGlvbkl0ZW0sIG5leHQ6IEFjdGlvbkl0ZW0pID0+IHtcbiAgaWYgKG5leHQpIHtcbiAgICBpbnNlcnRBY3Rpb25JdGVtQmVmb3JlKGJhciwgaXRlbSwgbmV4dCk7XG4gIH0gZWxzZSB7XG4gICAgYXBwZW5kQWN0aW9uSXRlbShiYXIsIGl0ZW0pO1xuICB9XG59O1xuXG5jb25zdCBpbnNlcnRBY3Rpb25JdGVtQmVmb3JlID0gKGJhcjogTmdBY3Rpb25CYXIsIGl0ZW06IEFjdGlvbkl0ZW0sIG5leHQ6IEFjdGlvbkl0ZW0pID0+IHtcbiAgY29uc3QgYWN0aW9uSXRlbXM6IEFjdGlvbkl0ZW1zID0gYmFyLmFjdGlvbkl0ZW1zO1xuICBjb25zdCBhY3Rpb25JdGVtc0NvbGxlY3Rpb246IEFjdGlvbkl0ZW1bXSA9IGFjdGlvbkl0ZW1zLmdldEl0ZW1zKCk7XG5cbiAgY29uc3QgaW5kZXhUb0luc2VydCA9IGFjdGlvbkl0ZW1zQ29sbGVjdGlvbi5pbmRleE9mKG5leHQpO1xuICBhY3Rpb25JdGVtc0NvbGxlY3Rpb24uc3BsaWNlKGluZGV4VG9JbnNlcnQsIDAsIGl0ZW0pO1xuXG4gICg8YW55PmFjdGlvbkl0ZW1zKS5zZXRJdGVtcyhhY3Rpb25JdGVtc0NvbGxlY3Rpb24pO1xufTtcblxuY29uc3QgYXBwZW5kQWN0aW9uSXRlbSA9IChiYXI6IE5nQWN0aW9uQmFyLCBpdGVtOiBBY3Rpb25JdGVtKSA9PiB7XG4gIGJhci5hY3Rpb25JdGVtcy5hZGRJdGVtKGl0ZW0pO1xufTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnQWN0aW9uQmFyJyxcbiAgdGVtcGxhdGU6ICc8bmctY29udGVudD48L25nLWNvbnRlbnQ+Jyxcbn0pXG5leHBvcnQgY2xhc3MgQWN0aW9uQmFyQ29tcG9uZW50IHtcbiAgY29uc3RydWN0b3IocHVibGljIGVsZW1lbnQ6IEVsZW1lbnRSZWYsIEBPcHRpb25hbCgpIHByaXZhdGUgcGFnZTogUGFnZSkge1xuICAgIGlmICghdGhpcy5wYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIFBhZ2UgZm91bmQgaW4gQWN0aW9uQmFyQ29tcG9uZW50LlxcbicgKyAnT25seSBhIFBhZ2UgY2FuIGNvbnRhaW4gYW4gQWN0aW9uQmFyLCBzbyBwbGVhc2UgZW5zdXJlIEFjdGlvbkJhciBpcyBvbmx5IHVzZWQgaW5zaWRlIGEgQ29tcG9uZW50IHRoYXQgaXMgcm91dGVkIHZpYSBwYWdlLXJvdXRlci1vdXRsZXQgb3IgaXMgY29udGFpbmVkIGluIGEgUGFnZS5cXG4nICsgJ0V4YW1wbGUgZm9yIHJvb3QgYWN0aW9uIGJhcnMgaW4gQXBwQ29tcG9uZW50OiA8RnJhbWU+PFBhZ2U+PEFjdGlvbkJhcj4uLi4uPC9BY3Rpb25CYXI+PC9QYWdlPjwvRnJhbWU+Jyk7XG4gICAgfVxuXG4gICAgaWYgKGlzQmxhbmsodGhpcy5wYWdlLmFjdGlvbkJhckhpZGRlbikpIHtcbiAgICAgIHRoaXMucGFnZS5hY3Rpb25CYXJIaWRkZW4gPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5wYWdlLmFjdGlvbkJhciA9IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgIHRoaXMucGFnZS5hY3Rpb25CYXIudXBkYXRlKCk7XG4gIH1cbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnQWN0aW9uQmFyRXh0ZW5zaW9uJyxcbiAgdGVtcGxhdGU6ICcnLFxufSlcbmV4cG9ydCBjbGFzcyBBY3Rpb25CYXJTY29wZSB7XG4gIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6Y29tcG9uZW50LWNsYXNzLXN1ZmZpeFxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIHBhZ2U6IFBhZ2UpIHtcbiAgICBpZiAoIXRoaXMucGFnZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnNpZGUgQWN0aW9uQmFyRXh0ZW5zaW9uIGJ1dCBubyBBY3Rpb25CYXIgZm91bmQgdG8gZXh0ZW5kLicpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbk5hdkJ1dHRvbkluaXQobmF2QnRuOiBOYXZpZ2F0aW9uQnV0dG9uRGlyZWN0aXZlKSB7XG4gICAgdGhpcy5wYWdlLmFjdGlvbkJhci5uYXZpZ2F0aW9uQnV0dG9uID0gbmF2QnRuLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIHB1YmxpYyBvbk5hdkJ1dHRvbkRlc3Ryb3kobmF2QnRuOiBOYXZpZ2F0aW9uQnV0dG9uRGlyZWN0aXZlKSB7XG4gICAgY29uc3QgbmF2ID0gPE5hdmlnYXRpb25CdXR0b24+bmF2QnRuLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICBpZiAobmF2ICYmIHRoaXMucGFnZS5hY3Rpb25CYXIubmF2aWdhdGlvbkJ1dHRvbiA9PT0gbmF2KSB7XG4gICAgICB0aGlzLnBhZ2UuYWN0aW9uQmFyLm5hdmlnYXRpb25CdXR0b24gPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbkFjdGlvbkluaXQoaXRlbTogQWN0aW9uSXRlbURpcmVjdGl2ZSkge1xuICAgIHRoaXMucGFnZS5hY3Rpb25CYXIuYWN0aW9uSXRlbXMuYWRkSXRlbShpdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICBwdWJsaWMgb25BY3Rpb25EZXN0cm95KGl0ZW06IEFjdGlvbkl0ZW1EaXJlY3RpdmUpIHtcbiAgICBpZiAoaXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuYWN0aW9uQmFyKSB7XG4gICAgICB0aGlzLnBhZ2UuYWN0aW9uQmFyLmFjdGlvbkl0ZW1zLnJlbW92ZUl0ZW0oaXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgfVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdBY3Rpb25JdGVtJywgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3Jcbn0pXG5leHBvcnQgY2xhc3MgQWN0aW9uSXRlbURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbGVtZW50OiBFbGVtZW50UmVmLCBAT3B0aW9uYWwoKSBwcml2YXRlIG93bmVyU2NvcGU6IEFjdGlvbkJhclNjb3BlKSB7XG4gICAgaWYgKHRoaXMub3duZXJTY29wZSkge1xuICAgICAgdGhpcy5vd25lclNjb3BlLm9uQWN0aW9uSW5pdCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5vd25lclNjb3BlKSB7XG4gICAgICB0aGlzLm93bmVyU2NvcGUub25BY3Rpb25EZXN0cm95KHRoaXMpO1xuICAgIH1cbiAgfVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdOYXZpZ2F0aW9uQnV0dG9uJywgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3Jcbn0pXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbkJ1dHRvbkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbGVtZW50OiBFbGVtZW50UmVmLCBAT3B0aW9uYWwoKSBwcml2YXRlIG93bmVyU2NvcGU6IEFjdGlvbkJhclNjb3BlKSB7XG4gICAgaWYgKHRoaXMub3duZXJTY29wZSkge1xuICAgICAgdGhpcy5vd25lclNjb3BlLm9uTmF2QnV0dG9uSW5pdCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5vd25lclNjb3BlKSB7XG4gICAgICB0aGlzLm93bmVyU2NvcGUub25OYXZCdXR0b25EZXN0cm95KHRoaXMpO1xuICAgIH1cbiAgfVxufVxuIl19