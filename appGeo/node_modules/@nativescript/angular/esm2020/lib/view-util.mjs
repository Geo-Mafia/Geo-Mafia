import { unsetValue } from '@nativescript/core';
import { getViewClass, getViewMeta, isKnownView } from './element-registry';
import { CommentNode, TextNode, isDetachedElement, isInvisibleNode, isView, isContentView, isLayout } from './views';
import { NativeScriptDebug } from './trace';
// Note: this utility exists from deep core import however results in
// Module not found: Error: Can't resolve '@nativescript/core/ui/core/properties'
function isCssVariable(property) {
    return /^--[^,\s]+?$/.test(property);
}
const ELEMENT_NODE_TYPE = 1;
const XML_ATTRIBUTES = Object.freeze(['style', 'rows', 'columns', 'fontAttributes']);
const whiteSpaceSplitter = /\s+/;
function printNgTree(view) {
    let parent = view;
    while (parent.parent && parent.parent.firstChild) {
        parent = parent.parent;
    }
    printChildrenRecurse(parent);
}
function printChildrenRecurse(parent) {
    const children = parent.firstChild ? [parent.firstChild, ...getChildrenSiblings(parent.firstChild).nextSiblings] : [];
    console.log(`parent: ${parent}, firstChild: ${parent.firstChild}, lastChild: ${parent.lastChild} children: ${children}`);
    if (parent.firstChild) {
        console.log(`----- start ${parent}`);
    }
    children.forEach((c) => printChildrenRecurse(c));
    if (parent.firstChild) {
        console.log(`----- end ${parent}`);
    }
}
function getChildrenSiblings(view) {
    const nextSiblings = [];
    const previousSiblings = [];
    let sibling = view.nextSibling;
    while (sibling) {
        nextSiblings.push(sibling);
        sibling = sibling.nextSibling;
    }
    sibling = view.previousSibling;
    while (sibling) {
        previousSiblings.push(sibling);
        sibling = sibling.previousSibling;
    }
    return {
        previousSiblings,
        nextSiblings,
    };
}
function printSiblingsTree(view) {
    const { previousSiblings, nextSiblings } = getChildrenSiblings(view);
    console.log(`${view} previousSiblings: ${previousSiblings} nextSiblings: ${nextSiblings}`);
}
const propertyMaps = new Map();
export class ViewUtil {
    constructor(namespaceFilters, reuseViews) {
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
    }
    /**
     * Inserts a child into a parrent, preferably before next.
     * @param parent parent view
     * @param child child view to be added
     * @param previous previous element. If present, insert after this.
     * @param next next element. If present, insert before this (previous is ignored).
     */
    insertChild(parent, child, previous, next) {
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        // this should never enter, as angular is supposed to remove the child from the previous parent before calling this
        // but when angular animations are enabled, the removal might be delayed, so we need to ensure this view is not anywhere
        // this seems to only happens to CommentNodes
        if (extendedChild.parentNode) {
            this.removeChild(extendedChild.parentNode, extendedChild);
        }
        // if there's a next child, previous is the previousSibling of it
        if (next) {
            previous = next.previousSibling;
        }
        else if (previous) {
            // if there's a previous, next is the nextSibling of it
            next = previous.nextSibling;
        }
        else {
            // no previous or next, append to the parent
            previous = extendedParent.lastChild; // this can still be undefined if the parent has no children!
        }
        this.insertInList(extendedParent, extendedChild, previous, next);
        if (isDetachedElement(child) || isInvisibleNode(child)) {
            extendedChild.parentNode = extendedParent;
        }
        if (!isDetachedElement(child)) {
            const nextVisual = this.findNextVisual(next);
            this.addToVisualTree(extendedParent, extendedChild, nextVisual);
        }
        else if (isInvisibleNode(extendedChild)) {
            const nextVisual = this.findNextVisual(next);
            this.addInvisibleNode(extendedParent, extendedChild, nextVisual);
        }
        // printNgTree(extendedChild);
    }
    insertBefore(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, undefined, extendedRef);
    }
    insertAfter(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, extendedRef);
    }
    appendChild(parent, child) {
        this.insertChild(parent, child);
    }
    /**
     * Inserts a view into the parent/sibling linked list
     * !WARNING: this method makes no checks to validate the integrity of previous/next children
     * @param parent parent view
     * @param child child view
     * @param previous previous element. null/undefined for first element
     * @param next next element. null/undefined for last element
     */
    insertInList(parent, child, previous, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.insertInList parent: ${parent}, view: ${child}, ` + `previous: ${previous}, next: ${next}`);
        }
        if (previous) {
            previous.nextSibling = child;
            child.previousSibling = previous;
        }
        else {
            parent.firstChild = child;
        }
        if (next) {
            child.nextSibling = next;
            next.previousSibling = child;
        }
        else {
            parent.lastChild = child;
        }
    }
    addToVisualTree(parent, child, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToVisualTree parent: ${parent}, view: ${child}, next: ${next}`);
        }
        if (parent.meta && parent.meta.insertChild) {
            parent.meta.insertChild(parent, child, next);
        }
        else if (isLayout(parent)) {
            this.insertToLayout(parent, child, next);
        }
        else if (isContentView(parent)) {
            parent.content = child;
        }
        else if (parent && parent._addChildFromBuilder) {
            parent._addChildFromBuilder(child.nodeName, child);
        }
    }
    addInvisibleNode(parent, child, next) {
        if (parent.meta?.insertInvisibleNode) {
            parent.meta.insertInvisibleNode(parent, child, next);
        }
        else {
            if (child instanceof TextNode) {
                parent.text = child.text;
                child.registerTextChange((t) => (parent.text = t), parent);
            }
        }
    }
    insertToLayout(parent, child, next) {
        if (child.parent === parent) {
            this.removeLayoutChild(parent, child);
        }
        const nextVisual = this.findNextVisual(next);
        if (nextVisual) {
            const index = parent.getChildIndex(nextVisual);
            parent.insertChild(child, index);
        }
        else {
            parent.addChild(child);
        }
        // parent.eachChild((c) => {console.log(c); return true});
    }
    findNextVisual(view) {
        let next = view;
        while (next && isDetachedElement(next)) {
            next = next.nextSibling;
        }
        return next;
    }
    removeChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeChild parent: ${parent} child: ${child}`);
        }
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        extendedChild.parentNode = null;
        this.removeFromList(extendedParent, extendedChild);
        if (!isDetachedElement(extendedChild)) {
            this.removeFromVisualTree(extendedParent, extendedChild);
        }
        else if (isInvisibleNode(extendedChild)) {
            this.removeInvisibleNode(extendedParent, extendedChild);
        }
    }
    removeFromList(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromList parent: ${parent} child: ${child}`);
        }
        // only child. null everything
        if (parent.firstChild === child && parent.lastChild === child) {
            parent.firstChild = null;
            parent.lastChild = null;
            child.nextSibling = null;
            child.previousSibling = null;
            return;
        }
        const previous = child.previousSibling;
        const next = child.nextSibling;
        // is first child, make the next sibling the first child (can be null)
        if (parent.firstChild === child) {
            parent.firstChild = next;
        }
        // is last child, make the previous sibling the last child (can be null)
        if (parent.lastChild === child) {
            parent.lastChild = previous;
        }
        // we have a previous sibling, make it point to the next sibling
        if (previous) {
            previous.nextSibling = next;
        }
        // we have a next sibling, make it point to the previous
        if (next) {
            next.previousSibling = previous;
        }
        // finally, null the siblings
        child.nextSibling = null;
        child.previousSibling = null;
    }
    // NOTE: This one is O(n) - use carefully
    findPreviousElement(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.findPreviousElement parent: ${parent} child: ${child}`);
        }
        let previousVisual;
        if (isLayout(parent)) {
            previousVisual = this.getPreviousVisualElement(parent, child);
        }
        let previous = previousVisual || parent.firstChild;
        // since detached elements are not added to the visual tree,
        // we need to find the actual previous sibling of the view,
        // which may as well be an invisible node
        while (previous && previous !== child && previous.nextSibling !== child) {
            previous = previous.nextSibling;
        }
        return previous;
    }
    getPreviousVisualElement(parent, child) {
        const elementIndex = parent.getChildIndex(child);
        if (elementIndex > 0) {
            return parent.getChildAt(elementIndex - 1);
        }
    }
    // NOTE: This one is O(n) - use carefully
    getChildIndex(parent, child) {
        if (isLayout(parent)) {
            return parent.getChildIndex(child);
        }
        else if (isContentView(parent)) {
            return child === parent.content ? 0 : -1;
        }
    }
    removeFromVisualTree(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromVisualTree parent: ${parent} child: ${child}`);
        }
        if (parent.meta && parent.meta.removeChild) {
            parent.meta.removeChild(parent, child);
        }
        else if (isLayout(parent)) {
            this.removeLayoutChild(parent, child);
        }
        else if (isContentView(parent) && parent.content === child) {
            parent.content = null;
        }
        else if (isView(parent)) {
            parent._removeView(child);
        }
    }
    removeInvisibleNode(parent, child) {
        if (parent.meta?.removeInvisibleNode) {
            parent.meta.removeInvisibleNode(parent, child);
        }
        else {
            if (child instanceof TextNode) {
                child.unregisterTextChange(parent);
            }
        }
    }
    removeLayoutChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeLayoutChild parent: ${parent} child: ${child}`);
        }
        const index = parent.getChildIndex(child);
        if (index !== -1) {
            parent.removeChild(child);
        }
    }
    createComment(value) {
        return new CommentNode(value);
    }
    createText(value) {
        return new TextNode(value);
    }
    createView(name) {
        const originalName = name;
        if (!isKnownView(name)) {
            name = 'ProxyViewContainer';
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Creating view: ${originalName} ${name}`);
        }
        const viewClass = getViewClass(name);
        const view = new viewClass();
        const ngView = this.setNgViewExtensions(view, name);
        ngView.reusable = !!this.reuseViews;
        return ngView;
    }
    ensureNgViewExtensions(view) {
        if (view.hasOwnProperty('meta')) {
            return view;
        }
        else {
            const name = view.cssType;
            const ngView = this.setNgViewExtensions(view, name);
            return ngView;
        }
    }
    setNgViewExtensions(view, name) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Make into a NgView view: ${view} name: "${name}"`);
        }
        const ngView = view;
        ngView.nodeName = name;
        ngView.meta = getViewMeta(name);
        // we're setting the node type of the view
        // to 'element' because of checks done in the
        // dom animation engine
        ngView.nodeType = ELEMENT_NODE_TYPE;
        return ngView;
    }
    setProperty(view, attributeName, value, namespace) {
        if (!view || (namespace && !this.runsIn(namespace))) {
            return;
        }
        if (attributeName.indexOf('.') !== -1) {
            // Handle nested properties
            const properties = attributeName.split('.');
            attributeName = properties[properties.length - 1];
            let propMap = this.getProperties(view);
            let i = 0;
            while (i < properties.length - 1 && typeof view !== 'undefined') {
                let prop = properties[i];
                if (propMap.has(prop)) {
                    prop = propMap.get(prop);
                }
                view = view[prop];
                propMap = this.getProperties(view);
                i++;
            }
        }
        if (typeof view !== 'undefined') {
            this.setPropertyInternal(view, attributeName, value);
        }
    }
    runsIn(platform) {
        let runs = true;
        const last = () => true;
        if (this.namespaceFilters) {
            let chain = (p) => true;
            for (let i = this.namespaceFilters.length - 1; i >= 0; i--) {
                const currentChain = chain;
                chain = (p) => this.namespaceFilters[i].runsIn(p, currentChain);
            }
            runs = chain(platform);
            runs = runs !== false ? true : false; // undefined means true
            // this.namespaceFilters.some((filter) => {
            // 	const runsInFilter = filter.runsIn(platform);
            // 	if (runsInFilter !== undefined) {
            // 		runs = runsInFilter;
            // 		return true;
            // 	}
            // });
        }
        return runs;
    }
    setPropertyInternal(view, attributeName, value) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Setting attribute: ${attributeName}=${value} to ${view}`);
        }
        if (attributeName === 'class') {
            this.setClasses(view, value);
            return;
        }
        if (XML_ATTRIBUTES.indexOf(attributeName) !== -1) {
            view[attributeName] = value;
            return;
        }
        const propMap = this.getProperties(view);
        const propertyName = propMap.get(attributeName);
        // Ensure the children of a collection currently have no parent set.
        if (Array.isArray(value)) {
            this.removeParentReferencesFromItems(value);
        }
        if (propertyName) {
            // We have a lower-upper case mapped property.
            view[propertyName] = value;
            return;
        }
        // Unknown attribute value -- just set it to our object as is.
        view[attributeName] = value;
    }
    removeParentReferencesFromItems(items) {
        for (const item of items) {
            if (item.parent && item.parentNode) {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.viewUtilLog(`Unassigning parent ${item.parentNode} on value: ${item}`);
                }
                item.parent = undefined;
                item.parentNode = undefined;
            }
        }
    }
    getProperties(instance) {
        const type = instance && instance.constructor;
        if (!type) {
            return new Map();
        }
        if (!propertyMaps.has(type)) {
            let propMap = new Map();
            for (let propName in instance) {
                // tslint:disable:forin
                propMap.set(propName.toLowerCase(), propName);
            }
            propertyMaps.set(type, propMap);
        }
        return propertyMaps.get(type);
    }
    cssClasses(view) {
        if (!view.ngCssClasses) {
            view.ngCssClasses = new Map();
        }
        return view.ngCssClasses;
    }
    addClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).set(className, true);
        this.syncClasses(extendedView);
    }
    removeClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).delete(className);
        this.syncClasses(extendedView);
    }
    setClasses(view, classesValue) {
        let classes = classesValue.split(whiteSpaceSplitter);
        this.cssClasses(view).clear();
        classes.forEach((className) => this.cssClasses(view).set(className, true));
        this.syncClasses(view);
    }
    syncClasses(view) {
        let classValue = Array.from(this.cssClasses(view).keys()).join(' ');
        view.className = classValue;
    }
    setStyle(view, styleName, value) {
        if (isCssVariable(styleName)) {
            view.style.setUnscopedCssVariable(styleName, value);
            view._onCssStateChange();
        }
        else {
            view.style[styleName] = value;
        }
    }
    removeStyle(view, styleName) {
        if (isCssVariable(styleName)) {
            // TODO: expose this on core
            view.style.unscopedCssVariables.delete(styleName);
            view._onCssStateChange();
        }
        else {
            view.style[styleName] = unsetValue;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL3ZpZXctdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVEsVUFBVSxFQUE0RCxNQUFNLG9CQUFvQixDQUFDO0FBQ2hILE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxXQUFXLEVBQVUsUUFBUSxFQUFrQixpQkFBaUIsRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHN0ksT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRzVDLHFFQUFxRTtBQUNyRSxpRkFBaUY7QUFDakYsU0FBUyxhQUFhLENBQUMsUUFBZ0I7SUFDckMsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQztBQUM1QixNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO0FBQ3JGLE1BQU0sa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0FBSWpDLFNBQVMsV0FBVyxDQUFDLElBQVk7SUFDL0IsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ2xCLE9BQU8sTUFBTSxDQUFDLE1BQU0sSUFBSyxNQUFNLENBQUMsTUFBaUIsQ0FBQyxVQUFVLEVBQUU7UUFDNUQsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFnQixDQUFDO0tBQ2xDO0lBQ0Qsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQUNELFNBQVMsb0JBQW9CLENBQUMsTUFBYztJQUMxQyxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN0SCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsTUFBTSxpQkFBaUIsTUFBTSxDQUFDLFVBQVUsZ0JBQWdCLE1BQU0sQ0FBQyxTQUFTLGNBQWMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUN6SCxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7UUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLE1BQU0sRUFBRSxDQUFDLENBQUM7S0FDdEM7SUFDRCxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRTtRQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsTUFBTSxFQUFFLENBQUMsQ0FBQztLQUNwQztBQUNILENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLElBQVk7SUFDdkMsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0lBQzVCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDL0IsT0FBTyxPQUFPLEVBQUU7UUFDZCxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO0tBQy9CO0lBQ0QsT0FBTyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDL0IsT0FBTyxPQUFPLEVBQUU7UUFDZCxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0IsT0FBTyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7S0FDbkM7SUFDRCxPQUFPO1FBQ0wsZ0JBQWdCO1FBQ2hCLFlBQVk7S0FDYixDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsSUFBWTtJQUNyQyxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksc0JBQXNCLGdCQUFnQixrQkFBa0IsWUFBWSxFQUFFLENBQUMsQ0FBQztBQUM3RixDQUFDO0FBRUQsTUFBTSxZQUFZLEdBQXVDLElBQUksR0FBRyxFQUFpQyxDQUFDO0FBRWxHLE1BQU0sT0FBTyxRQUFRO0lBQ25CLFlBQW9CLGdCQUFvQyxFQUFVLFVBQW9CO1FBQWxFLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFVO0lBQUcsQ0FBQztJQUMxRjs7Ozs7O09BTUc7SUFDSyxXQUFXLENBQUMsTUFBWSxFQUFFLEtBQVcsRUFBRSxRQUFpQixFQUFFLElBQWE7UUFDN0UsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE9BQU87U0FDUjtRQUVELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFekQsbUhBQW1IO1FBQ25ILHdIQUF3SDtRQUN4SCw2Q0FBNkM7UUFDN0MsSUFBSSxhQUFhLENBQUMsVUFBVSxFQUFFO1lBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUMzRDtRQUNELGlFQUFpRTtRQUNqRSxJQUFJLElBQUksRUFBRTtZQUNSLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO1NBQ2pDO2FBQU0sSUFBSSxRQUFRLEVBQUU7WUFDbkIsdURBQXVEO1lBQ3ZELElBQUksR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDO1NBQzdCO2FBQU07WUFDTCw0Q0FBNEM7WUFDNUMsUUFBUSxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyw2REFBNkQ7U0FDbkc7UUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRWpFLElBQUksaUJBQWlCLENBQUMsS0FBSyxDQUFDLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3RELGFBQWEsQ0FBQyxVQUFVLEdBQUcsY0FBYyxDQUFDO1NBQzNDO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzdCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsYUFBYSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQ2pFO2FBQU0sSUFBSSxlQUFlLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDekMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQztTQUNsRTtRQUNELDhCQUE4QjtJQUNoQyxDQUFDO0lBRU0sWUFBWSxDQUFDLE1BQVksRUFBRSxLQUFXLEVBQUUsUUFBd0I7UUFDckUsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNqRixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFDTSxXQUFXLENBQUMsTUFBWSxFQUFFLEtBQVcsRUFBRSxRQUF3QjtRQUNwRSxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2pGLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0sV0FBVyxDQUFDLE1BQVksRUFBRSxLQUFXO1FBQzFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssWUFBWSxDQUFDLE1BQWMsRUFBRSxLQUFhLEVBQUUsUUFBZ0IsRUFBRSxJQUFZO1FBQ2hGLElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLGlDQUFpQyxNQUFNLFdBQVcsS0FBSyxJQUFJLEdBQUcsYUFBYSxRQUFRLFdBQVcsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNySTtRQUVELElBQUksUUFBUSxFQUFFO1lBQ1osUUFBUSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7WUFDN0IsS0FBSyxDQUFDLGVBQWUsR0FBRyxRQUFRLENBQUM7U0FDbEM7YUFBTTtZQUNMLE1BQU0sQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1NBQzNCO1FBRUQsSUFBSSxJQUFJLEVBQUU7WUFDUixLQUFLLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztZQUN6QixJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztTQUM5QjthQUFNO1lBQ0wsTUFBTSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRU8sZUFBZSxDQUFDLE1BQWMsRUFBRSxLQUFhLEVBQUUsSUFBWTtRQUNqRSxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxvQ0FBb0MsTUFBTSxXQUFXLEtBQUssV0FBVyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQzVHO1FBRUQsSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUM7YUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUMzQixJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUM7YUFBTSxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNoQyxNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztTQUN4QjthQUFNLElBQUksTUFBTSxJQUFVLE1BQU8sQ0FBQyxvQkFBb0IsRUFBRTtZQUNqRCxNQUFPLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRDtJQUNILENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxNQUFjLEVBQUUsS0FBYSxFQUFFLElBQVk7UUFDbEUsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLG1CQUFtQixFQUFFO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN0RDthQUFNO1lBQ0wsSUFBSSxLQUFLLFlBQVksUUFBUSxFQUFFO2dCQUM1QixNQUFjLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7Z0JBQ2xDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBRSxNQUFjLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ3JFO1NBQ0Y7SUFDSCxDQUFDO0lBRU8sY0FBYyxDQUFDLE1BQW9CLEVBQUUsS0FBYSxFQUFFLElBQVk7UUFDdEUsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QyxJQUFJLFVBQVUsRUFBRTtZQUNkLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDL0MsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDbEM7YUFBTTtZQUNMLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEI7UUFDRCwwREFBMEQ7SUFDNUQsQ0FBQztJQUVPLGNBQWMsQ0FBQyxJQUFZO1FBQ2pDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUNoQixPQUFPLElBQUksSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN0QyxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztTQUN6QjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQUFZLEVBQUUsS0FBVztRQUMxQyxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxnQ0FBZ0MsTUFBTSxXQUFXLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDekY7UUFFRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTztTQUNSO1FBRUQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6RCxhQUFhLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUVoQyxJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUMxRDthQUFNLElBQUksZUFBZSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQ3pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7U0FDekQ7SUFDSCxDQUFDO0lBRU8sY0FBYyxDQUFDLE1BQWMsRUFBRSxLQUFhO1FBQ2xELElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLG1DQUFtQyxNQUFNLFdBQVcsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUM1RjtRQUVELDhCQUE4QjtRQUM5QixJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssS0FBSyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssS0FBSyxFQUFFO1lBQzdELE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLEtBQUssQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLEtBQUssQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1lBQzdCLE9BQU87U0FDUjtRQUVELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDdkMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztRQUMvQixzRUFBc0U7UUFDdEUsSUFBSSxNQUFNLENBQUMsVUFBVSxLQUFLLEtBQUssRUFBRTtZQUMvQixNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztTQUMxQjtRQUVELHdFQUF3RTtRQUN4RSxJQUFJLE1BQU0sQ0FBQyxTQUFTLEtBQUssS0FBSyxFQUFFO1lBQzlCLE1BQU0sQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1NBQzdCO1FBRUQsZ0VBQWdFO1FBQ2hFLElBQUksUUFBUSxFQUFFO1lBQ1osUUFBUSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDN0I7UUFFRCx3REFBd0Q7UUFDeEQsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQztTQUNqQztRQUVELDZCQUE2QjtRQUM3QixLQUFLLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN6QixLQUFLLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztJQUMvQixDQUFDO0lBRUQseUNBQXlDO0lBQ2pDLG1CQUFtQixDQUFDLE1BQWMsRUFBRSxLQUFhO1FBQ3ZELElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLHdDQUF3QyxNQUFNLFdBQVcsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNqRztRQUVELElBQUksY0FBYyxDQUFDO1FBQ25CLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BCLGNBQWMsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQy9EO1FBRUQsSUFBSSxRQUFRLEdBQUcsY0FBYyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUM7UUFFbkQsNERBQTREO1FBQzVELDJEQUEyRDtRQUMzRCx5Q0FBeUM7UUFDekMsT0FBTyxRQUFRLElBQUksUUFBUSxLQUFLLEtBQUssSUFBSSxRQUFRLENBQUMsV0FBVyxLQUFLLEtBQUssRUFBRTtZQUN2RSxRQUFRLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQztTQUNqQztRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxNQUFvQixFQUFFLEtBQWE7UUFDbEUsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVqRCxJQUFJLFlBQVksR0FBRyxDQUFDLEVBQUU7WUFDcEIsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQVcsQ0FBQztTQUN0RDtJQUNILENBQUM7SUFFRCx5Q0FBeUM7SUFDbEMsYUFBYSxDQUFDLE1BQVcsRUFBRSxLQUFhO1FBQzdDLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BCLE9BQU8sTUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwQzthQUFNLElBQUksYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2hDLE9BQU8sS0FBSyxLQUFLLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUM7SUFDSCxDQUFDO0lBRU8sb0JBQW9CLENBQUMsTUFBYyxFQUFFLEtBQWE7UUFDeEQsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMseUNBQXlDLE1BQU0sV0FBVyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ2xHO1FBRUQsSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN4QzthQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkM7YUFBTSxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLEtBQUssRUFBRTtZQUM1RCxNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztTQUN2QjthQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3pCLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsTUFBYyxFQUFFLEtBQWE7UUFDdkQsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLG1CQUFtQixFQUFFO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2hEO2FBQU07WUFDTCxJQUFJLEtBQUssWUFBWSxRQUFRLEVBQUU7Z0JBQzdCLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUNwQztTQUNGO0lBQ0gsQ0FBQztJQUVPLGlCQUFpQixDQUFDLE1BQW9CLEVBQUUsS0FBYTtRQUMzRCxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxzQ0FBc0MsTUFBTSxXQUFXLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDL0Y7UUFFRCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTFDLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ2hCLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRU0sYUFBYSxDQUFDLEtBQWE7UUFDaEMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU0sVUFBVSxDQUFDLEtBQWE7UUFDN0IsT0FBTyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRU0sVUFBVSxDQUFDLElBQVk7UUFDNUIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdEIsSUFBSSxHQUFHLG9CQUFvQixDQUFDO1NBQzdCO1FBRUQsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLFlBQVksSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ3pFO1FBRUQsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sSUFBSSxHQUFXLElBQUksU0FBUyxFQUFFLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBRXBDLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxJQUFVO1FBQ3ZDLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUMvQixPQUFPLElBQWMsQ0FBQztTQUN2QjthQUFNO1lBQ0wsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRXBELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsSUFBVSxFQUFFLElBQVk7UUFDbEQsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsNEJBQTRCLElBQUksV0FBVyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1NBQ25GO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBYyxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWhDLDBDQUEwQztRQUMxQyw2Q0FBNkM7UUFDN0MsdUJBQXVCO1FBQ3ZCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsaUJBQWlCLENBQUM7UUFFcEMsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVNLFdBQVcsQ0FBQyxJQUFZLEVBQUUsYUFBcUIsRUFBRSxLQUFVLEVBQUUsU0FBa0I7UUFDcEYsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRTtZQUNuRCxPQUFPO1NBQ1I7UUFFRCxJQUFJLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDckMsMkJBQTJCO1lBQzNCLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUMsYUFBYSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRWxELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ1YsT0FBTyxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksT0FBTyxJQUFJLEtBQUssV0FBVyxFQUFFO2dCQUMvRCxJQUFJLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDckIsSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQzFCO2dCQUVELElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xCLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQyxDQUFDLEVBQUUsQ0FBQzthQUNMO1NBQ0Y7UUFFRCxJQUFJLE9BQU8sSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUMvQixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN0RDtJQUNILENBQUM7SUFFTyxNQUFNLENBQUMsUUFBZ0I7UUFDN0IsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLE1BQU0sSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN6QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDO1lBQ2hDLEtBQUssSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDMUQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDO2dCQUMzQixLQUFLLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO2FBQ2pFO1lBQ0QsSUFBSSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN2QixJQUFJLEdBQUcsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyx1QkFBdUI7WUFDN0QsMkNBQTJDO1lBQzNDLGlEQUFpRDtZQUNqRCxxQ0FBcUM7WUFDckMseUJBQXlCO1lBQ3pCLGlCQUFpQjtZQUNqQixLQUFLO1lBQ0wsTUFBTTtTQUNQO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsSUFBWSxFQUFFLGFBQXFCLEVBQUUsS0FBVTtRQUN6RSxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsYUFBYSxJQUFJLEtBQUssT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQzFGO1FBRUQsSUFBSSxhQUFhLEtBQUssT0FBTyxFQUFFO1lBQzdCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdCLE9BQU87U0FDUjtRQUVELElBQUksY0FBYyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNoRCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQzVCLE9BQU87U0FDUjtRQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUVoRCxvRUFBb0U7UUFDcEUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM3QztRQUVELElBQUksWUFBWSxFQUFFO1lBQ2hCLDhDQUE4QztZQUM5QyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQzNCLE9BQU87U0FDUjtRQUVELDhEQUE4RDtRQUM5RCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFFTywrQkFBK0IsQ0FBQyxLQUFZO1FBQ2xELEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO1lBQ3hCLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNsQyxJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO29CQUNwQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLElBQUksQ0FBQyxVQUFVLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQztpQkFDMUY7Z0JBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7Z0JBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO2FBQzdCO1NBQ0Y7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLFFBQWE7UUFDakMsTUFBTSxJQUFJLEdBQUcsUUFBUSxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUM7UUFDOUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULE9BQU8sSUFBSSxHQUFHLEVBQWtCLENBQUM7U0FDbEM7UUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMzQixJQUFJLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztZQUN4QyxLQUFLLElBQUksUUFBUSxJQUFJLFFBQVEsRUFBRTtnQkFDN0IsdUJBQXVCO2dCQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQzthQUMvQztZQUNELFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ2pDO1FBRUQsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTyxVQUFVLENBQUMsSUFBWTtRQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN0QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksR0FBRyxFQUFtQixDQUFDO1NBQ2hEO1FBQ0QsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzNCLENBQUM7SUFFTSxRQUFRLENBQUMsSUFBbUIsRUFBRSxTQUFpQjtRQUNwRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxJQUFVLEVBQUUsU0FBaUI7UUFDOUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFZLEVBQUUsWUFBb0I7UUFDbkQsSUFBSSxPQUFPLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDOUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRU8sV0FBVyxDQUFDLElBQVk7UUFDOUIsSUFBSSxVQUFVLEdBQVMsS0FBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDO0lBQzlCLENBQUM7SUFFTSxRQUFRLENBQUMsSUFBVSxFQUFFLFNBQWlCLEVBQUUsS0FBVTtRQUN2RCxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztTQUMxQjthQUFNO1lBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUM7U0FDL0I7SUFDSCxDQUFDO0lBRU0sV0FBVyxDQUFDLElBQVUsRUFBRSxTQUFpQjtRQUM5QyxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUM1Qiw0QkFBNEI7WUFDM0IsSUFBSSxDQUFDLEtBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDM0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7U0FDMUI7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsVUFBVSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmlldywgdW5zZXRWYWx1ZSwgUGxhY2Vob2xkZXIsIENvbnRlbnRWaWV3LCBMYXlvdXRCYXNlLCBQcm94eVZpZXdDb250YWluZXIgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgZ2V0Vmlld0NsYXNzLCBnZXRWaWV3TWV0YSwgaXNLbm93blZpZXcgfSBmcm9tICcuL2VsZW1lbnQtcmVnaXN0cnknO1xuaW1wb3J0IHsgQ29tbWVudE5vZGUsIE5nVmlldywgVGV4dE5vZGUsIFZpZXdFeHRlbnNpb25zLCBpc0RldGFjaGVkRWxlbWVudCwgaXNJbnZpc2libGVOb2RlLCBpc1ZpZXcsIGlzQ29udGVudFZpZXcsIGlzTGF5b3V0IH0gZnJvbSAnLi92aWV3cyc7XG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIgfSBmcm9tICcuL3Byb3BlcnR5LWZpbHRlcic7XG5cbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBOZ0xheW91dEJhc2UgfSBmcm9tICcuL3ZpZXdzL3ZpZXctdHlwZXMnO1xuXG4vLyBOb3RlOiB0aGlzIHV0aWxpdHkgZXhpc3RzIGZyb20gZGVlcCBjb3JlIGltcG9ydCBob3dldmVyIHJlc3VsdHMgaW5cbi8vIE1vZHVsZSBub3QgZm91bmQ6IEVycm9yOiBDYW4ndCByZXNvbHZlICdAbmF0aXZlc2NyaXB0L2NvcmUvdWkvY29yZS9wcm9wZXJ0aWVzJ1xuZnVuY3Rpb24gaXNDc3NWYXJpYWJsZShwcm9wZXJ0eTogc3RyaW5nKSB7XG4gIHJldHVybiAvXi0tW14sXFxzXSs/JC8udGVzdChwcm9wZXJ0eSk7XG59XG5cbmNvbnN0IEVMRU1FTlRfTk9ERV9UWVBFID0gMTtcbmNvbnN0IFhNTF9BVFRSSUJVVEVTID0gT2JqZWN0LmZyZWV6ZShbJ3N0eWxlJywgJ3Jvd3MnLCAnY29sdW1ucycsICdmb250QXR0cmlidXRlcyddKTtcbmNvbnN0IHdoaXRlU3BhY2VTcGxpdHRlciA9IC9cXHMrLztcblxuZXhwb3J0IHR5cGUgQmVmb3JlQXR0YWNoQWN0aW9uID0gKHZpZXc6IFZpZXcpID0+IHZvaWQ7XG5cbmZ1bmN0aW9uIHByaW50TmdUcmVlKHZpZXc6IE5nVmlldykge1xuICBsZXQgcGFyZW50ID0gdmlldztcbiAgd2hpbGUgKHBhcmVudC5wYXJlbnQgJiYgKHBhcmVudC5wYXJlbnQgYXMgTmdWaWV3KS5maXJzdENoaWxkKSB7XG4gICAgcGFyZW50ID0gcGFyZW50LnBhcmVudCBhcyBOZ1ZpZXc7XG4gIH1cbiAgcHJpbnRDaGlsZHJlblJlY3Vyc2UocGFyZW50KTtcbn1cbmZ1bmN0aW9uIHByaW50Q2hpbGRyZW5SZWN1cnNlKHBhcmVudDogTmdWaWV3KSB7XG4gIGNvbnN0IGNoaWxkcmVuID0gcGFyZW50LmZpcnN0Q2hpbGQgPyBbcGFyZW50LmZpcnN0Q2hpbGQsIC4uLmdldENoaWxkcmVuU2libGluZ3MocGFyZW50LmZpcnN0Q2hpbGQpLm5leHRTaWJsaW5nc10gOiBbXTtcbiAgY29uc29sZS5sb2coYHBhcmVudDogJHtwYXJlbnR9LCBmaXJzdENoaWxkOiAke3BhcmVudC5maXJzdENoaWxkfSwgbGFzdENoaWxkOiAke3BhcmVudC5sYXN0Q2hpbGR9IGNoaWxkcmVuOiAke2NoaWxkcmVufWApO1xuICBpZiAocGFyZW50LmZpcnN0Q2hpbGQpIHtcbiAgICBjb25zb2xlLmxvZyhgLS0tLS0gc3RhcnQgJHtwYXJlbnR9YCk7XG4gIH1cbiAgY2hpbGRyZW4uZm9yRWFjaCgoYykgPT4gcHJpbnRDaGlsZHJlblJlY3Vyc2UoYykpO1xuICBpZiAocGFyZW50LmZpcnN0Q2hpbGQpIHtcbiAgICBjb25zb2xlLmxvZyhgLS0tLS0gZW5kICR7cGFyZW50fWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldENoaWxkcmVuU2libGluZ3ModmlldzogTmdWaWV3KSB7XG4gIGNvbnN0IG5leHRTaWJsaW5ncyA9IFtdO1xuICBjb25zdCBwcmV2aW91c1NpYmxpbmdzID0gW107XG4gIGxldCBzaWJsaW5nID0gdmlldy5uZXh0U2libGluZztcbiAgd2hpbGUgKHNpYmxpbmcpIHtcbiAgICBuZXh0U2libGluZ3MucHVzaChzaWJsaW5nKTtcbiAgICBzaWJsaW5nID0gc2libGluZy5uZXh0U2libGluZztcbiAgfVxuICBzaWJsaW5nID0gdmlldy5wcmV2aW91c1NpYmxpbmc7XG4gIHdoaWxlIChzaWJsaW5nKSB7XG4gICAgcHJldmlvdXNTaWJsaW5ncy5wdXNoKHNpYmxpbmcpO1xuICAgIHNpYmxpbmcgPSBzaWJsaW5nLnByZXZpb3VzU2libGluZztcbiAgfVxuICByZXR1cm4ge1xuICAgIHByZXZpb3VzU2libGluZ3MsXG4gICAgbmV4dFNpYmxpbmdzLFxuICB9O1xufVxuXG5mdW5jdGlvbiBwcmludFNpYmxpbmdzVHJlZSh2aWV3OiBOZ1ZpZXcpIHtcbiAgY29uc3QgeyBwcmV2aW91c1NpYmxpbmdzLCBuZXh0U2libGluZ3MgfSA9IGdldENoaWxkcmVuU2libGluZ3Modmlldyk7XG4gIGNvbnNvbGUubG9nKGAke3ZpZXd9IHByZXZpb3VzU2libGluZ3M6ICR7cHJldmlvdXNTaWJsaW5nc30gbmV4dFNpYmxpbmdzOiAke25leHRTaWJsaW5nc31gKTtcbn1cblxuY29uc3QgcHJvcGVydHlNYXBzOiBNYXA8RnVuY3Rpb24sIE1hcDxzdHJpbmcsIHN0cmluZz4+ID0gbmV3IE1hcDxGdW5jdGlvbiwgTWFwPHN0cmluZywgc3RyaW5nPj4oKTtcblxuZXhwb3J0IGNsYXNzIFZpZXdVdGlsIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuYW1lc3BhY2VGaWx0ZXJzPzogTmFtZXNwYWNlRmlsdGVyW10sIHByaXZhdGUgcmV1c2VWaWV3cz86IGJvb2xlYW4pIHt9XG4gIC8qKlxuICAgKiBJbnNlcnRzIGEgY2hpbGQgaW50byBhIHBhcnJlbnQsIHByZWZlcmFibHkgYmVmb3JlIG5leHQuXG4gICAqIEBwYXJhbSBwYXJlbnQgcGFyZW50IHZpZXdcbiAgICogQHBhcmFtIGNoaWxkIGNoaWxkIHZpZXcgdG8gYmUgYWRkZWRcbiAgICogQHBhcmFtIHByZXZpb3VzIHByZXZpb3VzIGVsZW1lbnQuIElmIHByZXNlbnQsIGluc2VydCBhZnRlciB0aGlzLlxuICAgKiBAcGFyYW0gbmV4dCBuZXh0IGVsZW1lbnQuIElmIHByZXNlbnQsIGluc2VydCBiZWZvcmUgdGhpcyAocHJldmlvdXMgaXMgaWdub3JlZCkuXG4gICAqL1xuICBwcml2YXRlIGluc2VydENoaWxkKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcsIHByZXZpb3VzPzogTmdWaWV3LCBuZXh0PzogTmdWaWV3KSB7XG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBleHRlbmRlZFBhcmVudCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhwYXJlbnQpO1xuICAgIGNvbnN0IGV4dGVuZGVkQ2hpbGQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMoY2hpbGQpO1xuXG4gICAgLy8gdGhpcyBzaG91bGQgbmV2ZXIgZW50ZXIsIGFzIGFuZ3VsYXIgaXMgc3VwcG9zZWQgdG8gcmVtb3ZlIHRoZSBjaGlsZCBmcm9tIHRoZSBwcmV2aW91cyBwYXJlbnQgYmVmb3JlIGNhbGxpbmcgdGhpc1xuICAgIC8vIGJ1dCB3aGVuIGFuZ3VsYXIgYW5pbWF0aW9ucyBhcmUgZW5hYmxlZCwgdGhlIHJlbW92YWwgbWlnaHQgYmUgZGVsYXllZCwgc28gd2UgbmVlZCB0byBlbnN1cmUgdGhpcyB2aWV3IGlzIG5vdCBhbnl3aGVyZVxuICAgIC8vIHRoaXMgc2VlbXMgdG8gb25seSBoYXBwZW5zIHRvIENvbW1lbnROb2Rlc1xuICAgIGlmIChleHRlbmRlZENoaWxkLnBhcmVudE5vZGUpIHtcbiAgICAgIHRoaXMucmVtb3ZlQ2hpbGQoZXh0ZW5kZWRDaGlsZC5wYXJlbnROb2RlLCBleHRlbmRlZENoaWxkKTtcbiAgICB9XG4gICAgLy8gaWYgdGhlcmUncyBhIG5leHQgY2hpbGQsIHByZXZpb3VzIGlzIHRoZSBwcmV2aW91c1NpYmxpbmcgb2YgaXRcbiAgICBpZiAobmV4dCkge1xuICAgICAgcHJldmlvdXMgPSBuZXh0LnByZXZpb3VzU2libGluZztcbiAgICB9IGVsc2UgaWYgKHByZXZpb3VzKSB7XG4gICAgICAvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMsIG5leHQgaXMgdGhlIG5leHRTaWJsaW5nIG9mIGl0XG4gICAgICBuZXh0ID0gcHJldmlvdXMubmV4dFNpYmxpbmc7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG5vIHByZXZpb3VzIG9yIG5leHQsIGFwcGVuZCB0byB0aGUgcGFyZW50XG4gICAgICBwcmV2aW91cyA9IGV4dGVuZGVkUGFyZW50Lmxhc3RDaGlsZDsgLy8gdGhpcyBjYW4gc3RpbGwgYmUgdW5kZWZpbmVkIGlmIHRoZSBwYXJlbnQgaGFzIG5vIGNoaWxkcmVuIVxuICAgIH1cbiAgICB0aGlzLmluc2VydEluTGlzdChleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCwgcHJldmlvdXMsIG5leHQpO1xuXG4gICAgaWYgKGlzRGV0YWNoZWRFbGVtZW50KGNoaWxkKSB8fCBpc0ludmlzaWJsZU5vZGUoY2hpbGQpKSB7XG4gICAgICBleHRlbmRlZENoaWxkLnBhcmVudE5vZGUgPSBleHRlbmRlZFBhcmVudDtcbiAgICB9XG5cbiAgICBpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGNoaWxkKSkge1xuICAgICAgY29uc3QgbmV4dFZpc3VhbCA9IHRoaXMuZmluZE5leHRWaXN1YWwobmV4dCk7XG4gICAgICB0aGlzLmFkZFRvVmlzdWFsVHJlZShleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCwgbmV4dFZpc3VhbCk7XG4gICAgfSBlbHNlIGlmIChpc0ludmlzaWJsZU5vZGUoZXh0ZW5kZWRDaGlsZCkpIHtcbiAgICAgIGNvbnN0IG5leHRWaXN1YWwgPSB0aGlzLmZpbmROZXh0VmlzdWFsKG5leHQpO1xuICAgICAgdGhpcy5hZGRJbnZpc2libGVOb2RlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkLCBuZXh0VmlzdWFsKTtcbiAgICB9XG4gICAgLy8gcHJpbnROZ1RyZWUoZXh0ZW5kZWRDaGlsZCk7XG4gIH1cblxuICBwdWJsaWMgaW5zZXJ0QmVmb3JlKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcsIHJlZkNoaWxkPzogVmlldyB8IE5nVmlldykge1xuICAgIGNvbnN0IGV4dGVuZGVkUmVmID0gcmVmQ2hpbGQgPyB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMocmVmQ2hpbGQpIDogdW5kZWZpbmVkO1xuICAgIHRoaXMuaW5zZXJ0Q2hpbGQocGFyZW50LCBjaGlsZCwgdW5kZWZpbmVkLCBleHRlbmRlZFJlZik7XG4gIH1cbiAgcHVibGljIGluc2VydEFmdGVyKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcsIHJlZkNoaWxkPzogVmlldyB8IE5nVmlldykge1xuICAgIGNvbnN0IGV4dGVuZGVkUmVmID0gcmVmQ2hpbGQgPyB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMocmVmQ2hpbGQpIDogdW5kZWZpbmVkO1xuICAgIHRoaXMuaW5zZXJ0Q2hpbGQocGFyZW50LCBjaGlsZCwgZXh0ZW5kZWRSZWYpO1xuICB9XG5cbiAgcHVibGljIGFwcGVuZENoaWxkKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcpIHtcbiAgICB0aGlzLmluc2VydENoaWxkKHBhcmVudCwgY2hpbGQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluc2VydHMgYSB2aWV3IGludG8gdGhlIHBhcmVudC9zaWJsaW5nIGxpbmtlZCBsaXN0XG4gICAqICFXQVJOSU5HOiB0aGlzIG1ldGhvZCBtYWtlcyBubyBjaGVja3MgdG8gdmFsaWRhdGUgdGhlIGludGVncml0eSBvZiBwcmV2aW91cy9uZXh0IGNoaWxkcmVuXG4gICAqIEBwYXJhbSBwYXJlbnQgcGFyZW50IHZpZXdcbiAgICogQHBhcmFtIGNoaWxkIGNoaWxkIHZpZXdcbiAgICogQHBhcmFtIHByZXZpb3VzIHByZXZpb3VzIGVsZW1lbnQuIG51bGwvdW5kZWZpbmVkIGZvciBmaXJzdCBlbGVtZW50XG4gICAqIEBwYXJhbSBuZXh0IG5leHQgZWxlbWVudC4gbnVsbC91bmRlZmluZWQgZm9yIGxhc3QgZWxlbWVudFxuICAgKi9cbiAgcHJpdmF0ZSBpbnNlcnRJbkxpc3QocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcsIHByZXZpb3VzOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLmluc2VydEluTGlzdCBwYXJlbnQ6ICR7cGFyZW50fSwgdmlldzogJHtjaGlsZH0sIGAgKyBgcHJldmlvdXM6ICR7cHJldmlvdXN9LCBuZXh0OiAke25leHR9YCk7XG4gICAgfVxuXG4gICAgaWYgKHByZXZpb3VzKSB7XG4gICAgICBwcmV2aW91cy5uZXh0U2libGluZyA9IGNoaWxkO1xuICAgICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gcHJldmlvdXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudC5maXJzdENoaWxkID0gY2hpbGQ7XG4gICAgfVxuXG4gICAgaWYgKG5leHQpIHtcbiAgICAgIGNoaWxkLm5leHRTaWJsaW5nID0gbmV4dDtcbiAgICAgIG5leHQucHJldmlvdXNTaWJsaW5nID0gY2hpbGQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudC5sYXN0Q2hpbGQgPSBjaGlsZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFRvVmlzdWFsVHJlZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuYWRkVG9WaXN1YWxUcmVlIHBhcmVudDogJHtwYXJlbnR9LCB2aWV3OiAke2NoaWxkfSwgbmV4dDogJHtuZXh0fWApO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQubWV0YSAmJiBwYXJlbnQubWV0YS5pbnNlcnRDaGlsZCkge1xuICAgICAgcGFyZW50Lm1ldGEuaW5zZXJ0Q2hpbGQocGFyZW50LCBjaGlsZCwgbmV4dCk7XG4gICAgfSBlbHNlIGlmIChpc0xheW91dChwYXJlbnQpKSB7XG4gICAgICB0aGlzLmluc2VydFRvTGF5b3V0KHBhcmVudCwgY2hpbGQsIG5leHQpO1xuICAgIH0gZWxzZSBpZiAoaXNDb250ZW50VmlldyhwYXJlbnQpKSB7XG4gICAgICBwYXJlbnQuY29udGVudCA9IGNoaWxkO1xuICAgIH0gZWxzZSBpZiAocGFyZW50ICYmICg8YW55PnBhcmVudCkuX2FkZENoaWxkRnJvbUJ1aWxkZXIpIHtcbiAgICAgICg8YW55PnBhcmVudCkuX2FkZENoaWxkRnJvbUJ1aWxkZXIoY2hpbGQubm9kZU5hbWUsIGNoaWxkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZEludmlzaWJsZU5vZGUocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChwYXJlbnQubWV0YT8uaW5zZXJ0SW52aXNpYmxlTm9kZSkge1xuICAgICAgcGFyZW50Lm1ldGEuaW5zZXJ0SW52aXNpYmxlTm9kZShwYXJlbnQsIGNoaWxkLCBuZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgVGV4dE5vZGUpIHtcbiAgICAgICAgKHBhcmVudCBhcyBhbnkpLnRleHQgPSBjaGlsZC50ZXh0O1xuICAgICAgICBjaGlsZC5yZWdpc3RlclRleHRDaGFuZ2UoKHQpID0+ICgocGFyZW50IGFzIGFueSkudGV4dCA9IHQpLCBwYXJlbnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5zZXJ0VG9MYXlvdXQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChjaGlsZC5wYXJlbnQgPT09IHBhcmVudCkge1xuICAgICAgdGhpcy5yZW1vdmVMYXlvdXRDaGlsZChwYXJlbnQsIGNoaWxkKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXh0VmlzdWFsID0gdGhpcy5maW5kTmV4dFZpc3VhbChuZXh0KTtcbiAgICBpZiAobmV4dFZpc3VhbCkge1xuICAgICAgY29uc3QgaW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChuZXh0VmlzdWFsKTtcbiAgICAgIHBhcmVudC5pbnNlcnRDaGlsZChjaGlsZCwgaW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnQuYWRkQ2hpbGQoY2hpbGQpO1xuICAgIH1cbiAgICAvLyBwYXJlbnQuZWFjaENoaWxkKChjKSA9PiB7Y29uc29sZS5sb2coYyk7IHJldHVybiB0cnVlfSk7XG4gIH1cblxuICBwcml2YXRlIGZpbmROZXh0VmlzdWFsKHZpZXc6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgbGV0IG5leHQgPSB2aWV3O1xuICAgIHdoaWxlIChuZXh0ICYmIGlzRGV0YWNoZWRFbGVtZW50KG5leHQpKSB7XG4gICAgICBuZXh0ID0gbmV4dC5uZXh0U2libGluZztcbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dDtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDaGlsZChwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlQ2hpbGQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBleHRlbmRlZFBhcmVudCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhwYXJlbnQpO1xuICAgIGNvbnN0IGV4dGVuZGVkQ2hpbGQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMoY2hpbGQpO1xuICAgIGV4dGVuZGVkQ2hpbGQucGFyZW50Tm9kZSA9IG51bGw7XG5cbiAgICB0aGlzLnJlbW92ZUZyb21MaXN0KGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcbiAgICBpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGV4dGVuZGVkQ2hpbGQpKSB7XG4gICAgICB0aGlzLnJlbW92ZUZyb21WaXN1YWxUcmVlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcbiAgICB9IGVsc2UgaWYgKGlzSW52aXNpYmxlTm9kZShleHRlbmRlZENoaWxkKSkge1xuICAgICAgdGhpcy5yZW1vdmVJbnZpc2libGVOb2RlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZyb21MaXN0KHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlRnJvbUxpc3QgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgLy8gb25seSBjaGlsZC4gbnVsbCBldmVyeXRoaW5nXG4gICAgaWYgKHBhcmVudC5maXJzdENoaWxkID09PSBjaGlsZCAmJiBwYXJlbnQubGFzdENoaWxkID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50LmZpcnN0Q2hpbGQgPSBudWxsO1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IG51bGw7XG4gICAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7XG4gICAgICBjaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHByZXZpb3VzID0gY2hpbGQucHJldmlvdXNTaWJsaW5nO1xuICAgIGNvbnN0IG5leHQgPSBjaGlsZC5uZXh0U2libGluZztcbiAgICAvLyBpcyBmaXJzdCBjaGlsZCwgbWFrZSB0aGUgbmV4dCBzaWJsaW5nIHRoZSBmaXJzdCBjaGlsZCAoY2FuIGJlIG51bGwpXG4gICAgaWYgKHBhcmVudC5maXJzdENoaWxkID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50LmZpcnN0Q2hpbGQgPSBuZXh0O1xuICAgIH1cblxuICAgIC8vIGlzIGxhc3QgY2hpbGQsIG1ha2UgdGhlIHByZXZpb3VzIHNpYmxpbmcgdGhlIGxhc3QgY2hpbGQgKGNhbiBiZSBudWxsKVxuICAgIGlmIChwYXJlbnQubGFzdENoaWxkID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IHByZXZpb3VzO1xuICAgIH1cblxuICAgIC8vIHdlIGhhdmUgYSBwcmV2aW91cyBzaWJsaW5nLCBtYWtlIGl0IHBvaW50IHRvIHRoZSBuZXh0IHNpYmxpbmdcbiAgICBpZiAocHJldmlvdXMpIHtcbiAgICAgIHByZXZpb3VzLm5leHRTaWJsaW5nID0gbmV4dDtcbiAgICB9XG5cbiAgICAvLyB3ZSBoYXZlIGEgbmV4dCBzaWJsaW5nLCBtYWtlIGl0IHBvaW50IHRvIHRoZSBwcmV2aW91c1xuICAgIGlmIChuZXh0KSB7XG4gICAgICBuZXh0LnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzO1xuICAgIH1cblxuICAgIC8vIGZpbmFsbHksIG51bGwgdGhlIHNpYmxpbmdzXG4gICAgY2hpbGQubmV4dFNpYmxpbmcgPSBudWxsO1xuICAgIGNoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7XG4gIH1cblxuICAvLyBOT1RFOiBUaGlzIG9uZSBpcyBPKG4pIC0gdXNlIGNhcmVmdWxseVxuICBwcml2YXRlIGZpbmRQcmV2aW91c0VsZW1lbnQocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLmZpbmRQcmV2aW91c0VsZW1lbnQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgbGV0IHByZXZpb3VzVmlzdWFsO1xuICAgIGlmIChpc0xheW91dChwYXJlbnQpKSB7XG4gICAgICBwcmV2aW91c1Zpc3VhbCA9IHRoaXMuZ2V0UHJldmlvdXNWaXN1YWxFbGVtZW50KHBhcmVudCwgY2hpbGQpO1xuICAgIH1cblxuICAgIGxldCBwcmV2aW91cyA9IHByZXZpb3VzVmlzdWFsIHx8IHBhcmVudC5maXJzdENoaWxkO1xuXG4gICAgLy8gc2luY2UgZGV0YWNoZWQgZWxlbWVudHMgYXJlIG5vdCBhZGRlZCB0byB0aGUgdmlzdWFsIHRyZWUsXG4gICAgLy8gd2UgbmVlZCB0byBmaW5kIHRoZSBhY3R1YWwgcHJldmlvdXMgc2libGluZyBvZiB0aGUgdmlldyxcbiAgICAvLyB3aGljaCBtYXkgYXMgd2VsbCBiZSBhbiBpbnZpc2libGUgbm9kZVxuICAgIHdoaWxlIChwcmV2aW91cyAmJiBwcmV2aW91cyAhPT0gY2hpbGQgJiYgcHJldmlvdXMubmV4dFNpYmxpbmcgIT09IGNoaWxkKSB7XG4gICAgICBwcmV2aW91cyA9IHByZXZpb3VzLm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIHJldHVybiBwcmV2aW91cztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJldmlvdXNWaXN1YWxFbGVtZW50KHBhcmVudDogTmdMYXlvdXRCYXNlLCBjaGlsZDogTmdWaWV3KTogTmdWaWV3IHtcbiAgICBjb25zdCBlbGVtZW50SW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG5cbiAgICBpZiAoZWxlbWVudEluZGV4ID4gMCkge1xuICAgICAgcmV0dXJuIHBhcmVudC5nZXRDaGlsZEF0KGVsZW1lbnRJbmRleCAtIDEpIGFzIE5nVmlldztcbiAgICB9XG4gIH1cblxuICAvLyBOT1RFOiBUaGlzIG9uZSBpcyBPKG4pIC0gdXNlIGNhcmVmdWxseVxuICBwdWJsaWMgZ2V0Q2hpbGRJbmRleChwYXJlbnQ6IGFueSwgY2hpbGQ6IE5nVmlldykge1xuICAgIGlmIChpc0xheW91dChwYXJlbnQpKSB7XG4gICAgICByZXR1cm4gcGFyZW50LmdldENoaWxkSW5kZXgoY2hpbGQpO1xuICAgIH0gZWxzZSBpZiAoaXNDb250ZW50VmlldyhwYXJlbnQpKSB7XG4gICAgICByZXR1cm4gY2hpbGQgPT09IHBhcmVudC5jb250ZW50ID8gMCA6IC0xO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRnJvbVZpc3VhbFRyZWUocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVGcm9tVmlzdWFsVHJlZSBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50Lm1ldGEgJiYgcGFyZW50Lm1ldGEucmVtb3ZlQ2hpbGQpIHtcbiAgICAgIHBhcmVudC5tZXRhLnJlbW92ZUNoaWxkKHBhcmVudCwgY2hpbGQpO1xuICAgIH0gZWxzZSBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuICAgICAgdGhpcy5yZW1vdmVMYXlvdXRDaGlsZChwYXJlbnQsIGNoaWxkKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29udGVudFZpZXcocGFyZW50KSAmJiBwYXJlbnQuY29udGVudCA9PT0gY2hpbGQpIHtcbiAgICAgIHBhcmVudC5jb250ZW50ID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKGlzVmlldyhwYXJlbnQpKSB7XG4gICAgICBwYXJlbnQuX3JlbW92ZVZpZXcoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlSW52aXNpYmxlTm9kZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldykge1xuICAgIGlmIChwYXJlbnQubWV0YT8ucmVtb3ZlSW52aXNpYmxlTm9kZSkge1xuICAgICAgcGFyZW50Lm1ldGEucmVtb3ZlSW52aXNpYmxlTm9kZShwYXJlbnQsIGNoaWxkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgVGV4dE5vZGUpIHtcbiAgICAgICAgY2hpbGQudW5yZWdpc3RlclRleHRDaGFuZ2UocGFyZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUxheW91dENoaWxkKHBhcmVudDogTmdMYXlvdXRCYXNlLCBjaGlsZDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlTGF5b3V0Q2hpbGQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG5cbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVDb21tZW50KHZhbHVlOiBzdHJpbmcpOiBDb21tZW50Tm9kZSB7XG4gICAgcmV0dXJuIG5ldyBDb21tZW50Tm9kZSh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGV4dCh2YWx1ZTogc3RyaW5nKTogVGV4dE5vZGUge1xuICAgIHJldHVybiBuZXcgVGV4dE5vZGUodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVZpZXcobmFtZTogc3RyaW5nKTogTmdWaWV3IHtcbiAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSBuYW1lO1xuICAgIGlmICghaXNLbm93blZpZXcobmFtZSkpIHtcbiAgICAgIG5hbWUgPSAnUHJveHlWaWV3Q29udGFpbmVyJztcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBDcmVhdGluZyB2aWV3OiAke29yaWdpbmFsTmFtZX0gJHtuYW1lfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHZpZXdDbGFzcyA9IGdldFZpZXdDbGFzcyhuYW1lKTtcbiAgICBjb25zdCB2aWV3ID0gPE5nVmlldz5uZXcgdmlld0NsYXNzKCk7XG4gICAgY29uc3QgbmdWaWV3ID0gdGhpcy5zZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXcsIG5hbWUpO1xuICAgIG5nVmlldy5yZXVzYWJsZSA9ICEhdGhpcy5yZXVzZVZpZXdzO1xuXG4gICAgcmV0dXJuIG5nVmlldztcbiAgfVxuXG4gIHByaXZhdGUgZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyh2aWV3OiBWaWV3KTogTmdWaWV3IHtcbiAgICBpZiAodmlldy5oYXNPd25Qcm9wZXJ0eSgnbWV0YScpKSB7XG4gICAgICByZXR1cm4gdmlldyBhcyBOZ1ZpZXc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB2aWV3LmNzc1R5cGU7XG4gICAgICBjb25zdCBuZ1ZpZXcgPSB0aGlzLnNldE5nVmlld0V4dGVuc2lvbnModmlldywgbmFtZSk7XG5cbiAgICAgIHJldHVybiBuZ1ZpZXc7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXc6IFZpZXcsIG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgTWFrZSBpbnRvIGEgTmdWaWV3IHZpZXc6ICR7dmlld30gbmFtZTogXCIke25hbWV9XCJgKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZ1ZpZXcgPSB2aWV3IGFzIE5nVmlldztcbiAgICBuZ1ZpZXcubm9kZU5hbWUgPSBuYW1lO1xuICAgIG5nVmlldy5tZXRhID0gZ2V0Vmlld01ldGEobmFtZSk7XG5cbiAgICAvLyB3ZSdyZSBzZXR0aW5nIHRoZSBub2RlIHR5cGUgb2YgdGhlIHZpZXdcbiAgICAvLyB0byAnZWxlbWVudCcgYmVjYXVzZSBvZiBjaGVja3MgZG9uZSBpbiB0aGVcbiAgICAvLyBkb20gYW5pbWF0aW9uIGVuZ2luZVxuICAgIG5nVmlldy5ub2RlVHlwZSA9IEVMRU1FTlRfTk9ERV9UWVBFO1xuXG4gICAgcmV0dXJuIG5nVmlldztcbiAgfVxuXG4gIHB1YmxpYyBzZXRQcm9wZXJ0eSh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF2aWV3IHx8IChuYW1lc3BhY2UgJiYgIXRoaXMucnVuc0luKG5hbWVzcGFjZSkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGF0dHJpYnV0ZU5hbWUuaW5kZXhPZignLicpICE9PSAtMSkge1xuICAgICAgLy8gSGFuZGxlIG5lc3RlZCBwcm9wZXJ0aWVzXG4gICAgICBjb25zdCBwcm9wZXJ0aWVzID0gYXR0cmlidXRlTmFtZS5zcGxpdCgnLicpO1xuICAgICAgYXR0cmlidXRlTmFtZSA9IHByb3BlcnRpZXNbcHJvcGVydGllcy5sZW5ndGggLSAxXTtcblxuICAgICAgbGV0IHByb3BNYXAgPSB0aGlzLmdldFByb3BlcnRpZXModmlldyk7XG4gICAgICBsZXQgaSA9IDA7XG4gICAgICB3aGlsZSAoaSA8IHByb3BlcnRpZXMubGVuZ3RoIC0gMSAmJiB0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgbGV0IHByb3AgPSBwcm9wZXJ0aWVzW2ldO1xuICAgICAgICBpZiAocHJvcE1hcC5oYXMocHJvcCkpIHtcbiAgICAgICAgICBwcm9wID0gcHJvcE1hcC5nZXQocHJvcCk7XG4gICAgICAgIH1cblxuICAgICAgICB2aWV3ID0gdmlld1twcm9wXTtcbiAgICAgICAgcHJvcE1hcCA9IHRoaXMuZ2V0UHJvcGVydGllcyh2aWV3KTtcbiAgICAgICAgaSsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3LCBhdHRyaWJ1dGVOYW1lLCB2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBydW5zSW4ocGxhdGZvcm06IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGxldCBydW5zID0gdHJ1ZTtcbiAgICBjb25zdCBsYXN0ID0gKCkgPT4gdHJ1ZTtcbiAgICBpZiAodGhpcy5uYW1lc3BhY2VGaWx0ZXJzKSB7XG4gICAgICBsZXQgY2hhaW4gPSAocDogc3RyaW5nKSA9PiB0cnVlO1xuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubmFtZXNwYWNlRmlsdGVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBjb25zdCBjdXJyZW50Q2hhaW4gPSBjaGFpbjtcbiAgICAgICAgY2hhaW4gPSAocCkgPT4gdGhpcy5uYW1lc3BhY2VGaWx0ZXJzW2ldLnJ1bnNJbihwLCBjdXJyZW50Q2hhaW4pO1xuICAgICAgfVxuICAgICAgcnVucyA9IGNoYWluKHBsYXRmb3JtKTtcbiAgICAgIHJ1bnMgPSBydW5zICE9PSBmYWxzZSA/IHRydWUgOiBmYWxzZTsgLy8gdW5kZWZpbmVkIG1lYW5zIHRydWVcbiAgICAgIC8vIHRoaXMubmFtZXNwYWNlRmlsdGVycy5zb21lKChmaWx0ZXIpID0+IHtcbiAgICAgIC8vIFx0Y29uc3QgcnVuc0luRmlsdGVyID0gZmlsdGVyLnJ1bnNJbihwbGF0Zm9ybSk7XG4gICAgICAvLyBcdGlmIChydW5zSW5GaWx0ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gXHRcdHJ1bnMgPSBydW5zSW5GaWx0ZXI7XG4gICAgICAvLyBcdFx0cmV0dXJuIHRydWU7XG4gICAgICAvLyBcdH1cbiAgICAgIC8vIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcnVucztcbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFNldHRpbmcgYXR0cmlidXRlOiAke2F0dHJpYnV0ZU5hbWV9PSR7dmFsdWV9IHRvICR7dmlld31gKTtcbiAgICB9XG5cbiAgICBpZiAoYXR0cmlidXRlTmFtZSA9PT0gJ2NsYXNzJykge1xuICAgICAgdGhpcy5zZXRDbGFzc2VzKHZpZXcsIHZhbHVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoWE1MX0FUVFJJQlVURVMuaW5kZXhPZihhdHRyaWJ1dGVOYW1lKSAhPT0gLTEpIHtcbiAgICAgIHZpZXdbYXR0cmlidXRlTmFtZV0gPSB2YWx1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9wTWFwID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHZpZXcpO1xuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BNYXAuZ2V0KGF0dHJpYnV0ZU5hbWUpO1xuXG4gICAgLy8gRW5zdXJlIHRoZSBjaGlsZHJlbiBvZiBhIGNvbGxlY3Rpb24gY3VycmVudGx5IGhhdmUgbm8gcGFyZW50IHNldC5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHRoaXMucmVtb3ZlUGFyZW50UmVmZXJlbmNlc0Zyb21JdGVtcyh2YWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BlcnR5TmFtZSkge1xuICAgICAgLy8gV2UgaGF2ZSBhIGxvd2VyLXVwcGVyIGNhc2UgbWFwcGVkIHByb3BlcnR5LlxuICAgICAgdmlld1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVW5rbm93biBhdHRyaWJ1dGUgdmFsdWUgLS0ganVzdCBzZXQgaXQgdG8gb3VyIG9iamVjdCBhcyBpcy5cbiAgICB2aWV3W2F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVBhcmVudFJlZmVyZW5jZXNGcm9tSXRlbXMoaXRlbXM6IGFueVtdKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICBpZiAoaXRlbS5wYXJlbnQgJiYgaXRlbS5wYXJlbnROb2RlKSB7XG4gICAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBVbmFzc2lnbmluZyBwYXJlbnQgJHtpdGVtLnBhcmVudE5vZGV9IG9uIHZhbHVlOiAke2l0ZW19YCk7XG4gICAgICAgIH1cbiAgICAgICAgaXRlbS5wYXJlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGl0ZW0ucGFyZW50Tm9kZSA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFByb3BlcnRpZXMoaW5zdGFuY2U6IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xuICAgIGNvbnN0IHR5cGUgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5jb25zdHJ1Y3RvcjtcbiAgICBpZiAoIXR5cGUpIHtcbiAgICAgIHJldHVybiBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgIH1cblxuICAgIGlmICghcHJvcGVydHlNYXBzLmhhcyh0eXBlKSkge1xuICAgICAgbGV0IHByb3BNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgICAgZm9yIChsZXQgcHJvcE5hbWUgaW4gaW5zdGFuY2UpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGU6Zm9yaW5cbiAgICAgICAgcHJvcE1hcC5zZXQocHJvcE5hbWUudG9Mb3dlckNhc2UoKSwgcHJvcE5hbWUpO1xuICAgICAgfVxuICAgICAgcHJvcGVydHlNYXBzLnNldCh0eXBlLCBwcm9wTWFwKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcGVydHlNYXBzLmdldCh0eXBlKTtcbiAgfVxuXG4gIHByaXZhdGUgY3NzQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpIHtcbiAgICBpZiAoIXZpZXcubmdDc3NDbGFzc2VzKSB7XG4gICAgICB2aWV3Lm5nQ3NzQ2xhc3NlcyA9IG5ldyBNYXA8c3RyaW5nLCBib29sZWFuPigpO1xuICAgIH1cbiAgICByZXR1cm4gdmlldy5uZ0Nzc0NsYXNzZXM7XG4gIH1cblxuICBwdWJsaWMgYWRkQ2xhc3ModmlldzogVmlldyB8IE5nVmlldywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBleHRlbmRlZFZpZXcgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnModmlldyk7XG4gICAgdGhpcy5jc3NDbGFzc2VzKGV4dGVuZGVkVmlldykuc2V0KGNsYXNzTmFtZSwgdHJ1ZSk7XG4gICAgdGhpcy5zeW5jQ2xhc3NlcyhleHRlbmRlZFZpZXcpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUNsYXNzKHZpZXc6IFZpZXcsIGNsYXNzTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZXh0ZW5kZWRWaWV3ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHZpZXcpO1xuICAgIHRoaXMuY3NzQ2xhc3NlcyhleHRlbmRlZFZpZXcpLmRlbGV0ZShjbGFzc05hbWUpO1xuICAgIHRoaXMuc3luY0NsYXNzZXMoZXh0ZW5kZWRWaWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q2xhc3Nlcyh2aWV3OiBOZ1ZpZXcsIGNsYXNzZXNWYWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgbGV0IGNsYXNzZXMgPSBjbGFzc2VzVmFsdWUuc3BsaXQod2hpdGVTcGFjZVNwbGl0dGVyKTtcbiAgICB0aGlzLmNzc0NsYXNzZXModmlldykuY2xlYXIoKTtcbiAgICBjbGFzc2VzLmZvckVhY2goKGNsYXNzTmFtZSkgPT4gdGhpcy5jc3NDbGFzc2VzKHZpZXcpLnNldChjbGFzc05hbWUsIHRydWUpKTtcbiAgICB0aGlzLnN5bmNDbGFzc2VzKHZpZXcpO1xuICB9XG5cbiAgcHJpdmF0ZSBzeW5jQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBsZXQgY2xhc3NWYWx1ZSA9ICg8YW55PkFycmF5KS5mcm9tKHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5rZXlzKCkpLmpvaW4oJyAnKTtcbiAgICB2aWV3LmNsYXNzTmFtZSA9IGNsYXNzVmFsdWU7XG4gIH1cblxuICBwdWJsaWMgc2V0U3R5bGUodmlldzogVmlldywgc3R5bGVOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAoaXNDc3NWYXJpYWJsZShzdHlsZU5hbWUpKSB7XG4gICAgICB2aWV3LnN0eWxlLnNldFVuc2NvcGVkQ3NzVmFyaWFibGUoc3R5bGVOYW1lLCB2YWx1ZSk7XG4gICAgICB2aWV3Ll9vbkNzc1N0YXRlQ2hhbmdlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZpZXcuc3R5bGVbc3R5bGVOYW1lXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVTdHlsZSh2aWV3OiBWaWV3LCBzdHlsZU5hbWU6IHN0cmluZykge1xuICAgIGlmIChpc0Nzc1ZhcmlhYmxlKHN0eWxlTmFtZSkpIHtcbiAgICAgIC8vIFRPRE86IGV4cG9zZSB0aGlzIG9uIGNvcmVcbiAgICAgICh2aWV3LnN0eWxlIGFzIGFueSkudW5zY29wZWRDc3NWYXJpYWJsZXMuZGVsZXRlKHN0eWxlTmFtZSk7XG4gICAgICB2aWV3Ll9vbkNzc1N0YXRlQ2hhbmdlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZpZXcuc3R5bGVbc3R5bGVOYW1lXSA9IHVuc2V0VmFsdWU7XG4gICAgfVxuICB9XG59XG4iXX0=