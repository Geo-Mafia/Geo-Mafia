import { __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional, RendererStyleFlags2, ViewEncapsulation } from '@angular/core';
import { addTaggedAdditionalCSS, Application, ContentView, getViewById, Observable, profile, View } from '@nativescript/core';
import { isKnownView } from './element-registry';
import { getFirstNativeLikeView, TextNode } from './views';
import { NAMESPACE_FILTERS } from './property-filter';
import { APP_ROOT_VIEW, ENABLE_REUSABE_VIEWS, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { NativeScriptDebug } from './trace';
import { ViewUtil } from './view-util';
import * as i0 from "@angular/core";
import * as i1 from "@nativescript/core";
const addStyleToCss = profile('"renderer".addStyleToCss', function addStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
function runInRootZone(fn) {
    if (typeof Zone === 'undefined') {
        return fn();
    }
    return Zone.root.run(fn);
}
function inRootZone() {
    return function (target, key, descriptor) {
        const childFunction = descriptor.value;
        descriptor.value = function (...args) {
            const fn = childFunction.bind(this);
            return runInRootZone(() => fn(...args));
        };
        return descriptor;
    };
}
let NativeScriptRendererFactory = class NativeScriptRendererFactory {
    constructor(rootView, namespaceFilters, rootModuleID, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.rootModuleID = rootModuleID;
        this.reuseViews = reuseViews;
        this.componentRenderers = new Map();
        // backwards compatibility with RadListView
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        if (typeof this.reuseViews !== 'boolean') {
            this.reuseViews = false; // default to false
        }
        this.defaultRenderer = new NativeScriptRenderer(rootView, namespaceFilters, this.reuseViews);
    }
    createRenderer(hostElement, type) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRendererFactory.createRenderer ${hostElement}. type.id: ${type.id} type.encapsulation: ${type.encapsulation}`);
        }
        if (!hostElement || !type) {
            return this.defaultRenderer;
        }
        let renderer = this.componentRenderers.get(type.id);
        /**
         *! WARNING
         *! We're reusing the renderer for the components
         *! this might cause unexpected behavior as the "rootView" is an arbitrary hostElement
         *! also, the renderer has it's .destroy() called!
         *! might be useful to create a BaseEmulatedRender and a ProxyEmulatedRender
         *! every component type gets a BaseEmulatedRender (singleton) which is passed to ProxyEmulatedRender
         *! ProxyEmulatedRenderer registers with BaseEmulatedRender so we can clean up things like CSS when it's not needed
         *! this might be useful if we find a way to HMR component styling without a full rebootstrap
         */
        if (renderer) {
            if (renderer instanceof EmulatedRenderer) {
                renderer.applyToHost(hostElement);
            }
            return renderer;
        }
        if (type.encapsulation === ViewEncapsulation.None) {
            type.styles.map((s) => s.toString()).forEach((v) => addStyleToCss(v, this.rootModuleID));
            renderer = this.defaultRenderer;
        }
        else {
            renderer = new EmulatedRenderer(type, hostElement, this.namespaceFilters, this.rootModuleID, this.reuseViews);
            renderer.applyToHost(hostElement);
        }
        this.componentRenderers.set(type.id, renderer);
        return renderer;
    }
    // begin?(): void {
    //     throw new Error("Method not implemented.");
    // }
    // end?(): void {
    //     throw new Error("Method not implemented.");
    // }
    whenRenderingDone() {
        if (!this.rootView) {
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            let interval = 0;
            function scheduleResolve() {
                // iOS really hates synchronous things...
                // Utils.queueMacrotask(resolve);
                setTimeout(resolve, 15);
            }
            function fireWhenLoaded() {
                const view = rootFactory();
                if (view.isLoaded) {
                    scheduleResolve();
                }
                else {
                    view.once('loaded', scheduleResolve);
                }
            }
            const rootFactory = () => (this.rootView instanceof ContentView ? this.rootView.content : this.rootView);
            if (!rootFactory()) {
                interval = setInterval(() => {
                    if (rootFactory()) {
                        clearInterval(interval);
                        fireWhenLoaded();
                    }
                }, 10);
            }
            else {
                fireWhenLoaded();
            }
        });
        // throw new Error("Method not implemented.");
    }
};
NativeScriptRendererFactory = __decorate([
    __param(0, Inject(APP_ROOT_VIEW)),
    __param(1, Inject(NAMESPACE_FILTERS)),
    __param(2, Inject(NATIVESCRIPT_ROOT_MODULE_ID)),
    __param(3, Optional()),
    __param(3, Inject(ENABLE_REUSABE_VIEWS)),
    __metadata("design:paramtypes", [View, Array, Object, Object])
], NativeScriptRendererFactory);
export { NativeScriptRendererFactory };
class NativeScriptRenderer {
    constructor(rootView, namespaceFilters, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        this.destroyNode = (node) => runInRootZone(() => {
            if (NativeScriptDebug.enabled) {
                NativeScriptDebug.rendererLog(`NativeScriptRenderer.destroyNode node: ${node}`);
            }
            if (node?.destroyNode) {
                node?.destroyNode();
            }
        });
    }
    get data() {
        throw new Error('Method not implemented.');
    }
    destroy() {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.destroy');
        }
    }
    createElement(name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createElement: ${name}`);
        }
        let oldName;
        if (!isKnownView(name)) {
            oldName = name;
            name = 'ProxyViewContainer';
        }
        const view = this.viewUtil.createView(name);
        if (oldName) {
            view.customCSSName = oldName;
        }
        return view;
    }
    createComment(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createComment ${value}`);
        }
        return this.viewUtil.createComment(value);
    }
    createText(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createText ${value}`);
        }
        return this.viewUtil.createText(value);
    }
    appendChild(parent, newChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.appendChild child: ${newChild} parent: ${parent}`);
        }
        this.viewUtil.appendChild(parent, newChild);
    }
    insertBefore(parent, newChild, refChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.insertBefore child: ${newChild} ` + `parent: ${parent} refChild: ${refChild}`);
        }
        this.viewUtil.insertBefore(parent, newChild, refChild);
    }
    removeChild(parent, oldChild, isHostElement) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeChild child: ${oldChild} parent: ${parent}`);
        }
        this.viewUtil.removeChild(parent, oldChild);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.selectRootElement: ${selectorOrNode}`);
        }
        if (selectorOrNode instanceof View) {
            return selectorOrNode;
        }
        if (selectorOrNode && selectorOrNode[0] === '#') {
            const result = getViewById(this.rootView, selectorOrNode.slice(1));
            return (result || this.rootView);
        }
        if (typeof selectorOrNode === 'string') {
            const view = this.viewUtil.createView(selectorOrNode);
            if (getFirstNativeLikeView(view) === view) {
                // view is nativelike!
                this.appendChild(this.rootView, view);
                return view;
            }
        }
        return this.rootView;
    }
    parentNode(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.parentNode for node: ${node} is ${node.parentNode}`);
        }
        return node.parentNode;
    }
    nextSibling(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.nextSibling of ${node} is ${node.nextSibling}`);
        }
        return node.nextSibling;
    }
    setAttribute(el, name, value, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setAttribute ${namespace ? namespace + ':' : ''}${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value, namespace);
    }
    removeAttribute(el, name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeAttribute ${namespace ? namespace + ':' : ''}${el}.${name}`);
        }
    }
    addClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.addClass ${name}`);
        }
        this.viewUtil.addClass(el, name);
    }
    removeClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeClass ${name}`);
        }
        this.viewUtil.removeClass(el, name);
    }
    setStyle(el, style, value, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setStyle: ${el}, ${style} = ${value}`);
        }
        this.viewUtil.setStyle(el, style, value);
    }
    removeStyle(el, style, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.removeStyle: ${styleName}');
        }
        this.viewUtil.removeStyle(el, style);
    }
    setProperty(el, name, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setProperty ${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value);
    }
    setValue(node, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setValue renderNode: ${node}, value: ${value}`);
        }
        if (node instanceof TextNode) {
            node.text = value;
        }
        // throw new Error("Method not implemented.");
    }
    listen(target, eventName, callback) {
        // throw new Error("Method not implemented.");
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.listen: ${eventName}`);
        }
        target.on(eventName, callback);
        if (eventName === View.loadedEvent && target.isLoaded) {
            // we must create a new obervable here to ensure that the event goes through whatever zone patches are applied
            const obs = new Observable();
            obs.once(eventName, callback);
            obs.notify({
                eventName,
                object: target,
            });
        }
        return () => target.off(eventName, callback);
    }
}
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createElement", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createComment", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createText", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [View, View]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "appendChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "insertBefore", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Boolean]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setAttribute", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "addClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setProperty", null);
// CONTENT_ATTR not exported from nativescript-renderer - we need it for styles application.
const COMPONENT_REGEX = /%COMP%/g;
const ATTR_SANITIZER = /-/g;
export const COMPONENT_VARIABLE = '%COMP%';
export const HOST_ATTR = `_nghost-${COMPONENT_VARIABLE}`;
export const CONTENT_ATTR = `_ngcontent-${COMPONENT_VARIABLE}`;
const replaceNgAttribute = function (input, componentId) {
    return input.replace(COMPONENT_REGEX, componentId);
};
const addScopedStyleToCss = profile(`"renderer".addScopedStyleToCss`, function addScopedStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
export class EmulatedRenderer extends NativeScriptRenderer {
    constructor(component, rootView, namespaceFilters, rootModuleId, reuseViews) {
        super(rootView, namespaceFilters, reuseViews);
        this.rootModuleId = rootModuleId;
        const componentId = component.id.replace(ATTR_SANITIZER, '_');
        this.contentAttr = replaceNgAttribute(CONTENT_ATTR, componentId);
        this.hostAttr = replaceNgAttribute(HOST_ATTR, componentId);
        this.addStyles(component.styles, componentId);
    }
    applyToHost(view) {
        super.setAttribute(view, this.hostAttr, '');
    }
    appendChild(parent, newChild) {
        super.appendChild(parent, newChild);
    }
    createElement(parent, name) {
        const view = super.createElement(parent, name);
        // Set an attribute to the view to scope component-specific css.
        // The property name is pre-generated by Angular.
        super.setAttribute(view, this.contentAttr, '');
        return view;
    }
    addStyles(styles, componentId) {
        styles
            .map((s) => s.toString())
            .map((s) => replaceNgAttribute(s, componentId))
            .forEach((s) => addScopedStyleToCss(s, this.rootModuleId));
    }
}
EmulatedRenderer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: EmulatedRenderer, deps: "invalid", target: i0.ɵɵFactoryTarget.Injectable });
EmulatedRenderer.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: EmulatedRenderer });
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Array, String]),
    __metadata("design:returntype", void 0)
], EmulatedRenderer.prototype, "addStyles", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: EmulatedRenderer, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined }, { type: i1.View }, { type: undefined }, { type: undefined }, { type: undefined }]; }, propDecorators: { addStyles: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlc2NyaXB0LXJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL25hdGl2ZXNjcmlwdC1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQVUsUUFBUSxFQUErQixtQkFBbUIsRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQVUsV0FBVyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVMsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0ksT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsc0JBQXNCLEVBQVUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5FLE9BQU8sRUFBbUIsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsYUFBYSxFQUFFLG9CQUFvQixFQUFFLDJCQUEyQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDOzs7QUFFdkMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixFQUFFLFNBQVMsYUFBYSxDQUFDLEtBQWEsRUFBRSxHQUFxQjtJQUNuSCxJQUFJLEdBQUcsRUFBRTtRQUNQLHNCQUFzQixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztLQUNwQztTQUFNO1FBQ0wsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUMzQjtBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxhQUFhLENBQUksRUFBVztJQUNuQyxJQUFJ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VUFBVTsrS0FpQ0QsU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgTmdab25lLCBPcHRpb25hbCwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBSZW5kZXJlclN0eWxlRmxhZ3MyLCBSZW5kZXJlclR5cGUyLCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYWRkVGFnZ2VkQWRkaXRpb25hbENTUywgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBEZXZpY2UsIGdldFZpZXdCeUlkLCBPYnNlcnZhYmxlLCBwcm9maWxlLCBVdGlscywgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBnZXRWaWV3Q2xhc3MsIGlzS25vd25WaWV3IH0gZnJvbSAnLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IGdldEZpcnN0TmF0aXZlTGlrZVZpZXcsIE5nVmlldywgVGV4dE5vZGUgfSBmcm9tICcuL3ZpZXdzJztcblxuaW1wb3J0IHsgTmFtZXNwYWNlRmlsdGVyLCBOQU1FU1BBQ0VfRklMVEVSUyB9IGZyb20gJy4vcHJvcGVydHktZmlsdGVyJztcbmltcG9ydCB7IEFQUF9ST09UX1ZJRVcsIEVOQUJMRV9SRVVTQUJFX1ZJRVdTLCBOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQgfSBmcm9tICcuL3Rva2Vucyc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4vdHJhY2UnO1xuaW1wb3J0IHsgVmlld1V0aWwgfSBmcm9tICcuL3ZpZXctdXRpbCc7XG5cbmNvbnN0IGFkZFN0eWxlVG9Dc3MgPSBwcm9maWxlKCdcInJlbmRlcmVyXCIuYWRkU3R5bGVUb0NzcycsIGZ1bmN0aW9uIGFkZFN0eWxlVG9Dc3Moc3R5bGU6IHN0cmluZywgdGFnPzogc3RyaW5nIHwgbnVtYmVyKTogdm9pZCB7XG4gIGlmICh0YWcpIHtcbiAgICBhZGRUYWdnZWRBZGRpdGlvbmFsQ1NTKHN0eWxlLCB0YWcpO1xuICB9IGVsc2Uge1xuICAgIEFwcGxpY2F0aW9uLmFkZENzcyhzdHlsZSk7XG4gIH1cbn0pO1xuXG5mdW5jdGlvbiBydW5JblJvb3Rab25lPFQ+KGZuOiAoKSA9PiBUKTogVCB7XG4gIGlmICh0eXBlb2YgWm9uZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICByZXR1cm4gZm4oKTtcbiAgfVxuICByZXR1cm4gWm9uZS5yb290LnJ1bihmbik7XG59XG5cbmZ1bmN0aW9uIGluUm9vdFpvbmUoKSB7XG4gIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBPYmplY3QsIGtleTogc3RyaW5nIHwgc3ltYm9sLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBjaGlsZEZ1bmN0aW9uID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBjb25zdCBmbiA9IGNoaWxkRnVuY3Rpb24uYmluZCh0aGlzKTtcbiAgICAgIHJldHVybiBydW5JblJvb3Rab25lKCgpID0+IGZuKC4uLmFyZ3MpKTtcbiAgICB9O1xuICAgIHJldHVybiBkZXNjcmlwdG9yO1xuICB9O1xufVxuXG5leHBvcnQgY2xhc3MgTmF0aXZlU2NyaXB0UmVuZGVyZXJGYWN0b3J5IGltcGxlbWVudHMgUmVuZGVyZXJGYWN0b3J5MiB7XG4gIHByaXZhdGUgY29tcG9uZW50UmVuZGVyZXJzID0gbmV3IE1hcDxzdHJpbmcsIFJlbmRlcmVyMj4oKTtcbiAgcHJpdmF0ZSBkZWZhdWx0UmVuZGVyZXI6IFJlbmRlcmVyMjtcbiAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBSYWRMaXN0Vmlld1xuICBwcml2YXRlIHZpZXdVdGlsID0gbmV3IFZpZXdVdGlsKHRoaXMubmFtZXNwYWNlRmlsdGVycywgdGhpcy5yZXVzZVZpZXdzKTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KEFQUF9ST09UX1ZJRVcpIHByaXZhdGUgcm9vdFZpZXc6IFZpZXcsIEBJbmplY3QoTkFNRVNQQUNFX0ZJTFRFUlMpIHByaXZhdGUgbmFtZXNwYWNlRmlsdGVyczogTmFtZXNwYWNlRmlsdGVyW10sIEBJbmplY3QoTkFUSVZFU0NSSVBUX1JPT1RfTU9EVUxFX0lEKSBwcml2YXRlIHJvb3RNb2R1bGVJRDogc3RyaW5nIHwgbnVtYmVyLCBAT3B0aW9uYWwoKSBASW5qZWN0KEVOQUJMRV9SRVVTQUJFX1ZJRVdTKSBwcml2YXRlIHJldXNlVmlld3MpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucmV1c2VWaWV3cyAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICB0aGlzLnJldXNlVmlld3MgPSBmYWxzZTsgLy8gZGVmYXVsdCB0byBmYWxzZVxuICAgIH1cbiAgICB0aGlzLmRlZmF1bHRSZW5kZXJlciA9IG5ldyBOYXRpdmVTY3JpcHRSZW5kZXJlcihyb290VmlldywgbmFtZXNwYWNlRmlsdGVycywgdGhpcy5yZXVzZVZpZXdzKTtcbiAgfVxuICBjcmVhdGVSZW5kZXJlcihob3N0RWxlbWVudDogYW55LCB0eXBlOiBSZW5kZXJlclR5cGUyKTogUmVuZGVyZXIyIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlciAke2hvc3RFbGVtZW50fS4gdHlwZS5pZDogJHt0eXBlLmlkfSB0eXBlLmVuY2Fwc3VsYXRpb246ICR7dHlwZS5lbmNhcHN1bGF0aW9ufWApO1xuICAgIH1cbiAgICBpZiAoIWhvc3RFbGVtZW50IHx8ICF0eXBlKSB7XG4gICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmVuZGVyZXI7XG4gICAgfVxuXG4gICAgbGV0IHJlbmRlcmVyID0gdGhpcy5jb21wb25lbnRSZW5kZXJlcnMuZ2V0KHR5cGUuaWQpO1xuICAgIC8qKlxuICAgICAqISBXQVJOSU5HXG4gICAgICohIFdlJ3JlIHJldXNpbmcgdGhlIHJlbmRlcmVyIGZvciB0aGUgY29tcG9uZW50c1xuICAgICAqISB0aGlzIG1pZ2h0IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3IgYXMgdGhlIFwicm9vdFZpZXdcIiBpcyBhbiBhcmJpdHJhcnkgaG9zdEVsZW1lbnRcbiAgICAgKiEgYWxzbywgdGhlIHJlbmRlcmVyIGhhcyBpdCdzIC5kZXN0cm95KCkgY2FsbGVkIVxuICAgICAqISBtaWdodCBiZSB1c2VmdWwgdG8gY3JlYXRlIGEgQmFzZUVtdWxhdGVkUmVuZGVyIGFuZCBhIFByb3h5RW11bGF0ZWRSZW5kZXJcbiAgICAgKiEgZXZlcnkgY29tcG9uZW50IHR5cGUgZ2V0cyBhIEJhc2VFbXVsYXRlZFJlbmRlciAoc2luZ2xldG9uKSB3aGljaCBpcyBwYXNzZWQgdG8gUHJveHlFbXVsYXRlZFJlbmRlclxuICAgICAqISBQcm94eUVtdWxhdGVkUmVuZGVyZXIgcmVnaXN0ZXJzIHdpdGggQmFzZUVtdWxhdGVkUmVuZGVyIHNvIHdlIGNhbiBjbGVhbiB1cCB0aGluZ3MgbGlrZSBDU1Mgd2hlbiBpdCdzIG5vdCBuZWVkZWRcbiAgICAgKiEgdGhpcyBtaWdodCBiZSB1c2VmdWwgaWYgd2UgZmluZCBhIHdheSB0byBITVIgY29tcG9uZW50IHN0eWxpbmcgd2l0aG91dCBhIGZ1bGwgcmVib290c3RyYXBcbiAgICAgKi9cbiAgICBpZiAocmVuZGVyZXIpIHtcbiAgICAgIGlmIChyZW5kZXJlciBpbnN0YW5jZW9mIEVtdWxhdGVkUmVuZGVyZXIpIHtcbiAgICAgICAgcmVuZGVyZXIuYXBwbHlUb0hvc3QoaG9zdEVsZW1lbnQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVuZGVyZXI7XG4gICAgfVxuXG4gICAgaWYgKHR5cGUuZW5jYXBzdWxhdGlvbiA9PT0gVmlld0VuY2Fwc3VsYXRpb24uTm9uZSkge1xuICAgICAgdHlwZS5zdHlsZXMubWFwKChzKSA9PiBzLnRvU3RyaW5nKCkpLmZvckVhY2goKHYpID0+IGFkZFN0eWxlVG9Dc3ModiwgdGhpcy5yb290TW9kdWxlSUQpKTtcbiAgICAgIHJlbmRlcmVyID0gdGhpcy5kZWZhdWx0UmVuZGVyZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbmRlcmVyID0gbmV3IEVtdWxhdGVkUmVuZGVyZXIodHlwZSwgaG9zdEVsZW1lbnQsIHRoaXMubmFtZXNwYWNlRmlsdGVycywgdGhpcy5yb290TW9kdWxlSUQsIHRoaXMucmV1c2VWaWV3cyk7XG4gICAgICAoPEVtdWxhdGVkUmVuZGVyZXI+cmVuZGVyZXIpLmFwcGx5VG9Ib3N0KGhvc3RFbGVtZW50KTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbXBvbmVudFJlbmRlcmVycy5zZXQodHlwZS5pZCwgcmVuZGVyZXIpO1xuICAgIHJldHVybiByZW5kZXJlcjtcbiAgfVxuICAvLyBiZWdpbj8oKTogdm9pZCB7XG4gIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgLy8gfVxuICAvLyBlbmQ/KCk6IHZvaWQge1xuICAvLyAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIC8vIH1cbiAgd2hlblJlbmRlcmluZ0RvbmUoKTogUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoIXRoaXMucm9vdFZpZXcpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgICBsZXQgaW50ZXJ2YWw6IGFueSA9IDA7XG4gICAgICBmdW5jdGlvbiBzY2hlZHVsZVJlc29sdmUoKSB7XG4gICAgICAgIC8vIGlPUyByZWFsbHkgaGF0ZXMgc3luY2hyb25vdXMgdGhpbmdzLi4uXG4gICAgICAgIC8vIFV0aWxzLnF1ZXVlTWFjcm90YXNrKHJlc29sdmUpO1xuICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIDE1KTtcbiAgICAgIH1cbiAgICAgIGZ1bmN0aW9uIGZpcmVXaGVuTG9hZGVkKCkge1xuICAgICAgICBjb25zdCB2aWV3ID0gcm9vdEZhY3RvcnkoKTtcbiAgICAgICAgaWYgKHZpZXcuaXNMb2FkZWQpIHtcbiAgICAgICAgICBzY2hlZHVsZVJlc29sdmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB2aWV3Lm9uY2UoJ2xvYWRlZCcsIHNjaGVkdWxlUmVzb2x2ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHJvb3RGYWN0b3J5ID0gKCkgPT4gKHRoaXMucm9vdFZpZXcgaW5zdGFuY2VvZiBDb250ZW50VmlldyA/IHRoaXMucm9vdFZpZXcuY29udGVudCA6IHRoaXMucm9vdFZpZXcpO1xuICAgICAgaWYgKCFyb290RmFjdG9yeSgpKSB7XG4gICAgICAgIGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgIGlmIChyb290RmFjdG9yeSgpKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgICAgICAgIGZpcmVXaGVuTG9hZGVkKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCAxMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaXJlV2hlbkxvYWRlZCgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8vIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICB9XG59XG5cbmNsYXNzIE5hdGl2ZVNjcmlwdFJlbmRlcmVyIGltcGxlbWVudHMgUmVuZGVyZXIyIHtcbiAgcHJpdmF0ZSB2aWV3VXRpbCA9IG5ldyBWaWV3VXRpbCh0aGlzLm5hbWVzcGFjZUZpbHRlcnMsIHRoaXMucmV1c2VWaWV3cyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb290VmlldzogVmlldywgcHJpdmF0ZSBuYW1lc3BhY2VGaWx0ZXJzPzogTmFtZXNwYWNlRmlsdGVyW10sIHByaXZhdGUgcmV1c2VWaWV3cz86IGJvb2xlYW4pIHt9XG4gIGdldCBkYXRhKCk6IHsgW2tleTogc3RyaW5nXTogYW55IH0ge1xuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcbiAgfVxuICBkZXN0cm95KCk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZygnTmF0aXZlU2NyaXB0UmVuZGVyZXIuZGVzdHJveScpO1xuICAgIH1cbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQ6ICR7bmFtZX1gKTtcbiAgICB9XG4gICAgbGV0IG9sZE5hbWU7XG4gICAgaWYgKCFpc0tub3duVmlldyhuYW1lKSkge1xuICAgICAgb2xkTmFtZSA9IG5hbWU7XG4gICAgICBuYW1lID0gJ1Byb3h5Vmlld0NvbnRhaW5lcic7XG4gICAgfVxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdVdGlsLmNyZWF0ZVZpZXcobmFtZSk7XG4gICAgaWYgKG9sZE5hbWUpIHtcbiAgICAgICh2aWV3IGFzIGFueSkuY3VzdG9tQ1NTTmFtZSA9IG9sZE5hbWU7XG4gICAgfVxuICAgIHJldHVybiB2aWV3O1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgY3JlYXRlQ29tbWVudCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5jcmVhdGVDb21tZW50ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnZpZXdVdGlsLmNyZWF0ZUNvbW1lbnQodmFsdWUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgY3JlYXRlVGV4dCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5jcmVhdGVUZXh0ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnZpZXdVdGlsLmNyZWF0ZVRleHQodmFsdWUpO1xuICB9XG4gIGRlc3Ryb3lOb2RlOiAobm9kZTogYW55KSA9PiB2b2lkID0gKG5vZGU6IFZpZXcpID0+XG4gICAgcnVuSW5Sb290Wm9uZSgoKSA9PiB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuZGVzdHJveU5vZGUgbm9kZTogJHtub2RlfWApO1xuICAgICAgfVxuICAgICAgaWYgKG5vZGU/LmRlc3Ryb3lOb2RlKSB7XG4gICAgICAgIG5vZGU/LmRlc3Ryb3lOb2RlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIEBpblJvb3Rab25lKClcbiAgYXBwZW5kQ2hpbGQocGFyZW50OiBWaWV3LCBuZXdDaGlsZDogVmlldyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuYXBwZW5kQ2hpbGQgY2hpbGQ6ICR7bmV3Q2hpbGR9IHBhcmVudDogJHtwYXJlbnR9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuYXBwZW5kQ2hpbGQocGFyZW50LCBuZXdDaGlsZCk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBpbnNlcnRCZWZvcmUocGFyZW50OiBhbnksIG5ld0NoaWxkOiBhbnksIHJlZkNoaWxkOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmluc2VydEJlZm9yZSBjaGlsZDogJHtuZXdDaGlsZH0gYCArIGBwYXJlbnQ6ICR7cGFyZW50fSByZWZDaGlsZDogJHtyZWZDaGlsZH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5pbnNlcnRCZWZvcmUocGFyZW50LCBuZXdDaGlsZCwgcmVmQ2hpbGQpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgcmVtb3ZlQ2hpbGQocGFyZW50OiBhbnksIG9sZENoaWxkOiBhbnksIGlzSG9zdEVsZW1lbnQ/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVDaGlsZCBjaGlsZDogJHtvbGRDaGlsZH0gcGFyZW50OiAke3BhcmVudH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5yZW1vdmVDaGlsZChwYXJlbnQsIG9sZENoaWxkKTtcbiAgfVxuICBzZWxlY3RSb290RWxlbWVudChzZWxlY3Rvck9yTm9kZTogYW55LCBwcmVzZXJ2ZUNvbnRlbnQ/OiBib29sZWFuKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZWxlY3RSb290RWxlbWVudDogJHtzZWxlY3Rvck9yTm9kZX1gKTtcbiAgICB9XG4gICAgaWYgKHNlbGVjdG9yT3JOb2RlIGluc3RhbmNlb2YgVmlldykge1xuICAgICAgcmV0dXJuIHNlbGVjdG9yT3JOb2RlO1xuICAgIH1cbiAgICBpZiAoc2VsZWN0b3JPck5vZGUgJiYgc2VsZWN0b3JPck5vZGVbMF0gPT09ICcjJykge1xuICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0Vmlld0J5SWQodGhpcy5yb290Vmlldywgc2VsZWN0b3JPck5vZGUuc2xpY2UoMSkpO1xuICAgICAgcmV0dXJuIChyZXN1bHQgfHwgdGhpcy5yb290VmlldykgYXMgVmlldztcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBzZWxlY3Rvck9yTm9kZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdVdGlsLmNyZWF0ZVZpZXcoc2VsZWN0b3JPck5vZGUpO1xuICAgICAgaWYgKGdldEZpcnN0TmF0aXZlTGlrZVZpZXcodmlldykgPT09IHZpZXcpIHtcbiAgICAgICAgLy8gdmlldyBpcyBuYXRpdmVsaWtlIVxuICAgICAgICB0aGlzLmFwcGVuZENoaWxkKHRoaXMucm9vdFZpZXcsIHZpZXcpO1xuICAgICAgICByZXR1cm4gdmlldztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucm9vdFZpZXc7XG4gIH1cbiAgcGFyZW50Tm9kZShub2RlOiBOZ1ZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnBhcmVudE5vZGUgZm9yIG5vZGU6ICR7bm9kZX0gaXMgJHtub2RlLnBhcmVudE5vZGV9YCk7XG4gICAgfVxuICAgIHJldHVybiBub2RlLnBhcmVudE5vZGU7XG4gIH1cbiAgbmV4dFNpYmxpbmcobm9kZTogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5uZXh0U2libGluZyBvZiAke25vZGV9IGlzICR7bm9kZS5uZXh0U2libGluZ31gKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBzZXRBdHRyaWJ1dGUoZWw6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNldEF0dHJpYnV0ZSAke25hbWVzcGFjZSA/IG5hbWVzcGFjZSArICc6JyA6ICcnfSR7ZWx9LiR7bmFtZX0gPSAke3ZhbHVlfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnNldFByb3BlcnR5KGVsLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlKTtcbiAgfVxuICByZW1vdmVBdHRyaWJ1dGUoZWw6IGFueSwgbmFtZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZUF0dHJpYnV0ZSAke25hbWVzcGFjZSA/IG5hbWVzcGFjZSArICc6JyA6ICcnfSR7ZWx9LiR7bmFtZX1gKTtcbiAgICB9XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBhZGRDbGFzcyhlbDogYW55LCBuYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmFkZENsYXNzICR7bmFtZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5hZGRDbGFzcyhlbCwgbmFtZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICByZW1vdmVDbGFzcyhlbDogYW55LCBuYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZUNsYXNzICR7bmFtZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5yZW1vdmVDbGFzcyhlbCwgbmFtZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBzZXRTdHlsZShlbDogYW55LCBzdHlsZTogc3RyaW5nLCB2YWx1ZTogYW55LCBmbGFncz86IFJlbmRlcmVyU3R5bGVGbGFnczIpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNldFN0eWxlOiAke2VsfSwgJHtzdHlsZX0gPSAke3ZhbHVlfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnNldFN0eWxlKGVsLCBzdHlsZSwgdmFsdWUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgcmVtb3ZlU3R5bGUoZWw6IGFueSwgc3R5bGU6IHN0cmluZywgZmxhZ3M/OiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKCdOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVTdHlsZTogJHtzdHlsZU5hbWV9Jyk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlU3R5bGUoZWwsIHN0eWxlKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHNldFByb3BlcnR5KGVsOiBhbnksIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0UHJvcGVydHkgJHtlbH0uJHtuYW1lfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0UHJvcGVydHkoZWwsIG5hbWUsIHZhbHVlKTtcbiAgfVxuICBzZXRWYWx1ZShub2RlOiBhbnksIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNldFZhbHVlIHJlbmRlck5vZGU6ICR7bm9kZX0sIHZhbHVlOiAke3ZhbHVlfWApO1xuICAgIH1cbiAgICBpZiAobm9kZSBpbnN0YW5jZW9mIFRleHROb2RlKSB7XG4gICAgICBub2RlLnRleHQgPSB2YWx1ZTtcbiAgICB9XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbiAgbGlzdGVuKHRhcmdldDogVmlldywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXZlbnQ6IGFueSkgPT4gYm9vbGVhbiB8IHZvaWQpOiAoKSA9PiB2b2lkIHtcbiAgICAvLyB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmxpc3RlbjogJHtldmVudE5hbWV9YCk7XG4gICAgfVxuICAgIHRhcmdldC5vbihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICBpZiAoZXZlbnROYW1lID09PSBWaWV3LmxvYWRlZEV2ZW50ICYmIHRhcmdldC5pc0xvYWRlZCkge1xuICAgICAgLy8gd2UgbXVzdCBjcmVhdGUgYSBuZXcgb2JlcnZhYmxlIGhlcmUgdG8gZW5zdXJlIHRoYXQgdGhlIGV2ZW50IGdvZXMgdGhyb3VnaCB3aGF0ZXZlciB6b25lIHBhdGNoZXMgYXJlIGFwcGxpZWRcbiAgICAgIGNvbnN0IG9icyA9IG5ldyBPYnNlcnZhYmxlKCk7XG4gICAgICBvYnMub25jZShldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICAgIG9icy5ub3RpZnkoe1xuICAgICAgICBldmVudE5hbWUsXG4gICAgICAgIG9iamVjdDogdGFyZ2V0LFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB0YXJnZXQub2ZmKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICB9XG59XG5cbi8vIENPTlRFTlRfQVRUUiBub3QgZXhwb3J0ZWQgZnJvbSBuYXRpdmVzY3JpcHQtcmVuZGVyZXIgLSB3ZSBuZWVkIGl0IGZvciBzdHlsZXMgYXBwbGljYXRpb24uXG5jb25zdCBDT01QT05FTlRfUkVHRVggPSAvJUNPTVAlL2c7XG5jb25zdCBBVFRSX1NBTklUSVpFUiA9IC8tL2c7XG5leHBvcnQgY29uc3QgQ09NUE9ORU5UX1ZBUklBQkxFID0gJyVDT01QJSc7XG5leHBvcnQgY29uc3QgSE9TVF9BVFRSID0gYF9uZ2hvc3QtJHtDT01QT05FTlRfVkFSSUFCTEV9YDtcbmV4cG9ydCBjb25zdCBDT05URU5UX0FUVFIgPSBgX25nY29udGVudC0ke0NPTVBPTkVOVF9WQVJJQUJMRX1gO1xuXG5jb25zdCByZXBsYWNlTmdBdHRyaWJ1dGUgPSBmdW5jdGlvbiAoaW5wdXQ6IHN0cmluZywgY29tcG9uZW50SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnB1dC5yZXBsYWNlKENPTVBPTkVOVF9SRUdFWCwgY29tcG9uZW50SWQpO1xufTtcblxuY29uc3QgYWRkU2NvcGVkU3R5bGVUb0NzcyA9IHByb2ZpbGUoYFwicmVuZGVyZXJcIi5hZGRTY29wZWRTdHlsZVRvQ3NzYCwgZnVuY3Rpb24gYWRkU2NvcGVkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBudW1iZXIgfCBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBFbXVsYXRlZFJlbmRlcmVyIGV4dGVuZHMgTmF0aXZlU2NyaXB0UmVuZGVyZXIge1xuICBwcml2YXRlIGNvbnRlbnRBdHRyOiBzdHJpbmc7XG4gIHByaXZhdGUgaG9zdEF0dHI6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb21wb25lbnQ6IFJlbmRlcmVyVHlwZTIsIHJvb3RWaWV3OiBWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzOiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByb290TW9kdWxlSWQ6IHN0cmluZyB8IG51bWJlciwgcmV1c2VWaWV3czogYm9vbGVhbikge1xuICAgIHN1cGVyKHJvb3RWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzLCByZXVzZVZpZXdzKTtcblxuICAgIGNvbnN0IGNvbXBvbmVudElkID0gY29tcG9uZW50LmlkLnJlcGxhY2UoQVRUUl9TQU5JVElaRVIsICdfJyk7XG4gICAgdGhpcy5jb250ZW50QXR0ciA9IHJlcGxhY2VOZ0F0dHJpYnV0ZShDT05URU5UX0FUVFIsIGNvbXBvbmVudElkKTtcbiAgICB0aGlzLmhvc3RBdHRyID0gcmVwbGFjZU5nQXR0cmlidXRlKEhPU1RfQVRUUiwgY29tcG9uZW50SWQpO1xuICAgIHRoaXMuYWRkU3R5bGVzKGNvbXBvbmVudC5zdHlsZXMsIGNvbXBvbmVudElkKTtcbiAgfVxuXG4gIGFwcGx5VG9Ib3N0KHZpZXc6IE5nVmlldykge1xuICAgIHN1cGVyLnNldEF0dHJpYnV0ZSh2aWV3LCB0aGlzLmhvc3RBdHRyLCAnJyk7XG4gIH1cblxuICBhcHBlbmRDaGlsZChwYXJlbnQ6IGFueSwgbmV3Q2hpbGQ6IE5nVmlldyk6IHZvaWQge1xuICAgIHN1cGVyLmFwcGVuZENoaWxkKHBhcmVudCwgbmV3Q2hpbGQpO1xuICB9XG5cbiAgY3JlYXRlRWxlbWVudChwYXJlbnQ6IGFueSwgbmFtZTogc3RyaW5nKTogTmdWaWV3IHtcbiAgICBjb25zdCB2aWV3ID0gc3VwZXIuY3JlYXRlRWxlbWVudChwYXJlbnQsIG5hbWUpO1xuXG4gICAgLy8gU2V0IGFuIGF0dHJpYnV0ZSB0byB0aGUgdmlldyB0byBzY29wZSBjb21wb25lbnQtc3BlY2lmaWMgY3NzLlxuICAgIC8vIFRoZSBwcm9wZXJ0eSBuYW1lIGlzIHByZS1nZW5lcmF0ZWQgYnkgQW5ndWxhci5cbiAgICBzdXBlci5zZXRBdHRyaWJ1dGUodmlldywgdGhpcy5jb250ZW50QXR0ciwgJycpO1xuXG4gICAgcmV0dXJuIHZpZXc7XG4gIH1cblxuICBAcHJvZmlsZVxuICBwcml2YXRlIGFkZFN0eWxlcyhzdHlsZXM6IChzdHJpbmcgfCBhbnlbXSlbXSwgY29tcG9uZW50SWQ6IHN0cmluZykge1xuICAgIHN0eWxlc1xuICAgICAgLm1hcCgocykgPT4gcy50b1N0cmluZygpKVxuICAgICAgLm1hcCgocykgPT4gcmVwbGFjZU5nQXR0cmlidXRlKHMsIGNvbXBvbmVudElkKSlcbiAgICAgIC5mb3JFYWNoKChzKSA9PiBhZGRTY29wZWRTdHlsZVRvQ3NzKHMsIHRoaXMucm9vdE1vZHVsZUlkKSk7XG4gIH1cbn1cbiJdfQ==