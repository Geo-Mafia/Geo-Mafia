import { NgModuleRef, NgZone, PlatformRef } from '@angular/core';
import { filter, map, take } from 'rxjs/operators';
import { Application, Color, profile, removeTaggedAdditionalCSS, TextView, View, Utils } from '@nativescript/core';
import { AppHostView } from './app-host-view';
import { NativeScriptLoadingService } from './loading.service';
import { APP_ROOT_VIEW, DISABLE_ROOT_VIEW_HANDLING, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { Subject } from 'rxjs';
import { NativeScriptDebug } from './trace';
export function disableRootViewHanding(view) {
    view.__disable_root_view_handling = true;
}
export const preAngularDisposal$ = new Subject();
export const postAngularBootstrap$ = new Subject();
/**
 * @deprecated
 */
export const onBeforeLivesync = preAngularDisposal$.pipe(filter((v) => v.moduleType === 'main' && v.reason === 'hotreload'), map((v) => v.reference));
/**
 * @deprecated
 */
export const onAfterLivesync = postAngularBootstrap$.pipe(filter((v) => v.moduleType === 'main'), map((v) => ({ moduleRef: v.reference })));
if (import.meta['webpackHot']) {
    import.meta['webpackHot'].decline();
    global.__onLiveSyncCore = () => {
        Application.getRootView()?._onCssStateChange();
        // all other changes are applied by runNativeScriptAngularApp
    };
}
function emitModuleBootstrapEvent(ref, name, reason) {
    postAngularBootstrap$.next({
        moduleType: name,
        reference: ref,
        reason,
    });
}
function destroyRef(ref, name, reason) {
    if (ref) {
        if (ref instanceof PlatformRef) {
            preAngularDisposal$.next({
                moduleType: 'platform',
                reference: ref,
                reason: name,
            });
        }
        if (ref instanceof NgModuleRef) {
            preAngularDisposal$.next({
                moduleType: name,
                reference: ref,
                reason,
            });
        }
        ref.destroy();
    }
}
function runZoneSyncTask(fn) {
    if (typeof Zone === 'undefined') {
        return;
    }
    const zone = Zone.current;
    const task = zone.scheduleEventTask('sync_function', fn, {}, () => { }, () => { });
    try {
        // console.log(task.state);
        task.invoke();
        // zone.runTask(task);
        // console.log(task.state);
    }
    finally {
        zone.cancelTask(task);
    }
}
function ZoneCanWorkSync() {
    let canRunSync = false;
    runZoneSyncTask(() => {
        Promise.resolve().then(() => (canRunSync = true));
    });
    return canRunSync;
}
/**
 * Tests if global.__drainMicrotaskQueue can be used to drain microtasks
 * Because of Zone.js, even though the native queue might be drained, zone microtasks might not be
 * @param makeTestDrain should it drain the current microtask queue to ensure the queue can be drained
 * @returns if global.__drainMicrotaskQueue can be called
 */
function nativeQueueCanBeDrained(makeTestDrain) {
    if (typeof global.__drainMicrotaskQueue !== 'function') {
        return false;
    }
    if (!makeTestDrain) {
        return true;
    }
    let canRunSync = false;
    Promise.resolve().then(() => (canRunSync = true));
    global.__drainMicrotaskQueue();
    return canRunSync;
}
/**
 * Runs a function in the most synchronous way possible
 * @param fn function to run
 * @param done function to chain after done
 */
function runSynchronously(fn, done) {
    if (typeof Zone !== 'undefined' && ZoneCanWorkSync()) {
        runZoneSyncTask(fn);
        done?.();
        return;
    }
    if (nativeQueueCanBeDrained(true)) {
        fn();
        global.__drainMicrotaskQueue();
        done?.();
        return;
    }
    fn();
    if (done) {
        Utils.queueMacrotask(done);
    }
}
export function runNativeScriptAngularApp(options) {
    let mainModuleRef = null;
    let loadingModuleRef;
    let platformRef = null;
    let bootstrapId = -1;
    const updatePlatformRef = (moduleRef, reason) => {
        const newPlatformRef = moduleRef.injector.get(PlatformRef);
        if (newPlatformRef === platformRef) {
            return;
        }
        destroyRef(platformRef, reason);
        platformRef = newPlatformRef;
        platformRef.onDestroy(() => (platformRef = platformRef === newPlatformRef ? null : platformRef));
    };
    let launchEventDone = true;
    let targetRootView = null;
    const setRootView = (ref) => {
        if (bootstrapId === -1) {
            // treat edge cases
            return;
        }
        if (ref instanceof NgModuleRef) {
            if (ref.injector.get(DISABLE_ROOT_VIEW_HANDLING, false)) {
                return;
            }
        }
        else {
            if (ref['__disable_root_view_handling']) {
                return;
            }
        }
        Application.getRootView()?._closeAllModalViewsInternal(); // cleanup old rootview
        NativeScriptDebug.bootstrapLog(`Setting RootView ${launchEventDone ? 'outside of' : 'during'} launch event`);
        // TODO: check for leaks when root view isn't properly destroyed
        if (ref instanceof View) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLog(`Setting RootView to ${ref}`);
            }
            if (launchEventDone) {
                Application.resetRootView({
                    create: () => ref,
                });
            }
            else {
                targetRootView = ref;
            }
            return;
        }
        const view = ref.injector.get(APP_ROOT_VIEW);
        const newRoot = view instanceof AppHostView ? view.content : view;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.bootstrapLog(`Setting RootView to ${newRoot}`);
        }
        if (launchEventDone) {
            Application.resetRootView({
                create: () => newRoot,
            });
        }
        else {
            targetRootView = newRoot;
        }
    };
    const showErrorUI = (error) => {
        const message = error.message + '\n\n' + error.stack;
        const errorTextBox = new TextView();
        errorTextBox.text = message;
        errorTextBox.color = new Color('red');
        setRootView(errorTextBox);
    };
    const bootstrapRoot = (reason) => {
        try {
            bootstrapId = Date.now();
            const currentBootstrapId = bootstrapId;
            let bootstrapped = false;
            let onMainBootstrap = () => {
                setRootView(mainModuleRef);
            };
            runSynchronously(() => options.appModuleBootstrap(reason).then((ref) => {
                if (currentBootstrapId !== bootstrapId) {
                    // this module is old and not needed anymore
                    // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                    ref.destroy();
                    return;
                }
                mainModuleRef = ref;
                ref.onDestroy(() => (mainModuleRef = mainModuleRef === ref ? null : mainModuleRef));
                updatePlatformRef(ref, reason);
                const styleTag = ref.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
                ref.onDestroy(() => {
                    removeTaggedAdditionalCSS(styleTag);
                });
                bootstrapped = true;
                onMainBootstrap();
                emitModuleBootstrapEvent(ref, 'main', reason);
                // bootstrapped component: (ref as any)._bootstrapComponents[0];
            }, (err) => {
                bootstrapped = true;
                NativeScriptDebug.bootstrapLogError(`Error bootstrapping app module:\n${err.message}\n\n${err.stack}`);
                showErrorUI(err);
                throw err;
            }), () => {
                if (currentBootstrapId !== bootstrapId) {
                    return;
                }
                if (!bootstrapped) {
                    if (options.loadingModule) {
                        runSynchronously(() => options.loadingModule(reason).then((loadingRef) => {
                            if (currentBootstrapId !== bootstrapId) {
                                // this module is old and not needed anymore
                                // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                                loadingRef.destroy();
                                return;
                            }
                            loadingModuleRef = loadingRef;
                            loadingModuleRef.onDestroy(() => (loadingModuleRef = loadingModuleRef === loadingRef ? null : loadingModuleRef));
                            updatePlatformRef(loadingRef, reason);
                            const styleTag = loadingModuleRef.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
                            loadingRef.onDestroy(() => {
                                removeTaggedAdditionalCSS(styleTag);
                            });
                            setRootView(loadingRef);
                            onMainBootstrap = () => {
                                // delay showing the new rootview to avoid flashes
                                Utils.queueMacrotask(() => {
                                    const loadingService = loadingModuleRef.injector.get(NativeScriptLoadingService);
                                    loadingModuleRef.injector.get(NgZone).run(() => {
                                        loadingService._notifyMainModuleReady();
                                    });
                                    loadingService.readyToDestroy$
                                        .pipe(filter((ready) => ready), take(1))
                                        .subscribe(() => {
                                        destroyRef(loadingModuleRef, 'loading', reason);
                                        loadingModuleRef = null;
                                        setRootView(mainModuleRef);
                                    });
                                });
                            };
                            emitModuleBootstrapEvent(loadingModuleRef, 'loading', reason);
                        }, (err) => {
                            NativeScriptDebug.bootstrapLogError(`Error bootstrapping loading module:\n${err.message}\n\n${err.stack}`);
                            showErrorUI(err);
                            throw err;
                        }));
                    }
                    else if (options.launchView) {
                        let launchView = options.launchView(reason);
                        setRootView(launchView);
                        if (launchView.startAnimation) {
                            setTimeout(() => {
                                // ensure launch animation is executed after launchView added to view stack
                                launchView.startAnimation();
                            });
                        }
                        onMainBootstrap = () => {
                            // delay showing the new rootview to avoid flashes
                            Utils.queueMacrotask(() => {
                                if (launchView.cleanup) {
                                    launchView
                                        .cleanup()
                                        .catch()
                                        .then(() => {
                                        launchView = null;
                                        setRootView(mainModuleRef);
                                    });
                                }
                                else {
                                    launchView = null;
                                    setRootView(mainModuleRef);
                                }
                            });
                        };
                    }
                    else {
                        console.warn('App is bootstrapping asynchronously (likely APP_INITIALIZER) but did not provide a launchView or LoadingModule.');
                    }
                }
            });
        }
        catch (err) {
            NativeScriptDebug.bootstrapLogError(`Error in Bootstrap Function:\n${err.message}\n\n${err.stack}`);
        }
    };
    const disposePlatform = (reason) => {
        destroyRef(platformRef, reason);
        platformRef = null;
    };
    const disposeLastModules = (reason) => {
        // reset bootstrap ID to make sure any modules bootstrapped after this are discarded
        bootstrapId = -1;
        destroyRef(loadingModuleRef, 'loading', reason);
        loadingModuleRef = null;
        destroyRef(mainModuleRef, 'main', reason);
        mainModuleRef = null;
    };
    const launchCallback = profile('@nativescript/angular/platform-common.launchCallback', (args) => {
        launchEventDone = false;
        bootstrapRoot('applaunch');
        launchEventDone = true;
        args.root = targetRootView || null;
    });
    const exitCallback = profile('@nativescript/angular/platform-common.exitCallback', (args) => {
        disposeLastModules('appexit');
    });
    let oldAddEventListener;
    if (typeof Zone !== 'undefined' && global.NativeScriptGlobals?.events?.[Zone.__symbol__('addEventListener')]) {
        oldAddEventListener = global.NativeScriptGlobals.events.addEventListener;
        global.NativeScriptGlobals.events.addEventListener = global.NativeScriptGlobals.events[Zone.__symbol__('addEventListener')];
    }
    Application.on(Application.launchEvent, launchCallback);
    Application.on(Application.exitEvent, exitCallback);
    if (oldAddEventListener) {
        global.NativeScriptGlobals.events.addEventListener = oldAddEventListener;
    }
    if (import.meta['webpackHot']) {
        // handle HMR Application.run
        global['__dispose_app_ng_platform__'] = () => {
            disposePlatform('hotreload');
        };
        global['__dispose_app_ng_modules__'] = () => {
            disposeLastModules('hotreload');
        };
        global['__bootstrap_app_ng_modules__'] = () => {
            bootstrapRoot('hotreload');
        };
        global['__cleanup_ng_hot__'] = () => {
            Application.off(Application.launchEvent, launchCallback);
            Application.off(Application.exitEvent, exitCallback);
            disposeLastModules('hotreload');
            disposePlatform('hotreload');
        };
        global['__reboot_ng_modules__'] = (shouldDisposePlatform = false) => {
            disposeLastModules('hotreload');
            if (shouldDisposePlatform) {
                disposePlatform('hotreload');
            }
            bootstrapRoot('hotreload');
        };
        if (!Application.hasLaunched()) {
            Application.run();
            return;
        }
        bootstrapRoot('hotreload');
        return;
    }
    Application.run();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvYXBwbGljYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxXQUFXLEVBQXdCLEtBQUssRUFBK0IsT0FBTyxFQUFFLHlCQUF5QixFQUFlLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFTLE1BQU0sb0JBQW9CLENBQUM7QUFDMUwsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsMEJBQTBCLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEcsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFhNUMsTUFBTSxVQUFVLHNCQUFzQixDQUFDLElBQW1CO0lBQ3hELElBQUksQ0FBQyw0QkFBNEIsR0FBRyxJQUFJLENBQUM7QUFDM0MsQ0FBQztBQWdCRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBaUIsQ0FBQztBQUNoRSxNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLE9BQU8sRUFBaUIsQ0FBQztBQUVsRTs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFpQyxtQkFBbUIsQ0FBQyxJQUFJLENBQ3BGLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFF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QUNoQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyx3QkFBaUMsS0FBSyxFQUFFLEVBQUU7WUFDM0Usa0JBQWtCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDaEMsSUFBSSxxQkFBcUIsRUFBRTtnQkFDekIsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzlCO1lBQ0QsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQztRQUVGLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDOUIsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ2xCLE9BQU87U0FDUjtRQUNELGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMzQixPQUFPO0tBQ1I7SUFFRCxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5nTW9kdWxlUmVmLCBOZ1pvbmUsIFBsYXRmb3JtUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBBcHBsaWNhdGlvbkV2ZW50RGF0YSwgQ29sb3IsIExhdW5jaEV2ZW50RGF0YSwgTGF5b3V0QmFzZSwgcHJvZmlsZSwgcmVtb3ZlVGFnZ2VkQWRkaXRpb25hbENTUywgU3RhY2tMYXlvdXQsIFRleHRWaWV3LCBWaWV3LCBVdGlscywgVHJhY2UgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgQXBwSG9zdFZpZXcgfSBmcm9tICcuL2FwcC1ob3N0LXZpZXcnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0TG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuL2xvYWRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBBUFBfUk9PVF9WSUVXLCBESVNBQkxFX1JPT1RfVklFV19IQU5ETElORywgTkFUSVZFU0NSSVBUX1JPT1RfTU9EVUxFX0lEIH0gZnJvbSAnLi90b2tlbnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuL3RyYWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBBcHBMYXVuY2hWaWV3IGV4dGVuZHMgTGF5b3V0QmFzZSB7XG4gIC8vIGNhbGxlZCB3aGVuIHRoZSBhbmltYXRpb24gaXMgdG8gYmVnaW5cbiAgc3RhcnRBbmltYXRpb24/OiAoKSA9PiB2b2lkO1xuICAvLyBjYWxsZWQgd2hlbiBib290c3RyYXAgaXMgY29tcGxldGUgYW5kIGNsZWFudXAgY2FuIGJlZ2luXG4gIC8vIHNob3VsZCByZXNvbHZlIHdoZW4gYW5pbWF0aW9uIGlzIGNvbXBsZXRlbHkgZmluaXNoZWRcbiAgY2xlYW51cD86ICgpID0+IFByb21pc2U8YW55PjtcblxuICAvLyBkbyB5b3Ugd2FudCB0byBoYW5kbGUgc2V0dGluZyB0aGlzIGFzIGEgcm9vdHZpZXcgbWFudWFsbHk/XG4gIF9fZGlzYWJsZV9yb290X3ZpZXdfaGFuZGxpbmc/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzYWJsZVJvb3RWaWV3SGFuZGluZyh2aWV3OiBBcHBMYXVuY2hWaWV3KSB7XG4gIHZpZXcuX19kaXNhYmxlX3Jvb3Rfdmlld19oYW5kbGluZyA9IHRydWU7XG59XG5cbmV4cG9ydCB0eXBlIE5nTW9kdWxlUmVhc29uID0gJ2hvdHJlbG9hZCcgfCAnYXBwbGF1bmNoJyB8ICdhcHBleGl0JztcblxuZXhwb3J0IHR5cGUgTmdNb2R1bGVFdmVudCA9XG4gIHwge1xuICAgICAgbW9kdWxlVHlwZTogJ21haW4nIHwgJ2xvYWRpbmcnIHwgc3RyaW5nO1xuICAgICAgcmVmZXJlbmNlOiBOZ01vZHVsZVJlZjx1bmtub3duPjtcbiAgICAgIHJlYXNvbjogTmdNb2R1bGVSZWFzb24gfCBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIG1vZHVsZVR5cGU6ICdwbGF0Zm9ybSc7XG4gICAgICByZWZlcmVuY2U6IFBsYXRmb3JtUmVmO1xuICAgICAgcmVhc29uOiBOZ01vZHVsZVJlYXNvbiB8IHN0cmluZztcbiAgICB9O1xuXG5leHBvcnQgY29uc3QgcHJlQW5ndWxhckRpc3Bvc2FsJCA9IG5ldyBTdWJqZWN0PE5nTW9kdWxlRXZlbnQ+KCk7XG5leHBvcnQgY29uc3QgcG9zdEFuZ3VsYXJCb290c3RyYXAkID0gbmV3IFN1YmplY3Q8TmdNb2R1bGVFdmVudD4oKTtcblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgY29uc3Qgb25CZWZvcmVMaXZlc3luYzogT2JzZXJ2YWJsZTxOZ01vZHVsZVJlZjxhbnk+PiA9IHByZUFuZ3VsYXJEaXNwb3NhbCQucGlwZShcbiAgZmlsdGVyKCh2KSA9PiB2Lm1vZHVsZVR5cGUgPT09ICdtYWluJyAmJiB2LnJlYXNvbiA9PT0gJ2hvdHJlbG9hZCcpLFxuICBtYXAoKHYpID0+IHYucmVmZXJlbmNlIGFzIE5nTW9kdWxlUmVmPGFueT4pXG4pO1xuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgY29uc3Qgb25BZnRlckxpdmVzeW5jOiBPYnNlcnZhYmxlPHtcbiAgbW9kdWxlUmVmPzogTmdNb2R1bGVSZWY8YW55PjtcbiAgZXJyb3I/OiBFcnJvcjtcbn0+ID0gcG9zdEFuZ3VsYXJCb290c3RyYXAkLnBpcGUoXG4gIGZpbHRlcigodikgPT4gdi5tb2R1bGVUeXBlID09PSAnbWFpbicpLFxuICBtYXAoKHYpID0+ICh7IG1vZHVsZVJlZjogdi5yZWZlcmVuY2UgYXMgTmdNb2R1bGVSZWY8YW55PiB9KSlcbik7XG5leHBvcnQgaW50ZXJmYWNlIEFwcFJ1bk9wdGlvbnM8VCwgSz4ge1xuICBhcHBNb2R1bGVCb290c3RyYXA6IChyZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiBQcm9taXNlPE5nTW9kdWxlUmVmPFQ+PjtcbiAgbG9hZGluZ01vZHVsZT86IChyZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiBQcm9taXNlPE5nTW9kdWxlUmVmPEs+PjtcbiAgbGF1bmNoVmlldz86IChyZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiBBcHBMYXVuY2hWaWV3O1xufVxuXG5pZiAoaW1wb3J0Lm1ldGFbJ3dlYnBhY2tIb3QnXSkge1xuICBpbXBvcnQubWV0YVsnd2VicGFja0hvdCddLmRlY2xpbmUoKTtcbiAgZ2xvYmFsLl9fb25MaXZlU3luY0NvcmUgPSAoKSA9PiB7XG4gICAgQXBwbGljYXRpb24uZ2V0Um9vdFZpZXcoKT8uX29uQ3NzU3RhdGVDaGFuZ2UoKTtcbiAgICAvLyBhbGwgb3RoZXIgY2hhbmdlcyBhcmUgYXBwbGllZCBieSBydW5OYXRpdmVTY3JpcHRBbmd1bGFyQXBwXG4gIH07XG59XG5cbmZ1bmN0aW9uIGVtaXRNb2R1bGVCb290c3RyYXBFdmVudDxUPihyZWY6IE5nTW9kdWxlUmVmPFQ+LCBuYW1lOiAnbWFpbicgfCAnbG9hZGluZycsIHJlYXNvbjogTmdNb2R1bGVSZWFzb24pIHtcbiAgcG9zdEFuZ3VsYXJCb290c3RyYXAkLm5leHQoe1xuICAgIG1vZHVsZVR5cGU6IG5hbWUsXG4gICAgcmVmZXJlbmNlOiByZWYsXG4gICAgcmVhc29uLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZGVzdHJveVJlZjxUPihyZWY6IE5nTW9kdWxlUmVmPFQ+LCBuYW1lOiAnbWFpbicgfCAnbG9hZGluZycsIHJlYXNvbjogTmdNb2R1bGVSZWFzb24pOiB2b2lkO1xuZnVuY3Rpb24gZGVzdHJveVJlZihyZWY6IFBsYXRmb3JtUmVmLCByZWFzb246IE5nTW9kdWxlUmVhc29uKTogdm9pZDtcbmZ1bmN0aW9uIGRlc3Ryb3lSZWY8VD4ocmVmOiBQbGF0Zm9ybVJlZiB8IE5nTW9kdWxlUmVmPFQ+LCBuYW1lPzogc3RyaW5nLCByZWFzb24/OiBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHJlZikge1xuICAgIGlmIChyZWYgaW5zdGFuY2VvZiBQbGF0Zm9ybVJlZikge1xuICAgICAgcHJlQW5ndWxhckRpc3Bvc2FsJC5uZXh0KHtcbiAgICAgICAgbW9kdWxlVHlwZTogJ3BsYXRmb3JtJyxcbiAgICAgICAgcmVmZXJlbmNlOiByZWYsXG4gICAgICAgIHJlYXNvbjogbmFtZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAocmVmIGluc3RhbmNlb2YgTmdNb2R1bGVSZWYpIHtcbiAgICAgIHByZUFuZ3VsYXJEaXNwb3NhbCQubmV4dCh7XG4gICAgICAgIG1vZHVsZVR5cGU6IG5hbWUsXG4gICAgICAgIHJlZmVyZW5jZTogcmVmLFxuICAgICAgICByZWFzb24sXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmVmLmRlc3Ryb3koKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBydW5ab25lU3luY1Rhc2soZm46ICgpID0+IHZvaWQpIHtcbiAgaWYgKHR5cGVvZiBab25lID09PSAndW5kZWZpbmVkJykge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCB6b25lID0gWm9uZS5jdXJyZW50O1xuICBjb25zdCB0YXNrID0gem9uZS5zY2hlZHVsZUV2ZW50VGFzayhcbiAgICAnc3luY19mdW5jdGlvbicsXG4gICAgZm4sXG4gICAge30sXG4gICAgKCkgPT4ge30sXG4gICAgKCkgPT4ge31cbiAgKTtcbiAgdHJ5IHtcbiAgICAvLyBjb25zb2xlLmxvZyh0YXNrLnN0YXRlKTtcbiAgICB0YXNrLmludm9rZSgpO1xuICAgIC8vIHpvbmUucnVuVGFzayh0YXNrKTtcbiAgICAvLyBjb25zb2xlLmxvZyh0YXNrLnN0YXRlKTtcbiAgfSBmaW5hbGx5IHtcbiAgICB6b25lLmNhbmNlbFRhc2sodGFzayk7XG4gIH1cbn1cblxuZnVuY3Rpb24gWm9uZUNhbldvcmtTeW5jKCkge1xuICBsZXQgY2FuUnVuU3luYyA9IGZhbHNlO1xuICBydW5ab25lU3luY1Rhc2soKCkgPT4ge1xuICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGNhblJ1blN5bmMgPSB0cnVlKSk7XG4gIH0pO1xuICByZXR1cm4gY2FuUnVuU3luYztcbn1cblxuLyoqXG4gKiBUZXN0cyBpZiBnbG9iYWwuX19kcmFpbk1pY3JvdGFza1F1ZXVlIGNhbiBiZSB1c2VkIHRvIGRyYWluIG1pY3JvdGFza3NcbiAqIEJlY2F1c2Ugb2YgWm9uZS5qcywgZXZlbiB0aG91Z2ggdGhlIG5hdGl2ZSBxdWV1ZSBtaWdodCBiZSBkcmFpbmVkLCB6b25lIG1pY3JvdGFza3MgbWlnaHQgbm90IGJlXG4gKiBAcGFyYW0gbWFrZVRlc3REcmFpbiBzaG91bGQgaXQgZHJhaW4gdGhlIGN1cnJlbnQgbWljcm90YXNrIHF1ZXVlIHRvIGVuc3VyZSB0aGUgcXVldWUgY2FuIGJlIGRyYWluZWRcbiAqIEByZXR1cm5zIGlmIGdsb2JhbC5fX2RyYWluTWljcm90YXNrUXVldWUgY2FuIGJlIGNhbGxlZFxuICovXG5mdW5jdGlvbiBuYXRpdmVRdWV1ZUNhbkJlRHJhaW5lZChtYWtlVGVzdERyYWluOiBib29sZWFuKSB7XG4gIGlmICh0eXBlb2YgKGdsb2JhbCBhcyBhbnkpLl9fZHJhaW5NaWNyb3Rhc2tRdWV1ZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBpZiAoIW1ha2VUZXN0RHJhaW4pIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBsZXQgY2FuUnVuU3luYyA9IGZhbHNlO1xuICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChjYW5SdW5TeW5jID0gdHJ1ZSkpO1xuICAoZ2xvYmFsIGFzIGFueSkuX19kcmFpbk1pY3JvdGFza1F1ZXVlKCk7XG4gIHJldHVybiBjYW5SdW5TeW5jO1xufVxuXG4vKipcbiAqIFJ1bnMgYSBmdW5jdGlvbiBpbiB0aGUgbW9zdCBzeW5jaHJvbm91cyB3YXkgcG9zc2libGVcbiAqIEBwYXJhbSBmbiBmdW5jdGlvbiB0byBydW5cbiAqIEBwYXJhbSBkb25lIGZ1bmN0aW9uIHRvIGNoYWluIGFmdGVyIGRvbmVcbiAqL1xuZnVuY3Rpb24gcnVuU3luY2hyb25vdXNseShmbjogKCkgPT4gdm9pZCwgZG9uZT86ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgaWYgKHR5cGVvZiBab25lICE9PSAndW5kZWZpbmVkJyAmJiBab25lQ2FuV29ya1N5bmMoKSkge1xuICAgIHJ1blpvbmVTeW5jVGFzayhmbik7XG4gICAgZG9uZT8uKCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChuYXRpdmVRdWV1ZUNhbkJlRHJhaW5lZCh0cnVlKSkge1xuICAgIGZuKCk7XG4gICAgKGdsb2JhbCBhcyBhbnkpLl9fZHJhaW5NaWNyb3Rhc2tRdWV1ZSgpO1xuICAgIGRvbmU/LigpO1xuICAgIHJldHVybjtcbiAgfVxuICBmbigpO1xuICBpZiAoZG9uZSkge1xuICAgIFV0aWxzLnF1ZXVlTWFjcm90YXNrKGRvbmUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBydW5OYXRpdmVTY3JpcHRBbmd1bGFyQXBwPFQsIEs+KG9wdGlvbnM6IEFwcFJ1bk9wdGlvbnM8VCwgSz4pIHtcbiAgbGV0IG1haW5Nb2R1bGVSZWY6IE5nTW9kdWxlUmVmPFQ+ID0gbnVsbDtcbiAgbGV0IGxvYWRpbmdNb2R1bGVSZWY6IE5nTW9kdWxlUmVmPEs+O1xuICBsZXQgcGxhdGZvcm1SZWY6IFBsYXRmb3JtUmVmID0gbnVsbDtcbiAgbGV0IGJvb3RzdHJhcElkID0gLTE7XG4gIGNvbnN0IHVwZGF0ZVBsYXRmb3JtUmVmID0gKG1vZHVsZVJlZjogTmdNb2R1bGVSZWY8VCB8IEs+LCByZWFzb246IE5nTW9kdWxlUmVhc29uKSA9PiB7XG4gICAgY29uc3QgbmV3UGxhdGZvcm1SZWYgPSBtb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KFBsYXRmb3JtUmVmKTtcbiAgICBpZiAobmV3UGxhdGZvcm1SZWYgPT09IHBsYXRmb3JtUmVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlc3Ryb3lSZWYocGxhdGZvcm1SZWYsIHJlYXNvbik7XG4gICAgcGxhdGZvcm1SZWYgPSBuZXdQbGF0Zm9ybVJlZjtcbiAgICBwbGF0Zm9ybVJlZi5vbkRlc3Ryb3koKCkgPT4gKHBsYXRmb3JtUmVmID0gcGxhdGZvcm1SZWYgPT09IG5ld1BsYXRmb3JtUmVmID8gbnVsbCA6IHBsYXRmb3JtUmVmKSk7XG4gIH07XG4gIGxldCBsYXVuY2hFdmVudERvbmUgPSB0cnVlO1xuICBsZXQgdGFyZ2V0Um9vdFZpZXc6IFZpZXcgPSBudWxsO1xuICBjb25zdCBzZXRSb290VmlldyA9IChyZWY6IE5nTW9kdWxlUmVmPFQgfCBLPiB8IFZpZXcpID0+IHtcbiAgICBpZiAoYm9vdHN0cmFwSWQgPT09IC0xKSB7XG4gICAgICAvLyB0cmVhdCBlZGdlIGNhc2VzXG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChyZWYgaW5zdGFuY2VvZiBOZ01vZHVsZVJlZikge1xuICAgICAgaWYgKHJlZi5pbmplY3Rvci5nZXQoRElTQUJMRV9ST09UX1ZJRVdfSEFORExJTkcsIGZhbHNlKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZWZbJ19fZGlzYWJsZV9yb290X3ZpZXdfaGFuZGxpbmcnXSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCk/Ll9jbG9zZUFsbE1vZGFsVmlld3NJbnRlcm5hbCgpOyAvLyBjbGVhbnVwIG9sZCByb290dmlld1xuICAgIE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZyhgU2V0dGluZyBSb290VmlldyAke2xhdW5jaEV2ZW50RG9uZSA/ICdvdXRzaWRlIG9mJyA6ICdkdXJpbmcnfSBsYXVuY2ggZXZlbnRgKTtcbiAgICAvLyBUT0RPOiBjaGVjayBmb3IgbGVha3Mgd2hlbiByb290IHZpZXcgaXNuJ3QgcHJvcGVybHkgZGVzdHJveWVkXG4gICAgaWYgKHJlZiBpbnN0YW5jZW9mIFZpZXcpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2coYFNldHRpbmcgUm9vdFZpZXcgdG8gJHtyZWZ9YCk7XG4gICAgICB9XG4gICAgICBpZiAobGF1bmNoRXZlbnREb25lKSB7XG4gICAgICAgIEFwcGxpY2F0aW9uLnJlc2V0Um9vdFZpZXcoe1xuICAgICAgICAgIGNyZWF0ZTogKCkgPT4gcmVmLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRhcmdldFJvb3RWaWV3ID0gcmVmO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB2aWV3ID0gcmVmLmluamVjdG9yLmdldChBUFBfUk9PVF9WSUVXKSBhcyBBcHBIb3N0VmlldyB8IFZpZXc7XG4gICAgY29uc3QgbmV3Um9vdCA9IHZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0VmlldyA/IHZpZXcuY29udGVudCA6IHZpZXc7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2coYFNldHRpbmcgUm9vdFZpZXcgdG8gJHtuZXdSb290fWApO1xuICAgIH1cbiAgICBpZiAobGF1bmNoRXZlbnREb25lKSB7XG4gICAgICBBcHBsaWNhdGlvbi5yZXNldFJvb3RWaWV3KHtcbiAgICAgICAgY3JlYXRlOiAoKSA9PiBuZXdSb290LFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldFJvb3RWaWV3ID0gbmV3Um9vdDtcbiAgICB9XG4gIH07XG4gIGNvbnN0IHNob3dFcnJvclVJID0gKGVycm9yOiBFcnJvcikgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlICsgJ1xcblxcbicgKyBlcnJvci5zdGFjaztcbiAgICBjb25zdCBlcnJvclRleHRCb3ggPSBuZXcgVGV4dFZpZXcoKTtcbiAgICBlcnJvclRleHRCb3gudGV4dCA9IG1lc3NhZ2U7XG4gICAgZXJyb3JUZXh0Qm94LmNvbG9yID0gbmV3IENvbG9yKCdyZWQnKTtcbiAgICBzZXRSb290VmlldyhlcnJvclRleHRCb3gpO1xuICB9O1xuICBjb25zdCBib290c3RyYXBSb290ID0gKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICB0cnkge1xuICAgICAgYm9vdHN0cmFwSWQgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgY3VycmVudEJvb3RzdHJhcElkID0gYm9vdHN0cmFwSWQ7XG4gICAgICBsZXQgYm9vdHN0cmFwcGVkID0gZmFsc2U7XG4gICAgICBsZXQgb25NYWluQm9vdHN0cmFwID0gKCkgPT4ge1xuICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgIH07XG4gICAgICBydW5TeW5jaHJvbm91c2x5KFxuICAgICAgICAoKSA9PlxuICAgICAgICAgIG9wdGlvbnMuYXBwTW9kdWxlQm9vdHN0cmFwKHJlYXNvbikudGhlbihcbiAgICAgICAgICAgIChyZWYpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGlzIG1vZHVsZSBpcyBvbGQgYW5kIG5vdCBuZWVkZWQgYW55bW9yZVxuICAgICAgICAgICAgICAgIC8vIHRoaXMgbWF5IGhhcHBlbiB3aGVuIGRldmVsb3BlciB1c2VzIGFzeW5jIGFwcCBpbml0aWFsaXplciBhbmQgdGhlIHVzZXIgZXhpdHMgdGhlIGFwcCBiZWZvcmUgdGhpcyBib290c3RyYXBzXG4gICAgICAgICAgICAgICAgcmVmLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbWFpbk1vZHVsZVJlZiA9IHJlZjtcbiAgICAgICAgICAgICAgcmVmLm9uRGVzdHJveSgoKSA9PiAobWFpbk1vZHVsZVJlZiA9IG1haW5Nb2R1bGVSZWYgPT09IHJlZiA/IG51bGwgOiBtYWluTW9kdWxlUmVmKSk7XG4gICAgICAgICAgICAgIHVwZGF0ZVBsYXRmb3JtUmVmKHJlZiwgcmVhc29uKTtcbiAgICAgICAgICAgICAgY29uc3Qgc3R5bGVUYWcgPSByZWYuaW5qZWN0b3IuZ2V0KE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCk7XG4gICAgICAgICAgICAgIHJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlbW92ZVRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGVUYWcpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgYm9vdHN0cmFwcGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgb25NYWluQm9vdHN0cmFwKCk7XG4gICAgICAgICAgICAgIGVtaXRNb2R1bGVCb290c3RyYXBFdmVudChyZWYsICdtYWluJywgcmVhc29uKTtcbiAgICAgICAgICAgICAgLy8gYm9vdHN0cmFwcGVkIGNvbXBvbmVudDogKHJlZiBhcyBhbnkpLl9ib290c3RyYXBDb21wb25lbnRzWzBdO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgYm9vdHN0cmFwcGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nRXJyb3IoYEVycm9yIGJvb3RzdHJhcHBpbmcgYXBwIG1vZHVsZTpcXG4ke2Vyci5tZXNzYWdlfVxcblxcbiR7ZXJyLnN0YWNrfWApO1xuICAgICAgICAgICAgICBzaG93RXJyb3JVSShlcnIpO1xuICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKSxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGlmIChjdXJyZW50Qm9vdHN0cmFwSWQgIT09IGJvb3RzdHJhcElkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghYm9vdHN0cmFwcGVkKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5sb2FkaW5nTW9kdWxlKSB7XG4gICAgICAgICAgICAgIHJ1blN5bmNocm9ub3VzbHkoKCkgPT5cbiAgICAgICAgICAgICAgICBvcHRpb25zLmxvYWRpbmdNb2R1bGUocmVhc29uKS50aGVuKFxuICAgICAgICAgICAgICAgICAgKGxvYWRpbmdSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIG1vZHVsZSBpcyBvbGQgYW5kIG5vdCBuZWVkZWQgYW55bW9yZVxuICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgbWF5IGhhcHBlbiB3aGVuIGRldmVsb3BlciB1c2VzIGFzeW5jIGFwcCBpbml0aWFsaXplciBhbmQgdGhlIHVzZXIgZXhpdHMgdGhlIGFwcCBiZWZvcmUgdGhpcyBib290c3RyYXBzXG4gICAgICAgICAgICAgICAgICAgICAgbG9hZGluZ1JlZi5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdNb2R1bGVSZWYgPSBsb2FkaW5nUmVmO1xuICAgICAgICAgICAgICAgICAgICBsb2FkaW5nTW9kdWxlUmVmLm9uRGVzdHJveSgoKSA9PiAobG9hZGluZ01vZHVsZVJlZiA9IGxvYWRpbmdNb2R1bGVSZWYgPT09IGxvYWRpbmdSZWYgPyBudWxsIDogbG9hZGluZ01vZHVsZVJlZikpO1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVQbGF0Zm9ybVJlZihsb2FkaW5nUmVmLCByZWFzb24pO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHlsZVRhZyA9IGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCk7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdSZWYub25EZXN0cm95KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICByZW1vdmVUYWdnZWRBZGRpdGlvbmFsQ1NTKHN0eWxlVGFnKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KGxvYWRpbmdSZWYpO1xuICAgICAgICAgICAgICAgICAgICBvbk1haW5Cb290c3RyYXAgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgLy8gZGVsYXkgc2hvd2luZyB0aGUgbmV3IHJvb3R2aWV3IHRvIGF2b2lkIGZsYXNoZXNcbiAgICAgICAgICAgICAgICAgICAgICBVdGlscy5xdWV1ZU1hY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2FkaW5nU2VydmljZSA9IGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5hdGl2ZVNjcmlwdExvYWRpbmdTZXJ2aWNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5nWm9uZSkucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZ1NlcnZpY2UuX25vdGlmeU1haW5Nb2R1bGVSZWFkeSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nU2VydmljZS5yZWFkeVRvRGVzdHJveSRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChyZWFkeSkgPT4gcmVhZHkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0cm95UmVmKGxvYWRpbmdNb2R1bGVSZWYsICdsb2FkaW5nJywgcmVhc29uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nTW9kdWxlUmVmID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGVtaXRNb2R1bGVCb290c3RyYXBFdmVudChsb2FkaW5nTW9kdWxlUmVmLCAnbG9hZGluZycsIHJlYXNvbik7XG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcihgRXJyb3IgYm9vdHN0cmFwcGluZyBsb2FkaW5nIG1vZHVsZTpcXG4ke2Vyci5tZXNzYWdlfVxcblxcbiR7ZXJyLnN0YWNrfWApO1xuICAgICAgICAgICAgICAgICAgICBzaG93RXJyb3JVSShlcnIpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmxhdW5jaFZpZXcpIHtcbiAgICAgICAgICAgICAgbGV0IGxhdW5jaFZpZXcgPSBvcHRpb25zLmxhdW5jaFZpZXcocmVhc29uKTtcbiAgICAgICAgICAgICAgc2V0Um9vdFZpZXcobGF1bmNoVmlldyk7XG4gICAgICAgICAgICAgIGlmIChsYXVuY2hWaWV3LnN0YXJ0QW5pbWF0aW9uKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAvLyBlbnN1cmUgbGF1bmNoIGFuaW1hdGlvbiBpcyBleGVjdXRlZCBhZnRlciBsYXVuY2hWaWV3IGFkZGVkIHRvIHZpZXcgc3RhY2tcbiAgICAgICAgICAgICAgICAgIGxhdW5jaFZpZXcuc3RhcnRBbmltYXRpb24oKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBvbk1haW5Cb290c3RyYXAgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gZGVsYXkgc2hvd2luZyB0aGUgbmV3IHJvb3R2aWV3IHRvIGF2b2lkIGZsYXNoZXNcbiAgICAgICAgICAgICAgICBVdGlscy5xdWV1ZU1hY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAobGF1bmNoVmlldy5jbGVhbnVwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhdW5jaFZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAuY2xlYW51cCgpXG4gICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKClcbiAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXVuY2hWaWV3ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KG1haW5Nb2R1bGVSZWYpO1xuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGF1bmNoVmlldyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHNldFJvb3RWaWV3KG1haW5Nb2R1bGVSZWYpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdBcHAgaXMgYm9vdHN0cmFwcGluZyBhc3luY2hyb25vdXNseSAobGlrZWx5IEFQUF9JTklUSUFMSVpFUikgYnV0IGRpZCBub3QgcHJvdmlkZSBhIGxhdW5jaFZpZXcgb3IgTG9hZGluZ01vZHVsZS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2dFcnJvcihgRXJyb3IgaW4gQm9vdHN0cmFwIEZ1bmN0aW9uOlxcbiR7ZXJyLm1lc3NhZ2V9XFxuXFxuJHtlcnIuc3RhY2t9YCk7XG4gICAgfVxuICB9O1xuICBjb25zdCBkaXNwb3NlUGxhdGZvcm0gPSAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4ge1xuICAgIGRlc3Ryb3lSZWYocGxhdGZvcm1SZWYsIHJlYXNvbik7XG4gICAgcGxhdGZvcm1SZWYgPSBudWxsO1xuICB9O1xuICBjb25zdCBkaXNwb3NlTGFzdE1vZHVsZXMgPSAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4ge1xuICAgIC8vIHJlc2V0IGJvb3RzdHJhcCBJRCB0byBtYWtlIHN1cmUgYW55IG1vZHVsZXMgYm9vdHN0cmFwcGVkIGFmdGVyIHRoaXMgYXJlIGRpc2NhcmRlZFxuICAgIGJvb3RzdHJhcElkID0gLTE7XG4gICAgZGVzdHJveVJlZihsb2FkaW5nTW9kdWxlUmVmLCAnbG9hZGluZycsIHJlYXNvbik7XG4gICAgbG9hZGluZ01vZHVsZVJlZiA9IG51bGw7XG4gICAgZGVzdHJveVJlZihtYWluTW9kdWxlUmVmLCAnbWFpbicsIHJlYXNvbik7XG4gICAgbWFpbk1vZHVsZVJlZiA9IG51bGw7XG4gIH07XG4gIGNvbnN0IGxhdW5jaENhbGxiYWNrID0gcHJvZmlsZSgnQG5hdGl2ZXNjcmlwdC9hbmd1bGFyL3BsYXRmb3JtLWNvbW1vbi5sYXVuY2hDYWxsYmFjaycsIChhcmdzOiBMYXVuY2hFdmVudERhdGEpID0+IHtcbiAgICBsYXVuY2hFdmVudERvbmUgPSBmYWxzZTtcbiAgICBib290c3RyYXBSb290KCdhcHBsYXVuY2gnKTtcbiAgICBsYXVuY2hFdmVudERvbmUgPSB0cnVlO1xuICAgIGFyZ3Mucm9vdCA9IHRhcmdldFJvb3RWaWV3IHx8IG51bGw7XG4gIH0pO1xuICBjb25zdCBleGl0Q2FsbGJhY2sgPSBwcm9maWxlKCdAbmF0aXZlc2NyaXB0L2FuZ3VsYXIvcGxhdGZvcm0tY29tbW9uLmV4aXRDYWxsYmFjaycsIChhcmdzOiBBcHBsaWNhdGlvbkV2ZW50RGF0YSkgPT4ge1xuICAgIGRpc3Bvc2VMYXN0TW9kdWxlcygnYXBwZXhpdCcpO1xuICB9KTtcblxuICBsZXQgb2xkQWRkRXZlbnRMaXN0ZW5lcjtcbiAgaWYgKHR5cGVvZiBab25lICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwuTmF0aXZlU2NyaXB0R2xvYmFscz8uZXZlbnRzPy5bWm9uZS5fX3N5bWJvbF9fKCdhZGRFdmVudExpc3RlbmVyJyldKSB7XG4gICAgb2xkQWRkRXZlbnRMaXN0ZW5lciA9IGdsb2JhbC5OYXRpdmVTY3JpcHRHbG9iYWxzLmV2ZW50cy5hZGRFdmVudExpc3RlbmVyO1xuICAgIGdsb2JhbC5OYXRpdmVTY3JpcHRHbG9iYWxzLmV2ZW50cy5hZGRFdmVudExpc3RlbmVyID0gZ2xvYmFsLk5hdGl2ZVNjcmlwdEdsb2JhbHMuZXZlbnRzW1pvbmUuX19zeW1ib2xfXygnYWRkRXZlbnRMaXN0ZW5lcicpXTtcbiAgfVxuICBBcHBsaWNhdGlvbi5vbihBcHBsaWNhdGlvbi5sYXVuY2hFdmVudCwgbGF1bmNoQ2FsbGJhY2spO1xuICBBcHBsaWNhdGlvbi5vbihBcHBsaWNhdGlvbi5leGl0RXZlbnQsIGV4aXRDYWxsYmFjayk7XG4gIGlmIChvbGRBZGRFdmVudExpc3RlbmVyKSB7XG4gICAgZ2xvYmFsLk5hdGl2ZVNjcmlwdEdsb2JhbHMuZXZlbnRzLmFkZEV2ZW50TGlzdGVuZXIgPSBvbGRBZGRFdmVudExpc3RlbmVyO1xuICB9XG4gIGlmIChpbXBvcnQubWV0YVsnd2VicGFja0hvdCddKSB7XG4gICAgLy8gaGFuZGxlIEhNUiBBcHBsaWNhdGlvbi5ydW5cbiAgICBnbG9iYWxbJ19fZGlzcG9zZV9hcHBfbmdfcGxhdGZvcm1fXyddID0gKCkgPT4ge1xuICAgICAgZGlzcG9zZVBsYXRmb3JtKCdob3RyZWxvYWQnKTtcbiAgICB9O1xuICAgIGdsb2JhbFsnX19kaXNwb3NlX2FwcF9uZ19tb2R1bGVzX18nXSA9ICgpID0+IHtcbiAgICAgIGRpc3Bvc2VMYXN0TW9kdWxlcygnaG90cmVsb2FkJyk7XG4gICAgfTtcbiAgICBnbG9iYWxbJ19fYm9vdHN0cmFwX2FwcF9uZ19tb2R1bGVzX18nXSA9ICgpID0+IHtcbiAgICAgIGJvb3RzdHJhcFJvb3QoJ2hvdHJlbG9hZCcpO1xuICAgIH07XG4gICAgZ2xvYmFsWydfX2NsZWFudXBfbmdfaG90X18nXSA9ICgpID0+IHtcbiAgICAgIEFwcGxpY2F0aW9uLm9mZihBcHBsaWNhdGlvbi5sYXVuY2hFdmVudCwgbGF1bmNoQ2FsbGJhY2spO1xuICAgICAgQXBwbGljYXRpb24ub2ZmKEFwcGxpY2F0aW9uLmV4aXRFdmVudCwgZXhpdENhbGxiYWNrKTtcbiAgICAgIGRpc3Bvc2VMYXN0TW9kdWxlcygnaG90cmVsb2FkJyk7XG4gICAgICBkaXNwb3NlUGxhdGZvcm0oJ2hvdHJlbG9hZCcpO1xuICAgIH07XG4gICAgZ2xvYmFsWydfX3JlYm9vdF9uZ19tb2R1bGVzX18nXSA9IChzaG91bGREaXNwb3NlUGxhdGZvcm06IGJvb2xlYW4gPSBmYWxzZSkgPT4ge1xuICAgICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdob3RyZWxvYWQnKTtcbiAgICAgIGlmIChzaG91bGREaXNwb3NlUGxhdGZvcm0pIHtcbiAgICAgICAgZGlzcG9zZVBsYXRmb3JtKCdob3RyZWxvYWQnKTtcbiAgICAgIH1cbiAgICAgIGJvb3RzdHJhcFJvb3QoJ2hvdHJlbG9hZCcpO1xuICAgIH07XG5cbiAgICBpZiAoIUFwcGxpY2F0aW9uLmhhc0xhdW5jaGVkKCkpIHtcbiAgICAgIEFwcGxpY2F0aW9uLnJ1bigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBib290c3RyYXBSb290KCdob3RyZWxvYWQnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBBcHBsaWNhdGlvbi5ydW4oKTtcbn1cbiJdfQ==